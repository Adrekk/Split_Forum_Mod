<?xml version="1.0"?>
<!DOCTYPE modification SYSTEM "http://www.simplemachines.org/xml/modification">
<modification xmlns="http://www.simplemachines.org/xml/modification" xmlns:smf="http://www.simplemachines.org/">
<id>Dougiefresh:Split_Forum</id>
<version>2.0 Beta 3</version>

<!---------------------------------------------------------------------------->
<!-- Source File Edits														-->
<!---------------------------------------------------------------------------->
<file name="$boarddir/index.php">
	<operation>
		<search position="after"><![CDATA[// Check if the user should be disallowed access.]]></search>
		<add><![CDATA[// Make sure that the user has access to this subforum:
	SplitForum_DenyAccess();

	]]></add>
	</operation>
</file>
<file name="$sourcedir/Display.php">
	<!-- Display function -->
	<operation>	<!-- line 63 -->
		<search position="before"><![CDATA[function Display()
{
	global $scripturl, $txt, $modSettings, $context, $settings]]></search>
		<add><![CDATA[, $forumid]]></add>
	</operation>
	<operation>	<!-- line 396 -->
		<search position="replace"><![CDATA[mg.online_color, mg.id_group, mg.group_name]]></search>
		<add><![CDATA[mg.online_color, COALESCE(pm.id_group, 0) AS id_group, mg.group_name]]></add>
	</operation>
	<operation>	<!-- line 399 -->
		<search position="replace"><![CDATA[LEFT JOIN {db_prefix}membergroups AS mg ON (mg.id_group = CASE WHEN mem.id_group = {int:reg_id_group} THEN mem.id_post_group ELSE mem.id_group END)]]></search>
		<add><![CDATA[LEFT JOIN {db_prefix}primary_membergroups AS pm ON (pm.id_member = mem.id_member AND pm.forumid = {int:forumid})
				LEFT JOIN {db_prefix}membergroups AS mg ON (mg.id_group = CASE WHEN pm.id_group = {int:reg_id_group} THEN mem.id_post_group ELSE pm.id_group END)]]></add>
	</operation>
	<operation>	<!-- line 404 -->
		<search position="before"><![CDATA['session' => $user_info['is_guest'] ? 'ip' . $user_info['ip'] : session_id(),]]></search>
		<add><![CDATA[
				'forumid' => (int) $forumid,]]></add>
	</operation>
	<operation>	<!-- line 565 -->
		<search position="before"><![CDATA[WHERE cal.id_topic = {int:current_topic}]]></search>
		<add><![CDATA[
				AND cal.forumid = {int:forumid}]]></add>
	</operation>
	<operation>	<!-- line 566 -->
		<search position="before"><![CDATA[ORDER BY start_date',
			array(
				'current_topic' => $topic,]]></search>
		<add><![CDATA[
				'forumid' => (int) $forumid,]]></add>
	</operation>
</file>
<file name="$sourcedir/Groups.php">
	<!-- GroupList function -->
	<operation>	<!-- line 94 -->
		<search position="before"><![CDATA[global $txt, $scripturl, $user_profile, $user_info, $context, $settings, $modSettings, $smcFunc, $sourcedir]]></search>
		<add><![CDATA[, $forumid]]></add>
	</operation>
	<operation>	<!-- line 96 -->
		<search position="replace"><![CDATA[// Yep, find the groups...
	$request = $smcFunc['db_query']('', '
		SELECT mg.id_group, mg.group_name, mg.description, mg.group_type, mg.online_color, mg.hidden,
			mg.stars, IFNULL(gm.id_member, 0) AS can_moderate
		FROM {db_prefix}membergroups AS mg
			LEFT JOIN {db_prefix}group_moderators AS gm ON (gm.id_group = mg.id_group AND gm.id_member = {int:current_member})
		WHERE mg.min_posts = {int:min_posts}
			AND mg.id_group != {int:mod_group}' . (allowedTo('admin_forum') ? '' : '
			AND mg.group_type != {int:is_protected}') . '
		ORDER BY group_name',
		array(]]></search>
		<add><![CDATA[// Yep, find the groups...
	$request = $smcFunc['db_query']('', '
		SELECT mg.id_group, mg.group_name, mg.description, mg.group_type, mg.online_color, mg.hidden,
			mg.stars, IFNULL(gm.id_member, 0) AS can_moderate
		FROM {db_prefix}membergroups AS mg
			LEFT JOIN {db_prefix}group_moderators AS gm ON (gm.id_group = mg.id_group AND gm.id_member = {int:current_member})
		WHERE mg.min_posts = {int:min_posts}
			AND mg.id_group != {int:mod_group}
			AND (mg.forumid = {int:global_forumid} OR mg.forumid = {int:forumid})' . (allowedTo('admin_forum') ? '' : '
			AND mg.group_type != {int:is_protected}') . '
		ORDER BY group_name',
		array(
			'global_forumid' => -1,
			'forumid' => (int) $forumid,]]></add>
	</operation>
	<operation>	<!-- line 140 -->
		<search position="replace"><![CDATA[// Count up the members separately...
	if (!empty($group_ids))
	{
		$query = $smcFunc['db_query']('', '
			SELECT id_group, COUNT(*) AS num_members
			FROM {db_prefix}members
			WHERE id_group IN ({array_int:group_list})
			GROUP BY id_group',
			array(]]></search>
		<add><![CDATA[// Count up the members separately...
	if (!empty($group_ids))
	{
		$query = $smcFunc['db_query']('', '
			SELECT COALESCE(pm.id_group, 0) AS id_group, COUNT(*) AS num_members
			FROM {db_prefix}members mem
				LEFT JOIN {db_prefix}primary_membergroups AS pm ON (pm.id_member = mem.id_member AND pm.forumid = {int:forumid})
			WHERE pm.id_group IN ({array_int:group_list})
			GROUP BY pm.id_group',
			array(
				'forumid' => (int) $forumid,]]></add>
	</operation>
	<operation>	<!-- line 156 -->
		<search position="replace"><![CDATA[// Only do additional groups if we can moderate...
		if ($context['can_moderate'])
		{
			$query = $smcFunc['db_query']('', '
				SELECT mg.id_group, COUNT(*) AS num_members
				FROM {db_prefix}membergroups AS mg
					INNER JOIN {db_prefix}members AS mem ON (mem.additional_groups != {string:blank_screen}
						AND mem.id_group != mg.id_group
						AND FIND_IN_SET(mg.id_group, mem.additional_groups) != 0)
				WHERE mg.id_group IN ({array_int:group_list})
				GROUP BY mg.id_group',
				array(]]></search>
		<add><![CDATA[// Only do additional groups if we can moderate...
		if ($context['can_moderate'])
		{
			$query = $smcFunc['db_query']('', '
				SELECT mg.id_group, COUNT(*) AS num_members
				FROM {db_prefix}membergroups AS mg
					INNER JOIN {db_prefix}members AS mem ON (mem.additional_groups != {string:blank_screen}
						AND mem.id_group != mg.id_group
						AND FIND_IN_SET(mg.id_group, mem.additional_groups) != 0)
				WHERE mg.id_group IN ({array_int:group_list})
					AND (mg.forumid = {int:global_forumid} OR mg.forumid = {int:forumid})
				GROUP BY mg.id_group',
				array(
					'global_forumid' => -1,
					'forumid' => (int) $forumid,]]></add>
	</operation>

	<!-- list_getGroups function -->
	<operation>
		<search position="before"><![CDATA[global $smcFunc, $txt, $scripturl, $user_info, $settings]]></search>
		<add><![CDATA[, $forumid]]></add>
	</operation>
	<operation>	<!-- line 254 -->
		<search position="replace"><![CDATA[// Yep, find the groups...
	$request = $smcFunc['db_query']('', '
		SELECT mg.id_group, mg.group_name, mg.description, mg.group_type, mg.online_color, mg.hidden,
			mg.stars, IFNULL(gm.id_member, 0) AS can_moderate
		FROM {db_prefix}membergroups AS mg
			LEFT JOIN {db_prefix}group_moderators AS gm ON (gm.id_group = mg.id_group AND gm.id_member = {int:current_member})
		WHERE mg.min_posts = {int:min_posts}
			AND mg.id_group != {int:mod_group}' . (allowedTo('admin_forum') ? '' : '
			AND mg.group_type != {int:is_protected}') . '
		ORDER BY group_name',
		array(]]></search>
		<add><![CDATA[// Yep, find the groups...
	$request = $smcFunc['db_query']('', '
		SELECT mg.id_group, mg.group_name, mg.description, mg.group_type, mg.online_color, mg.hidden,
			mg.stars, IFNULL(gm.id_member, 0) AS can_moderate
		FROM {db_prefix}membergroups AS mg
			LEFT JOIN {db_prefix}group_moderators AS gm ON (gm.id_group = mg.id_group AND gm.id_member = {int:current_member})
		WHERE mg.min_posts = {int:min_posts}
			AND mg.id_group != {int:mod_group}
			AND (mg.forumid = {int:global_forumid} OR mg.forumid = {int:forumid})' . (allowedTo('admin_forum') ? '' : '
			AND mg.group_type != {int:is_protected}') . '
		ORDER BY group_name',
		array(
			'global_forumid' => -1,
			'forumid' => (int) $forumid,]]></add>
	</operation>
	<operation>	<!-- line 315 -->
		<search position="replace"><![CDATA[// Only do additional groups if we can moderate...
		if ($context['can_moderate'])
		{
			$query = $smcFunc['db_query']('', '
				SELECT mg.id_group, COUNT(*) AS num_members
				FROM {db_prefix}membergroups AS mg
					INNER JOIN {db_prefix}members AS mem ON (mem.additional_groups != {string:blank_screen}
						AND mem.id_group != mg.id_group
						AND FIND_IN_SET(mg.id_group, mem.additional_groups) != 0)
				WHERE mg.id_group IN ({array_int:group_list})
				GROUP BY mg.id_group',
				array(]]></search>
		<add><![CDATA[// Only do additional groups if we can moderate...
		if ($context['can_moderate'])
		{
			$query = $smcFunc['db_query']('', '
				SELECT mg.id_group, COUNT(*) AS num_members
				FROM {db_prefix}membergroups AS mg
					INNER JOIN {db_prefix}members AS mem ON (mem.additional_groups != {string:blank_screen}
						AND mem.id_group != mg.id_group
						AND FIND_IN_SET(mg.id_group, mem.additional_groups) != 0)
				WHERE mg.id_group IN ({array_int:group_list})
					AND (mg.forumid = {int:global_forumid} OR mg.forumid = {int:forumid})
				GROUP BY mg.id_group',
				array(
					'global_forumid' => -1,
					'forumid' => (int) $forumid,]]></add>
	</operation>

	<!-- list_getGroupCount function -->
	<operation>	<!-- line 359 -->
		<search position="before"><![CDATA[function list_getGroupCount()
{
	global $smcFunc]]></search>
		<add><![CDATA[, $forumid]]></add>
	</operation>
	<operation>	<!-- line 363 -->
		<search position="replace"><![CDATA[$request = $smcFunc['db_query']('', '
		SELECT COUNT(id_group) AS group_count
		FROM {db_prefix}membergroups
		WHERE mg.min_posts = {int:min_posts}
			AND mg.id_group != {int:mod_group}' . (allowedTo('admin_forum') ? '' : '
			AND mg.group_type != {int:is_protected}'),
		array(]]></search>
		<add><![CDATA[$request = $smcFunc['db_query']('', '
		SELECT COUNT(id_group) AS group_count
		FROM {db_prefix}membergroups
		WHERE mg.min_posts = {int:min_posts}
			AND mg.id_group != {int:mod_group}
			AND (forumid = {int:global_forumid} OR forumid = {int:forumid})' . (allowedTo('admin_forum') ? '' : '
			AND mg.group_type != {int:is_protected}'),
		array(
			'global_forumid' => -1,
			'forumid' => (int) $forumid,]]></add>
	</operation>

	<!-- MembergroupMembers function -->
	<operation>	<!-- line 384 -->
		<search position="before"><![CDATA[global $txt, $scripturl, $context, $modSettings, $sourcedir, $user_info, $settings, $smcFunc]]></search>
		<add><![CDATA[, $forumid]]></add>
	</operation>
	<operation>	<!-- line 392 -->
		<search position="replace"><![CDATA[// Load up the group details.
	$request = $smcFunc['db_query']('', '
		SELECT id_group AS id, group_name AS name, CASE WHEN min_posts = {int:min_posts} THEN 1 ELSE 0 END AS assignable, hidden, online_color,
			stars, description, CASE WHEN min_posts != {int:min_posts} THEN 1 ELSE 0 END AS is_post_group, group_type
		FROM {db_prefix}membergroups
		WHERE id_group = {int:id_group}
		LIMIT 1',
		array(]]></search>
		<add><![CDATA[// Load up the group details.
	$request = $smcFunc['db_query']('', '
		SELECT id_group AS id, group_name AS name, CASE WHEN min_posts = {int:min_posts} THEN 1 ELSE 0 END AS assignable, hidden, online_color,
			stars, description, CASE WHEN min_posts != {int:min_posts} THEN 1 ELSE 0 END AS is_post_group, group_type
		FROM {db_prefix}membergroups
		WHERE id_group = {int:id_group}
			AND (forumid = {int:global_forumid} OR forumid = {int:forumid})
		LIMIT 1',
		array(
			'global_forumid' => -1,
			'forumid' => (int) $forumid,]]></add>
	</operation>
	<operation>	<!-- line 561 -->
		<search position="replace"><![CDATA[$where = $context['group']['is_post_group'] ? 'id_post_group = {int:group}' : 'id_group = {int:group} OR FIND_IN_SET({int:group}, additional_groups) != 0';
	else
		$where = $context['group']['is_post_group'] ? 'id_post_group = {int:group}' : 'id_group = {int:group}';]]></search>
		<add><![CDATA[$where = $context['group']['is_post_group'] ? 'id_post_group = {int:group}' : 'pm.id_group = {int:group} OR FIND_IN_SET({int:group}, additional_groups) != 0';
	else
		$where = $context['group']['is_post_group'] ? 'id_post_group = {int:group}' : 'pm.id_group = {int:group}';]]></add>
	</operation>
	<operation>	<!-- line 565 -->
		<search position="replace"><![CDATA[// Count members of the group.
	$request = $smcFunc['db_query']('', '
		SELECT COUNT(*)
		FROM {db_prefix}members
		WHERE ' . $where,
		array(]]></search>
		<add><![CDATA[// Count members of the group.
	$request = $smcFunc['db_query']('', '
		SELECT COUNT(*)
		FROM {db_prefix}members mem
			LEFT JOIN smf_primary_membergroups pm ON (pm.id_member = mem.id_member AND pm.forumid = {int:forumid})
		WHERE ' . $where,
		array(
			'forumid' => (int) $forumid,]]></add>
	</operation>
	<operation>	<!-- line 584 -->
		<search position="replace"><![CDATA[// Load up all members of this group.
	$request = $smcFunc['db_query']('', '
		SELECT id_member, member_name, real_name, email_address, member_ip, date_registered, last_login,
			hide_email, posts, is_activated, real_name
		FROM {db_prefix}members
		WHERE ' . $where . '
		ORDER BY ' . $querySort . ' ' . ($context['sort_direction'] == 'down' ? 'DESC' : 'ASC') . '
		LIMIT ' . $context['start'] . ', ' . $modSettings['defaultMaxMembers'],
		array(]]></search>
		<add><![CDATA[// Load up all members of this group.
	$request = $smcFunc['db_query']('', '
		SELECT mem.id_member, member_name, real_name, email_address, member_ip, date_registered, last_login,
			hide_email, posts, is_activated, real_name
		FROM {db_prefix}members mem
			LEFT JOIN smf_primary_membergroups pm ON (pm.id_member = mem.id_member AND pm.forumid = {int:forumid})
		WHERE ' . $where . '
		ORDER BY ' . $querySort . ' ' . ($context['sort_direction'] == 'down' ? 'DESC' : 'ASC') . '
		LIMIT ' . $context['start'] . ', ' . $modSettings['defaultMaxMembers'],
		array(
			'forumid' => (int) $forumid,]]></add>
	</operation>

	<!-- GroupRequests function -->
	<operation>	<!-- line 626 -->
		<search position="before"><![CDATA[global $txt, $context, $scripturl, $user_info, $sourcedir, $smcFunc, $modSettings, $language]]></search>
		<add><![CDATA[, $forumid]]></add>
	</operation>
	<operation>	<!-- line 666 -->
		<search position="replace"><![CDATA[// Get the details of all the members concerned...
			$request = $smcFunc['db_query']('', '
				SELECT lgr.id_request, lgr.id_member, lgr.id_group, mem.email_address, mem.id_group AS primary_group,
					mem.additional_groups AS additional_groups, mem.lngfile, mem.member_name, mem.notify_types,
					mg.hidden, mg.group_name
				FROM {db_prefix}log_group_requests AS lgr
					INNER JOIN {db_prefix}members AS mem ON (mem.id_member = lgr.id_member)
					INNER JOIN {db_prefix}membergroups AS mg ON (mg.id_group = lgr.id_group)
				WHERE ' . $where . '
					AND lgr.id_request IN ({array_int:request_list})
				ORDER BY mem.lngfile',
				array(]]></search>
		<add><![CDATA[// Get the details of all the members concerned...
			$request = $smcFunc['db_query']('', '
				SELECT lgr.id_request, lgr.id_member, lgr.id_group, mem.email_address, mem.id_group AS primary_group,
					mem.additional_groups AS additional_groups, mem.lngfile, mem.member_name, mem.notify_types,
					mg.hidden, mg.group_name
				FROM {db_prefix}log_group_requests AS lgr
					INNER JOIN {db_prefix}members AS mem ON (mem.id_member = lgr.id_member)
					INNER JOIN {db_prefix}membergroups AS mg ON (mg.id_group = lgr.id_group)
				WHERE ' . $where . '
					AND lgr.id_request IN ({array_int:request_list})
					AND (mg.forumid = {int:global_forumid} OR mg.forumid = {int:forumid})
				ORDER BY mem.lngfile',
				array(
					'global_forumid' => -1,
					'forumid' => (int) $forumid,]]></add>
	</operation>

	<!-- list_getGroupRequests function -->
	<operation>	<!-- line 936 -->
		<search position="before"><![CDATA[function list_getGroupRequests($start, $items_per_page, $sort, $where, $where_parameters)
{
	global $smcFunc, $txt, $scripturl]]></search>
		<add><![CDATA[, $forumid]]></add>
	</operation>
	<operation>	<!-- line 938 -->
		<search position="replace"><![CDATA[$request = $smcFunc['db_query']('', '
		SELECT lgr.id_request, lgr.id_member, lgr.id_group, lgr.time_applied, lgr.reason,
			mem.member_name, mg.group_name, mg.online_color, mem.real_name
		FROM {db_prefix}log_group_requests AS lgr
			INNER JOIN {db_prefix}members AS mem ON (mem.id_member = lgr.id_member)
			INNER JOIN {db_prefix}membergroups AS mg ON (mg.id_group = lgr.id_group)
		WHERE ' . $where . '
		ORDER BY {raw:sort}
		LIMIT ' . $start . ', ' . $items_per_page,
		array_merge($where_parameters, array(]]></search>
		<add><![CDATA[$request = $smcFunc['db_query']('', '
		SELECT lgr.id_request, lgr.id_member, lgr.id_group, lgr.time_applied, lgr.reason,
			mem.member_name, mg.group_name, mg.online_color, mem.real_name
		FROM {db_prefix}log_group_requests AS lgr
			INNER JOIN {db_prefix}members AS mem ON (mem.id_member = lgr.id_member)
			INNER JOIN {db_prefix}membergroups AS mg ON (mg.id_group = lgr.id_group)
		WHERE ' . $where . '
			AND (mg.forumid = {int:global_forumid} OR mg.forumid = {int:forumid})
		ORDER BY {raw:sort}
		LIMIT ' . $start . ', ' . $items_per_page,
		array_merge($where_parameters, array(
			'global_forumid' => -1,
			'forumid' => (int) $forumid,]]></add>
	</operation>
</file>
<file name="$sourcedir/Load.php">
	<!-- loadUserSettings function -->
	<operation>	<!-- line 336 -->
		<search position="before"><![CDATA[global $modSettings, $user_settings, $sourcedir, $smcFunc]]></search>
		<add><![CDATA[, $forumid]]></add>
	</operation>
	<operation>	<!-- line 382 -->
		<search position="before"><![CDATA[SELECT mem.*, IFNULL(a.id_attach, 0) AS id_attach, a.filename, a.attachment_type]]></search>
		<add><![CDATA[, COALESCE(pm.id_group, 0) AS id_group]]></add>
	</operation>
	<operation>	<!-- line 384 -->
		<search position="before"><![CDATA[LEFT JOIN {db_prefix}attachments AS a ON (a.id_member = {int:id_member})]]></search>
		<add><![CDATA[
					LEFT JOIN {db_prefix}primary_membergroups AS pm ON (pm.id_member = {int:id_member} AND pm.forumid = {int:forumid})]]></add>
	</operation>
	<operation>	<!-- line 388 -->
		<search position="before"><![CDATA['id_member' => $id_member,]]></search>
		<add><![CDATA[
					'forumid' => (int) $forumid,]]></add>
	</operation>

	<!-- loadBoard function -->
	<operation>	<!-- line 583 -->
		<search position="before"><![CDATA[global $txt, $scripturl, $context, $modSettings]]></search>
		<add><![CDATA[, $subtheme, $forumid, $boardurl]]></add>
	</operation>
	<operation>	<!-- line 584 -->
		<search position="before"><![CDATA[global $board_info, $board, $topic, $user_info, $smcFunc]]></search>
		<add><![CDATA[, $subforum_tree]]></add>
	</operation>
	<operation>	<!-- line 658 -->
		<search position="after"><![CDATA[if (empty($temp))
	{
		$request = $smcFunc['db_query']('', ']]></search>
		<add><![CDATA[retry_board_info:
	]]></add>
	</operation>
	<operation>	<!-- line 662 -->
		<search position="before"><![CDATA[b.id_parent, c.name AS cname, ]]></search>
		<add><![CDATA[c.forumid, ]]></add>
	</operation>
	<operation>	<!-- line 677 -->
		<search position="before"><![CDATA[// If there aren't any, skip.
		if ($smcFunc['db_num_rows']($request) > 0)
		{
			$row = $smcFunc['db_fetch_assoc']($request);]]></search>
		<add><![CDATA[
			// Find the right subforum to redirect to:
			if (!empty($row['alias_board']) && empty($temp_board))
			{
				$board = $row['alias_board'];
				$smcFunc['db_free_result']($request);
				if ($row['forumid'] != $forumid)
				{
					goto retry_board_info;
				}
			}
			if ($row['forumid'] != $forumid)
			{
				// Try to get the board alias if the Alias Boards mod is installed:
				if (!empty($row['alias_board']))
				{
					$board = $row['alias_board'];
					$request2 = $smcFunc['db_query']('', '
						SELECT b.id_cat, b.id_board, b.id_parent, b.name AS bname, c.name AS cname, b.description
						FROM {db_prefix}boards AS b
							LEFT JOIN {db_prefix}categories AS c ON (c.id_cat = b.id_cat)
						WHERE b.alias_board = {int:board}
							AND c.forumid = {int:forumid}
						LIMIT 1',
						array(
							'board' => empty($board) ? $row['id_board'] : $board,
							'forumid' => (int) $forumid,
						)
					);
					if ($smcFunc['db_num_rows']($request2) > 0)
					{
						$temp_board = $smcFunc['db_fetch_assoc']($request2);
						$smcFunc['db_free_result']($request2);
					}
				}
				if (empty($temp_board))
				{
					// If the "subforum_redirect_wrong" variable is set and $sub isn't empty, then redirect:
					$sub = (isset($subforum_tree[(int) $row['forumid']]) ? $subforum_tree[(int) $row['forumid']] : 0);
					if (!empty($modSettings['subforum_redirect_wrong']) && (!empty($sub)))
					{
						$url = ((!empty($_SERVER['HTTPS']) && $_SERVER['HTTPS'] !== 'off') || $_SERVER['SERVER_PORT'] == 443 ? 'https://' : 'http://') . $_SERVER['HTTP_HOST'] . $_SERVER['REQUEST_URI'];
						redirectexit(str_replace($boardurl, $sub['boardurl'], $url));
					}

					// Throw error about wrong forum:
					loadPermissions();
					loadTheme();
					loadLanguage('ManageSplitForum');
					fatal_lang_error('wrong_forum', false);
				}
			}]]></add>
	</operation>
	<operation>	<!-- line 682 -->
		<search position="before"><![CDATA[// Set the current board.]]></search>
		<add><![CDATA[
			if (!empty($temp_board))
				$row = array_merge($row, $temp_board, array('redirect' => ''));]]></add>
	</operation>

	<!-- loadMemberData function -->
	<operation>	<!-- line 995 -->
		<search position="before"><![CDATA[global $user_profile, $modSettings, $board_info, $smcFunc]]></search>
		<add><![CDATA[, $forumid]]></add>
	</operation>
	<operation>	<!-- line 987 -->
		<search position="replace"><![CDATA[mem.karma_good, mem.id_post_group, mem.karma_bad, mem.lngfile, mem.id_group, mem.time_offset, mem.show_online,
			mem.buddy_list, mg.online_color AS member_group_color, IFNULL(mg.group_name, {string:blank_string}) AS member_group,
			pg.online_color AS post_group_color, IFNULL(pg.group_name, {string:blank_string}) AS post_group, mem.is_activated, mem.warning,
			CASE WHEN mem.id_group = 0 OR mg.stars = {string:blank_string} THEN pg.stars ELSE mg.stars END AS stars' . (!empty($modSettings['titlesEnable']) ? ',
			mem.usertitle' : '');
		$select_tables = '
			LEFT JOIN {db_prefix}log_online AS lo ON (lo.id_member = mem.id_member)
			LEFT JOIN {db_prefix}attachments AS a ON (a.id_member = mem.id_member)
			LEFT JOIN {db_prefix}membergroups AS pg ON (pg.id_group = mem.id_post_group)
			LEFT JOIN {db_prefix}membergroups AS mg ON (mg.id_group = mem.id_group)';]]></search>
		<add><![CDATA[mem.karma_good, mem.id_post_group, mem.karma_bad, mem.lngfile, COALESCE(pmg.id_group, 0) AS id_group, mem.time_offset, mem.show_online,
			mem.buddy_list, mg.online_color AS member_group_color, IFNULL(mg.group_name, {string:blank_string}) AS member_group,
			pg.online_color AS post_group_color, IFNULL(pg.group_name, {string:blank_string}) AS post_group, mem.is_activated, mem.warning,
			CASE WHEN COALESCE(pmg.id_group, 0) = 0 OR mg.stars = {string:blank_string} THEN pg.stars ELSE mg.stars END AS stars' . (!empty($modSettings['titlesEnable']) ? ',
			mem.usertitle' : '');
		$select_tables = '
			LEFT JOIN {db_prefix}primary_membergroups AS pmg ON (pmg.id_member = mem.id_member AND pmg.forumid = {int:forumid})
			LEFT JOIN {db_prefix}log_online AS lo ON (lo.id_member = mem.id_member)
			LEFT JOIN {db_prefix}attachments AS a ON (a.id_member = mem.id_member)
			LEFT JOIN {db_prefix}membergroups AS pg ON (pg.id_group = mem.id_post_group)
			LEFT JOIN {db_prefix}membergroups AS mg ON (mg.id_group = pmg.id_group)';]]></add>
	</operation>
	<operation>	<!-- line 1005 -->
		<search position="replace"><![CDATA[mem.karma_bad, mem.member_ip, mem.member_ip2, mem.lngfile, mem.id_group, mem.id_theme, mem.buddy_list,
			mem.pm_ignore_list, mem.pm_email_notify, mem.pm_receive_from, mem.time_offset' . (!empty($modSettings['titlesEnable']) ? ', mem.usertitle' : '') . ',
			mem.time_format, mem.secret_question, mem.is_activated, mem.additional_groups, mem.smiley_set, mem.show_online,
			mem.total_time_logged_in, mem.id_post_group, mem.notify_announcements, mem.notify_regularity, mem.notify_send_body,
			mem.notify_types, lo.url, mg.online_color AS member_group_color, IFNULL(mg.group_name, {string:blank_string}) AS member_group,
			pg.online_color AS post_group_color, IFNULL(pg.group_name, {string:blank_string}) AS post_group, mem.ignore_boards, mem.warning,
			CASE WHEN mem.id_group = 0 OR mg.stars = {string:blank_string} THEN pg.stars ELSE mg.stars END AS stars, mem.password_salt, mem.pm_prefs';
		$select_tables = '
			LEFT JOIN {db_prefix}log_online AS lo ON (lo.id_member = mem.id_member)
			LEFT JOIN {db_prefix}attachments AS a ON (a.id_member = mem.id_member)
			LEFT JOIN {db_prefix}membergroups AS pg ON (pg.id_group = mem.id_post_group)
			LEFT JOIN {db_prefix}membergroups AS mg ON (mg.id_group = mem.id_group)';]]></search>
		<add><![CDATA[mem.karma_bad, mem.member_ip, mem.member_ip2, mem.lngfile, COALESCE(pmg.id_group, 0) AS id_group, mem.id_theme, mem.buddy_list,
			mem.pm_ignore_list, mem.pm_email_notify, mem.pm_receive_from, mem.time_offset' . (!empty($modSettings['titlesEnable']) ? ', mem.usertitle' : '') . ',
			mem.time_format, mem.secret_question, mem.is_activated, mem.additional_groups, mem.smiley_set, mem.show_online,
			mem.total_time_logged_in, mem.id_post_group, mem.notify_announcements, mem.notify_regularity, mem.notify_send_body,
			mem.notify_types, lo.url, mg.online_color AS member_group_color, IFNULL(mg.group_name, {string:blank_string}) AS member_group,
			pg.online_color AS post_group_color, IFNULL(pg.group_name, {string:blank_string}) AS post_group, mem.ignore_boards, mem.warning,
			CASE WHEN COALESCE(pmg.id_group, 0) = 0 OR mg.stars = {string:blank_string} THEN pg.stars ELSE mg.stars END AS stars, mem.password_salt, mem.pm_prefs';
		$select_tables = '
			LEFT JOIN {db_prefix}log_online AS lo ON (lo.id_member = mem.id_member)
			LEFT JOIN {db_prefix}attachments AS a ON (a.id_member = mem.id_member)
			LEFT JOIN {db_prefix}membergroups AS pg ON (pg.id_group = mem.id_post_group)
			LEFT JOIN {db_prefix}primary_membergroups AS pmg ON (pmg.id_member = mem.id_member AND pmg.forumid = {int:forumid})
			LEFT JOIN {db_prefix}membergroups AS mg ON (mg.id_group = pmg.id_group)';]]></add>
	</operation>
	<operation>	<!-- line 1022 -->
		<search position="replace"><![CDATA[$select_columns = '
			mem.id_member, mem.member_name, mem.real_name, mem.email_address, mem.hide_email, mem.date_registered,
			mem.posts, mem.last_login, mem.member_ip, mem.member_ip2, mem.lngfile, mem.id_group';
		$select_tables = '';]]></search>
		<add><![CDATA[$select_columns = '
			mem.id_member, mem.member_name, mem.real_name, mem.email_address, mem.hide_email, mem.date_registered,
			mem.posts, mem.last_login, mem.member_ip, mem.member_ip2, mem.lngfile, COALESCE(pmg.id_group, 0) AS id_group';
        $select_tables = '
			LEFT JOIN {db_prefix}primary_membergroups AS pmg ON (pmg.id_member = mem.id_member AND pmg.forumid = {int:forumid})';]]></add>
	</operation>
	<operation>	<!-- line 1037 -->
		<search position="before"><![CDATA['users' => count($users) == 1 ? current($users) : $users,]]></search>
		<add><![CDATA[
				'forumid' => (int) $forumid,]]></add>
	</operation>

	<!-- loadTheme function -->
	<operation>	<!-- line 1363 -->
		<search position="before"><![CDATA[global $context, $settings, $options, $sourcedir, $ssi_theme, $smcFunc]]></search>
		<add><![CDATA[, $subtheme, $forumid]]></add>
	</operation>
	<operation>	<!-- line 1365 -->
		<search position="after"><![CDATA[// The theme was specified by parameter.]]></search>
		<add><![CDATA[// Load subforum theme if we are in one.
	if (!empty($forumid) && empty($id_theme))
		$id_theme = $subtheme;

	]]></add>
	</operation>
</file>
<file name="$sourcedir/LogInOut.php">
	<!-- Login2 function -->
	<operation>	<!-- line 96 -->
		<search position="before"><![CDATA[global $cookiename, $maintenance, $modSettings, $context, $sc, $sourcedir]]></search>
		<add><![CDATA[, $forumid]]></add>
	</operation>
	<operation>	<!-- line 232 -->
		<search position="replace"><![CDATA[// Load the data up!
	$request = $smcFunc['db_query']('', '
		SELECT passwd, id_member, id_group, lngfile, is_activated, email_address, additional_groups, member_name, password_salt,
			openid_uri, passwd_flood
		FROM {db_prefix}members
		WHERE ' . ($smcFunc['db_case_sensitive'] ? 'LOWER(member_name) = LOWER({string:user_name})' : 'member_name = {string:user_name}') . '
		LIMIT 1',
		array(
			'user_name' => $smcFunc['db_case_sensitive'] ? strtolower($_POST['user']) : $_POST['user'],]]></search>
		<add><![CDATA[// Load the data up!
	$request = $smcFunc['db_query']('', '
		SELECT mem.passwd, mem.id_member, pm.id_group, mem.lngfile, mem.is_activated, mem.email_address,
			mem.additional_groups, mem.member_name, mem.password_salt, mem.openid_uri, mem.passwd_flood
		FROM {db_prefix}members mem
			LEFT JOIN {db_prefix}primary_membergroups AS pm ON (pm.id_member = mem.id_member AND pm.forumid = {int:forumid})
		WHERE ' . ($smcFunc['db_case_sensitive'] ? 'LOWER(member_name) = LOWER({string:user_name})' : 'member_name = {string:user_name}') . '
		LIMIT 1',
		array(
			'user_name' => $smcFunc['db_case_sensitive'] ? strtolower($_POST['user']) : $_POST['user'],
			'forumid' => (int) $forumid,]]></add>
	</operation>
	<operation>	<!-- line 240 -->
		<search position="replace"><![CDATA[$request = $smcFunc['db_query']('', '
			SELECT passwd, id_member, id_group, lngfile, is_activated, email_address, additional_groups, member_name, password_salt, openid_uri,
			passwd_flood
			FROM {db_prefix}members
			WHERE email_address = {string:user_name}
			LIMIT 1',
			array(
				'user_name' => $_POST['user'],]]></search>
		<add><![CDATA[$request = $smcFunc['db_query']('', '
			SELECT mem.passwd, mem.id_member, pm.id_group, mem.lngfile, mem.is_activated, mem.email_address,
				mem.additional_groups, mem.member_name, mem.password_salt, mem.openid_uri, mem.passwd_flood
			FROM {db_prefix}members mem
				LEFT JOIN {db_prefix}primary_membergroups AS pm ON (pm.id_member = mem.id_member AND pm.forumid = {int:forumid})
			WHERE email_address = {string:user_name}
			LIMIT 1',
			array(
				'user_name' => $_POST['user'],
				'forumid' => (int) $forumid,]]></add>
	</operation>
</file>
<file name="$sourcedir/ManageBans.php">
	<!-- BanEdit function -->
	<operation>	<!-- line 385 -->
		<search position="before"><![CDATA[global $txt, $modSettings, $context, $ban_request, $scripturl, $smcFunc]]></search>
		<add><![CDATA[, $forumid]]></add>
	</operation>
	<operation>	<!-- line 467 -->
		<search position="replace"><![CDATA[SELECT id_member
				FROM {db_prefix}members
				WHERE (id_group = {int:admin_group} OR FIND_IN_SET({int:admin_group}, additional_groups) != 0)
					AND email_address LIKE {string:email}
				LIMIT 1',
				array(
					'admin_group' => 1,
					'email' => $_POST['email'],]]></search>
		<add><![CDATA[SELECT mem.id_member
				FROM {db_prefix}members mem
					LEFT JOIN smf_primary_membergroups AS pm ON (pm.forumid = {int:forumid} AND pm.id_member = mem.id_member)
				WHERE (pm.id_group = {int:admin_group} OR FIND_IN_SET({int:admin_group}, mem.additional_groups) != 0)
					AND mem.email_address LIKE {string:email}
				LIMIT 1',
				array(
					'admin_group' => 1,
					'email' => $_POST['email'],
					'forumid' => (int) $forumid,]]></add>
	</operation>
	<operation>	<!-- line 489 -->
		<search position="replace"><![CDATA[SELECT id_member, (id_group = {int:admin_group} OR FIND_IN_SET({int:admin_group}, additional_groups) != 0) AS isAdmin
				FROM {db_prefix}members
				WHERE member_name = {string:user_name} OR real_name = {string:user_name}
				LIMIT 1',
				array(
					'admin_group' => 1,
					'user_name' => $_POST['user'],]]></search>
		<add><![CDATA[SELECT mem.id_member, (pm.id_group = {int:admin_group} OR FIND_IN_SET({int:admin_group}, mem.additional_groups) != 0) AS isAdmin
				FROM {db_prefix}members mem
					LEFT JOIN smf_primary_membergroups AS pm ON (pm.forumid = {int:forumid} AND pm.id_member = mem.id_member)
				WHERE mem.member_name = {string:user_name} OR mem.real_name = {string:user_name}
				LIMIT 1',
				array(
					'admin_group' => 1,
					'user_name' => $_POST['user'],
					'forumid' => (int) $forumid,]]></add>
	</operation>
	<operation>	<!-- line 680 -->
		<search position="replace"><![CDATA[SELECT id_member, (id_group = {int:admin_group} OR FIND_IN_SET({int:admin_group}, additional_groups) != 0) AS isAdmin
							FROM {db_prefix}members
							WHERE member_name = {string:username} OR real_name = {string:username}
							LIMIT 1',
							array(
								'admin_group' => 1,
								'username' => $_POST['user'],]]></search>
		<add><![CDATA[SELECT mem.id_member, (pm.id_group = {int:admin_group} OR FIND_IN_SET({int:admin_group}, mem.additional_groups) != 0) AS isAdmin
							FROM {db_prefix}members mem
								LEFT JOIN smf_primary_membergroups AS pm ON (pm.forumid = {int:forumid} AND pm.id_member = mem.id_member)
							WHERE mem.member_name = {string:username} OR mem.real_name = {string:username}
							LIMIT 1',
							array(
								'admin_group' => 1,
								'username' => $_POST['user'],
								'forumid' => (int) $forumid,]]></add>
	</operation>
</file>
<file name="$sourcedir/ManageBoards.php">
	<!-- ManageBoards function -->
	<operation>	<!-- line 73 -->
		<search position="before"><![CDATA[// Everything's gonna need this.
	loadLanguage('ManageBoards');]]></search>
		<add><![CDATA[
	$context['seperate_aliases'] = true;]]></add>
	</operation>

	<!-- ManageBoardsMain function -->
	<operation>	<!-- line 118 -->
		<search position="before"><![CDATA[global $txt, $context, $cat_tree, $boards, $boardList, $scripturl, $sourcedir, $txt]]></search>
		<add><![CDATA[, $boardurl, $forumid]]></add>
	</operation>
	<operation>	<!-- line 142 -->
		<search position="replace"><![CDATA[getBoardTree();]]></search>
		<add><![CDATA[getBoardTree( ($forumid == 0 ? -1 : $forumid) );]]></add>
	</operation>
	<operation>	<!-- line 148 -->
		<search position="after"><![CDATA['name' => &$tree['node']['name'],]]></search>
		<add><![CDATA['forumid' => $tree['node']['forumid'],
			]]></add>
	</operation>

	<!-- EditCategory function -->
	<operation>	<!-- line 235 -->
		<search position="before"><![CDATA[global $txt, $context, $cat_tree, $boardList, $boards, $sourcedir]]></search>
		<add><![CDATA[, $forumid, $subforum_tree]]></add>
	</operation>
	<operation>	<!-- line 238 -->
		<search position="replace"><![CDATA[require_once($sourcedir . '/Subs-Boards.php');
	getBoardTree();

	// id_cat must be a number.... if it exists.
	$_REQUEST['cat'] = isset($_REQUEST['cat']) ? (int) $_REQUEST['cat'] : 0;]]></search>
		<add><![CDATA[require_once($sourcedir . '/Subs-Boards.php');
	getBoardTree( ($forumid == 0 ? -1 : $forumid) );

	// id_cat must be a number.... if it exists.
	$_REQUEST['cat'] = isset($_REQUEST['cat']) ? (int) $_REQUEST['cat'] : 0;
	$_REQUEST['sub'] = isset($_REQUEST['sub']) ? (int) $_REQUEST['sub'] : 0;]]></add>
	</operation>
	<operation>	<!-- line 245 -->
		<search position="replace"><![CDATA[$context['category_order'] = array(
		array(
			'id' => 0,
			'name' => $txt['mboards_order_first'],
			'selected' => !empty($_REQUEST['cat']) ? $cat_tree[$_REQUEST['cat']]['is_first'] : false,
			'true_name' => ''
		)
	);]]></search>
		<add><![CDATA[$context['category_order'] = array();
	foreach ($subforum_tree as $stuff)
		$context['category_order'][$stuff['forumid']] = array(
			array(
				'id' => 0,
				'name' => $txt['mboards_order_first'],
				'selected' => !empty($_REQUEST['cat']) ? $cat_tree[$_REQUEST['cat']]['is_first'] : false,
				'true_name' => ''
			)
		);]]></add>
	</operation>
	<operation>	<!-- line 261 -->
		<search position="before"><![CDATA['can_collapse' => true,]]></search>
		<add><![CDATA[
			'forumid' => (!empty($_REQUEST['sub']) ? $_REQUEST['sub'] : 0),]]></add>
	</operation>
	<operation>	<!-- line 266 -->
		<search position="replace"><![CDATA[elseif (!isset($cat_tree[$_REQUEST['cat']]))
		redirectexit('action=admin;area=manageboards');]]></search>
		<add><![CDATA[elseif (!isset($cat_tree[$_REQUEST['cat']]))
		redirectexit('action=admin;area=manageboards' . (!empty($_REQUEST['sub']) ? ';sub=' . $_REQUEST['sub'] : ''));]]></add>
	</operation>
	<operation>	<!-- line 275 -->
		<search position="before"><![CDATA['can_collapse' => !empty($cat_tree[$_REQUEST['cat']]['node']['can_collapse']),]]></search>
		<add><![CDATA[
			'forumid' => (int)($cat_tree[$_REQUEST['cat']]['node']['forumid']),]]></add>
	</operation>
	<operation>	<!-- line 288 -->
		<search position="replace"><![CDATA[$context['category_order'][$prevCat]['selected'] = true;
		elseif ($catid != $_REQUEST['cat'])
			$context['category_order'][$catid] = array(]]></search>
		<add><![CDATA[$context['category_order'][$tree['node']['forumid']][$prevCat]['selected'] = true;
		elseif ($catid != $_REQUEST['cat'])
			$context['category_order'][$tree['node']['forumid']][$catid] = array(
				'forumid' => $tree['node']['forumid'],]]></add>
	</operation>
	<operation>	<!-- line 326 -->
		<search position="replace"><![CDATA[if (isset($_POST['cat_order']))
			$catOptions['move_after'] = (int) $_POST['cat_order'];]]></search>
		<add><![CDATA[if (isset($_POST['cat_order' . ((int) $_POST['forum_id'])]))
			$catOptions['move_after'] = (int) $_POST['cat_order' . ((int) $_POST['forum_id'])];]]></add>
	</operation>
	<operation>	<!-- line 332 -->
		<search position="before"><![CDATA[$catOptions['is_collapsible'] = isset($_POST['collapse']);]]></search>
		<add><![CDATA[
		$catOptions['forumid'] = (int)($_POST['forum_id']);]]></add>
	</operation>
	<operation>	<!-- line 360 -->
		<search position="replace"><![CDATA[redirectexit('action=admin;area=manageboards');
}]]></search>
		<add><![CDATA[redirectexit('action=admin;area=manageboards' . (!empty($_REQUEST['sub']) ? ';sub=' . $_REQUEST['sub'] : ''));
}]]></add>
	</operation>

	<!-- EditBoard function -->
	<operation>	<!-- line 366 -->
		<search position="before"><![CDATA[global $txt, $context, $cat_tree, $boards, $boardList, $sourcedir, $smcFunc, $modSettings]]></search>
		<add><![CDATA[, $forumid, $subforum_tree]]></add>
	</operation>
	<operation>	<!-- line 369 -->
		<search position="replace"><![CDATA[require_once($sourcedir . '/Subs-Boards.php');
	getBoardTree();]]></search>
		<add><![CDATA[require_once($sourcedir . '/Subs-Boards.php');
	getBoardTree( ($forumid == 0 ? -1 : $forumid) );]]></add>
	</operation>
	<operation>	<!-- line 388 -->
		<search position="replace"><![CDATA[if (empty($_REQUEST['cat']))
			redirectexit('action=admin;area=manageboards');]]></search>
		<add><![CDATA[if (empty($_REQUEST['cat']))
			redirectexit('action=admin;area=manageboards' . (!empty($_REQUEST['sub']) ? ';sub=' . $_REQUEST['sub'] : ''));]]></add>
	</operation>
	<operation>	<!-- line 450 -->
		<search position="replace"><![CDATA[WHERE id_group > {int:moderator_group} OR id_group = {int:global_moderator}]]></search>
		<add><![CDATA[WHERE (id_group > {int:moderator_group} OR id_group = {int:global_moderator})
			AND (forumid = {int:global_forumid} OR forumid = {int:forumid})]]></add>
	</operation>
	<operation>	<!-- line 454 -->
		<search position="before"><![CDATA['global_moderator' => 2,]]></search>
		<add><![CDATA[
			'global_forumid' => -1,
			'forumid' => (int) $forumid,]]></add>
	</operation>
	<operation>
		<search position="replace"><![CDATA[// Category doesn't exist, man... sorry.
	if (!isset($boardList[$curBoard['category']]))
		redirectexit('action=admin;area=manageboards');

	foreach ($boardList[$curBoard['category']] as $boardid)
	{
		if ($boardid == $_REQUEST['boardid'])
		{
			$context['board_order'][] = array(
				'id' => $boardid,
				'name' => str_repeat('-', $boards[$boardid]['level']) . ' (' . $txt['mboards_current_position'] . ')',
				'children' => $boards[$boardid]['tree']['children'],
				'no_children' => empty($boards[$boardid]['tree']['children']),
				'is_child' => false,
				'selected' => true
			);
		}
		else
		{
			$context['board_order'][] = array(
				'id' => $boardid,
				'name' => str_repeat('-', $boards[$boardid]['level']) . ' ' . $boards[$boardid]['name'],
				'is_child' => empty($_REQUEST['boardid']) ? false : isChildOf($boardid, $_REQUEST['boardid']),
				'selected' => false
			);
		}
	}]]></search>
		<add><![CDATA[// Category doesn't exist, man... sorry.
	if (!isset($boardList[$curBoard['category']]))
		redirectexit('action=admin;area=manageboards' . (!empty($_REQUEST['sub']) ? ';sub=' . $_REQUEST['sub'] : ''));

	$selected_cat = -1;
	foreach ($boardList as $cat => $list)
	{
		$context['board_order'][$cat] = array();
		foreach ($list as $boardid)
		{
			if ($boardid == $_REQUEST['boardid'])
			{
				$context['board_order'][$cat][] = array(
					'id' => $boardid,
					'name' => str_repeat('-', $boards[$boardid]['level']) . ' (' . $txt['mboards_current_position'] . ')',
					'children' => $boards[$boardid]['tree']['children'],
					'no_children' => empty($boards[$boardid]['tree']['children']),
					'is_child' => false,
					'selected' => true
				);
				$selected_cat = $cat;
			}
			else
			{
				$context['board_order'][$cat][] = array(
					'id' => $boardid,
					'name' => str_repeat('-', $boards[$boardid]['level']) . ' ' . $boards[$boardid]['name'],
					'is_child' => empty($_REQUEST['boardid']) ? false : isChildOf($boardid, $_REQUEST['boardid']),
					'selected' => false
				);
			}
		}
	}
	foreach ($context['board_order'] as $cat => $boards2)
	{
		if ($selected_cat != $cat && !empty($context['board_order'][$cat][0]['selected']))
			$context['board_order'][$cat][0]['selected'] = true;
	}]]></add>
	</operation>
	<operation>	<!-- line 502 -->
		<search position="replace"><![CDATA[$context['can_move_children'] = false;
		$context['children'] = $boards[$_REQUEST['boardid']]['tree']['children'];
		foreach ($context['board_order'] as $board)
			if ($board['is_child'] == false && $board['selected'] == false)
				$context['can_move_children'] = true;]]></search>
		<add><![CDATA[$context['can_move_children'] = false;
		if (isset($boards[$_REQUEST['boardid']]['tree']['children']))
			$context['children'] = $boards[$_REQUEST['boardid']]['tree']['children'];
		else
			$context['children'] = array();
		foreach ($context['board_order'] as $cat => $list)
			foreach ($list as $board)
				if ($board['is_child'] == false && $board['selected'] == false)
					$context['can_move_children'] = true;]]></add>
	</operation>
	<operation>	<!-- line 509 -->
		<search position="replace"><![CDATA[// Get other available categories.
	$context['categories'] = array();
	foreach ($cat_tree as $catID => $tree)
		$context['categories'][] = array(]]></search>
		<add><![CDATA[// Get other available categories.
	$context['categories'] = array();
	foreach ($subforum_tree as $subforum)
		$context['categories'][$subforum['forumid']] = array();
	foreach ($cat_tree as $catID => $tree)
		$context['categories'][$tree['node']['forumid']][] = array(]]></add>
	</operation>

	<!-- EditBoard2 function -->
	<operation>	<!-- line 566 -->
		<search position="before"><![CDATA[global $txt, $sourcedir, $modSettings, $smcFunc, $context]]></search>
		<add><![CDATA[, $forumid, $subforum_tree]]></add>
	</operation>
	<operation>	<!-- line 577 -->
		<search position="replace"><![CDATA[$boardOptions = array();

		// Move this board to a new category?
		if (!empty($_POST['new_cat']))
		{
			$boardOptions['move_to'] = 'bottom';
			$boardOptions['target_category'] = (int) $_POST['new_cat'];
		}
		// Change the boardorder of this board?
		elseif (!empty($_POST['placement']) && !empty($_POST['board_order']))
		{
			if (!in_array($_POST['placement'], array('before', 'after', 'child')))
				fatal_lang_error('mangled_post', false);

			$boardOptions['move_to'] = $_POST['placement'];
			$boardOptions['target_board'] = (int) $_POST['board_order'];
		}

		// Checkboxes....]]></search>
		<add><![CDATA[$boardOptions = array();
		$sub = (isset($_POST['new_forum']) ? $_POST['new_forum'] : $forumid);
		$cat = (isset($_POST['new_cat' . $sub]) ? $_POST['new_cat' . $sub] : '');

		// Move this board to a new category?
		if (!empty($cat))
		{
			$boardOptions['move_to'] = 'bottom';
			$boardOptions['target_category'] = $cat;
		}

		// Change the boardorder of this board?
		$cat = (!empty($cat) ? $cat : (isset($_POST['current_cat']) ? $_POST['current_cat'] : ''));
		if (!empty($_POST['placement' . $cat]) && !empty($_POST['board_order' . $cat]))
		{
			if (!in_array($_POST['placement' . $cat], array('before', 'after', 'child')))
				fatal_lang_error('mangled_post', false);

			$boardOptions['move_to'] = $_POST['placement' . $cat];
			$boardOptions['target_board'] = (int) $_POST['board_order' . $cat];
		}

		// Checkboxes....]]></add>
	</operation>
	<operation>	<!-- line 688 -->
		<search position="replace"><![CDATA[redirectexit('action=admin;area=permissions;sa=board;' . $context['session_var'] . '=' . $context['session_id']);
	else
		redirectexit('action=admin;area=manageboards');]]></search>
		<add><![CDATA[redirectexit('action=admin;area=permissions;sa=board' . (!empty($_REQUEST['sub']) ? ';sub=' . $_REQUEST['sub'] : '') . ';' . $context['session_var'] . '=' . $context['session_id']);
	else
		redirectexit('action=admin;area=manageboards' . (!empty($_REQUEST['sub']) ? ';sub=' . $_REQUEST['sub'] : ''));]]></add>
	</operation>

	<!-- EditBoardSettings function -->
	<operation>	<!-- line 733 -->
		<search position="before"><![CDATA[global $context, $txt, $sourcedir, $modSettings, $scripturl, $smcFunc]]></search>
		<add><![CDATA[, $forumid]]></add>
	</operation>
	<operation>	<!-- line 740 -->
		<search position="replace"><![CDATA[LEFT JOIN {db_prefix}categories AS c ON (c.id_cat = b.id_cat)
		WHERE redirect = {string:empty_string}',
		array(]]></search>
		<add><![CDATA[LEFT JOIN {db_prefix}categories AS c ON (c.id_cat = b.id_cat AND c.forumid = {int:forumid})
		WHERE redirect = {string:empty_string}',
		array(
			'forumid' => (int) $forumid,]]></add>
	</operation>
</file>
<file name="$sourcedir/ManageCalendar.php">
	<!-- ModifyCalendarSettings function -->
	<operation>	<!-- line 274 -->
		<search position="before"><![CDATA[global $modSettings, $context, $settings, $txt, $boarddir, $sourcedir, $scripturl, $smcFunc]]></search>
		<add><![CDATA[, $forumid]]></add>
	</operation>
	<operation>	<!-- line 282 -->
		<search position="replace"><![CDATA[LEFT JOIN {db_prefix}categories AS c ON (c.id_cat = b.id_cat)',
		array(]]></search>
		<add><![CDATA[LEFT JOIN {db_prefix}categories AS c ON (c.id_cat = b.id_cat AND c.forumid = {int:forumid})',
		array(
			'forumid' => (int) $forumid,]]></add>
	</operation>
</file>
<file name="$sourcedir/ManageMembergroups.php">
	<!-- AddMembergroup function -->
	<operation>	<!-- line 346 -->
		<search position="before"><![CDATA[function AddMembergroup()
{
	global $context, $txt, $sourcedir, $modSettings, $smcFunc]]></search>
		<add><![CDATA[, $subforum_tree, $forumid]]></add>
	</operation>
	<operation>	<!-- line 348 -->
		<search position="after"><![CDATA[// A form was submitted, we can start adding.]]></search>
		<add><![CDATA[// Restrict user to editing current subforum ONLY if we are in a subforum:
	if (!empty($forumid))
		$subforum_tree = array($forumid => $subforum_tree[$forumid]);

	]]></add>
	</operation>
	<operation>	<!-- line 372 -->
		<search position="before"><![CDATA['stars' => 'string', 'online_color' => 'string', 'group_type' => 'int',]]></search>
		<add><![CDATA[ 'forumid' => 'int',]]></add>
	</operation>
	<operation>	<!-- line 376 -->
		<search position="before"><![CDATA['1#star.gif', '', $_POST['group_type'],]]></search>
		<add><![CDATA[ $forumid,]]></add>
	</operation>
	<operation>	<!-- line 561 -->
		<search position="replace"><![CDATA[WHERE (id_group > {int:moderator_group} OR id_group = {int:global_mod_group})' . (empty($modSettings['permission_enable_postgroups']) ? ']]></search>
		<add><![CDATA[WHERE (id_group > {int:moderator_group} OR id_group = {int:global_mod_group})
			AND (forumid = {int:global_forumid} OR forumid = {int:forumid})' . (empty($modSettings['permission_enable_postgroups']) ? ']]></add>
	</operation>
	<operation>	<!-- line 569 -->
		<search position="after"><![CDATA['is_protected' => 1,
		)]]></search>
		<add><![CDATA['global_forumid' => -1,
			'forumid' => (int) $forumid,
			]]></add>
	</operation>
	<operation>	<!-- line 581 -->
		<search position="replace"><![CDATA[SELECT id_board, name, child_level
		FROM {db_prefix}boards
		ORDER BY board_order',]]></search>
		<add><![CDATA[SELECT b.id_board, b.name, b.child_level, c.forumid
		FROM {db_prefix}boards AS b
			LEFT JOIN {db_prefix}categories AS c ON (c.id_cat = b.id_cat)
		ORDER BY c.forumid, b.board_order',]]></add>
	</operation>
	<operation>	<!-- line 593 -->
		<search position="before"><![CDATA['selected' => false]]></search>
		<add><![CDATA[,
			'forumid' => $row['forumid']]]></add>
	</operation>

	<!-- EditMembergroup function -->
	<operation>	<!-- line 615 -->
		<search position="before"><![CDATA[function EditMembergroup()
{
	global $context, $txt, $sourcedir, $modSettings, $smcFunc]]></search>
		<add><![CDATA[, $subforum_tree, $forumid]]></add>
	</operation>
	<operation>	<!-- line 619 -->
		<search position="after"><![CDATA[// Make sure this group is editable.]]></search>
		<add><![CDATA[// Restrict user to editing current subforum ONLY if we are in a subforum:
	if (!empty($forumid))
		$subforum_tree = array($forumid => $subforum_tree[$forumid]);

	]]></add>
	</operation>
	<operation>	<!-- line 625 -->
		<search position="replace"><![CDATA[WHERE id_group = {int:current_group}' . (allowedTo('admin_forum') ? '' : ']]></search>
		<add><![CDATA[WHERE id_group = {int:current_group}
				AND (forumid = {int:global_forumid} OR forumid = {int:forumid})' . (allowedTo('admin_forum') ? '' : ']]></add>
	</operation>
	<operation>	<!-- line 630 -->
		<search position="before"><![CDATA['is_protected' => 1,
				'limit' => 1,]]></search>
		<add><![CDATA[
				'global_forumid' => -1,
				'forumid' => (int) $forumid,]]></add>
	</operation>
	<operation>	<!-- line 759 -->
		<search position="replace"><![CDATA[UPDATE {db_prefix}members
				SET id_group = {int:regular_member}
				WHERE id_group = {int:current_group}',
				array(]]></search>
		<add><![CDATA[UPDATE {db_prefix}primary_membergroups
				SET id_group = {int:regular_member}
				WHERE id_group = {int:current_group} AND forumid={int:forumid}',
				array(
					'forumid' => (int) $forumid,]]></add>
	</operation>
	<operation>	<!-- line 790 -->
		<search position="replace"><![CDATA[SELECT id_member, additional_groups
					FROM {db_prefix}members
					WHERE id_group = {int:current_group}
						AND FIND_IN_SET({int:current_group}, additional_groups) = 0',
					array(]]></search>
		<add><![CDATA[SELECT mem.id_member, mem.additional_groups
					FROM {db_prefix}members mem
						LEFT JOIN smf_primary_membergroups AS pm ON (pm.forumid = {int:forumid} AND pm.id_member = mem.id_member)
					WHERE pm.id_group = {int:current_group}
						AND FIND_IN_SET({int:current_group}, mem.additional_groups) = 0',
					array(
						'forumid' => (int) $forumid,]]></add>
	</operation>
	<operation>	<!-- line 807 -->
		<search position="replace"><![CDATA[UPDATE {db_prefix}members
					SET id_group = {int:regular_member}
					WHERE id_group = {int:current_group}',
					array(]]></search>
		<add><![CDATA[UPDATE {db_prefix}primary_membergroups
					SET id_group = {int:regular_member}
					WHERE id_group = {int:current_group} AND forumid={int:forumid}',
					array(
						'forumid' => (int) $forumid,]]></add>
	</operation>
	<operation>	<!-- line 999 -->
		<search position="replace"><![CDATA[SELECT id_board, name, child_level, FIND_IN_SET({string:current_group}, member_groups) != 0 AS can_access
			FROM {db_prefix}boards
			ORDER BY board_order',]]></search>
		<add><![CDATA[SELECT b.id_board, b.name, b.child_level, FIND_IN_SET({string:current_group}, b.member_groups) != 0 AS can_access, c.forumid
			FROM {db_prefix}boards AS b
				LEFT JOIN {db_prefix}categories AS c ON (c.id_cat = b.id_cat)
			ORDER BY c.forumid, b.board_order',]]></add>
	</operation>
	<operation>	<!-- line 1011 -->
		<search position="before"><![CDATA['selected' => !(empty($row['can_access']) || $row['can_access'] == 'f'),]]></search>
		<add><![CDATA[
				'forumid' => $row['forumid'],]]></add>
	</operation>
	<operation>	<!-- line 1025 -->
		<search position="replace"><![CDATA[AND id_parent = {int:not_inherited}',
		array(]]></search>
		<add><![CDATA[AND id_parent = {int:not_inherited}
			AND (forumid = {int:global_forumid} OR forumid = {int:forumid})',
		array(
			'global_forumid' => -1,
			'forumid' => (int) $forumid,]]></add>
	</operation>
</file>
<file name="$sourcedir/ManageMembers.php">
	<!-- ViewMemberlist function -->
	<operation>	<!-- line 174 -->
		<search position="before"><![CDATA[global $txt, $scripturl, $context, $modSettings, $sourcedir, $smcFunc, $user_info]]></search>
		<add><![CDATA[, $forumid]]></add>
	</operation>
	<operation>	<!-- line 220 -->
		<search position="replace"><![CDATA[WHERE id_group != {int:moderator_group}
			ORDER BY min_posts, CASE WHEN id_group < {int:newbie_group} THEN id_group ELSE 4 END, group_name',
			array(]]></search>
		<add><![CDATA[WHERE id_group != {int:moderator_group}
				AND (forumid = {int:global_forumid} OR forumid = {int:forumid}
			ORDER BY min_posts, CASE WHEN id_group < {int:newbie_group} THEN id_group ELSE 4 END, group_name',
			array(
				'global_forumid' => -1,
				'forumid' => (int) $forumid,]]></add>
	</operation>
	<operation>	<!-- line 400 -->
		<search position="replace"><![CDATA[$mg_query_parts[] = 'mem.id_group IN ({array_int:group_check})';]]></search>
		<add><![CDATA[$mg_query_parts[] = 'pm.id_group IN ({array_int:group_check})';]]></add>
	</operation>

	<!-- SearchMembers function -->
	<operation>	<!-- line 638 -->
		<search position="before"><![CDATA[global $context, $txt, $smcFunc]]></search>
		<add><![CDATA[, $forumid]]></add>
	</operation>
	<operation>	<!-- line 656 -->
		<search position="replace"><![CDATA[ORDER BY min_posts, CASE WHEN id_group < {int:newbie_group} THEN id_group ELSE 4 END, group_name',
		array(]]></search>
		<add><![CDATA[	AND (forumid = {int:global_forumid} OR forumid = {int:forumid})
		ORDER BY min_posts, CASE WHEN id_group < {int:newbie_group} THEN id_group ELSE 4 END, group_name',
		array(
			'global_forumid' => -1,
			'forumid' => (int) $forumid,]]></add>
	</operation>
</file>
<file name="$sourcedir/ManageNews.php">
	<!-- EditNews function -->
	<operation>	<!-- line 113 -->
		<search position="before"><![CDATA[global $txt, $modSettings, $context, $sourcedir, $user_info]]></search>
		<add><![CDATA[, $forumid]]></add>
	</operation>
	<operation>	<!-- line 118 -->
		<search position="before"><![CDATA[require_once($sourcedir . '/Subs-Post.php');]]></search>
		<add><![CDATA[
	$tmp = (empty($forumid) ? '' : $forumid);]]></add>
	</operation>
	<operation>	<!-- line 126 -->
		<search position="before"><![CDATA[$temp_news = explode("\n", $modSettings['news']]></search>
		<add><![CDATA[ . $tmp]]></add>
	</operation>
	<operation>	<!-- line 134 -->
		<search position="replace"><![CDATA[updateSettings(array('news' => implode("\n", $temp_news)));]]></search>
		<add><![CDATA[updateSettings(array('news' . $tmp => implode("\n", $temp_news)));]]></add>
	</operation>
	<operation>	<!-- line 155 -->
		<search position="replace"><![CDATA[updateSettings(array('news' => implode("\n", $_POST['news'])));]]></search>
		<add><![CDATA[updateSettings(array('news' . $tmp => implode("\n", $_POST['news'])));]]></add>
	</operation>
	<operation>	<!-- line 162 -->
		<search position="replace"><![CDATA[foreach (explode("\n", $modSettings['news']) as $id => $line)]]></search>
		<add><![CDATA[foreach (explode("\n", $modSettings['news' . $tmp]) as $id => $line)]]></add>
	</operation>

	<!-- SelectMailingMembers function -->
	<operation>	<!-- line 175 -->
		<search position="before"><![CDATA[global $txt, $context, $modSettings, $smcFunc]]></search>
		<add><![CDATA[, $forumid]]></add>
	</operation>
	<operation> <!-- line 199 -->
		<search position="replace"><![CDATA[FROM {db_prefix}membergroups AS mg' . (empty($modSettings['permission_enable_postgroups']) ? '
		WHERE mg.min_posts = {int:min_posts}' : '') . '
		GROUP BY mg.id_group, mg.min_posts, mg.group_name
		ORDER BY mg.min_posts, CASE WHEN mg.id_group < {int:newbie_group} THEN mg.id_group ELSE 4 END, mg.group_name',
		array(]]></search>
		<add><![CDATA[FROM {db_prefix}membergroups AS mg
			WHERE mg.forumid IN ({int:global_forumid}, {int:forumid}) ' . (empty($modSettings['permission_enable_postgroups']) ? '
			AND mg.min_posts = {int:min_posts}' : '') . '
		GROUP BY mg.id_group, mg.min_posts, mg.group_name
		ORDER BY mg.min_posts, CASE WHEN mg.id_group < {int:newbie_group} THEN mg.id_group ELSE 4 END, mg.group_name',
		array(
			'global_forumid' => -1,
			'forumid' => (int) $forumid,]]></add>
	</operation>
	<operation>	<!-- line 244 -->
		<search position="replace"><![CDATA[SELECT id_group, COUNT(*) AS member_count
			FROM {db_prefix}members
			WHERE id_group IN ({array_int:normal_group_list})
			GROUP BY id_group',
			array(]]></search>
		<add><![CDATA[SELECT COALESCE (pm.id_group, 0), COUNT(*) AS member_count
			FROM {db_prefix}members
				LEFT JOIN smf_primary_membergroups AS pm ON (pm.forumid = {int:forumid} AND pm.id_member = mem.id_member)
			WHERE id_group IN ({array_int:normal_group_list})
			GROUP BY pm.id_group',
			array(
				'forumid' => (int) $forumid,]]></add>
	</operation>
	<operation>	<!-- line 256 -->
		<search position="after"><![CDATA[// Also do those who have it as an additional membergroup - this ones more yucky...]]></search>
		<add><![CDATA[// We need to disable query checks for this next operation:
		if (isset($modSettings['disableQueryCheck']))
			$tmp = $modSettings['disableQueryCheck'];
		$modSettings['disableQueryCheck'] = true;

		]]></add>
	</operation>
	<operation>	<!-- line 260 -->
		<search position="replace"><![CDATA[INNER JOIN {db_prefix}members AS mem ON (mem.additional_groups != {string:blank_string}
					AND mem.id_group != mg.id_group
					AND FIND_IN_SET(mg.id_group, mem.additional_groups) != 0)
			WHERE mg.id_group IN ({array_int:normal_group_list})
			GROUP BY mg.id_group',
			array(
				'normal_group_list' => $normalGroups,
				'blank_string' => '',
			)]]></search>
		<add><![CDATA[INNER JOIN (SELECT mem.additional_groups, pm.id_group
					FROM smf_members AS mem
						LEFT JOIN smf_primary_membergroups pm ON (pm.id_member = mem.id_member AND pm.forumid = {int:forumid})
					) AS pmem ON (pmem.additional_groups != {string:blank_string}
					AND pmem.id_group != mg.id_group
					AND FIND_IN_SET(mg.id_group, pmem.additional_groups) != 0)
			WHERE mg.id_group IN ({array_int:normal_group_list})
			GROUP BY mg.id_group',
			array(
				'normal_group_list' => $normalGroups,
				'blank_string' => '',
				'forumid' => (int) $forumid,
			)]]></add>
	</operation>
	<operation>	<!-- line 278 -->
		<search position="after"><![CDATA[	}

	// Any moderators?]]></search>
		<add><![CDATA[
		// Restore query checks to previous status:
		if (isset($tmp))
			$modSettings['disableQueryCheck'] = $tmp;
]]></add>
	</operation>

	<!-- SendMailing function -->
	<operation>	<!-- line 642 -->
		<search position="replace"><![CDATA[$queryBuild[] = 'mem.id_group = {int:group_' . $group . '}';]]></search>
		<add><![CDATA[$queryBuild[] = 'mem.id_group = {int:group_' . $group . '}'; // TODO: Uh...]]></add>
	</operation>
	<operation>	<!-- line 666 -->
		<search position="replace"><![CDATA[$sendQuery .= ' AND mem.id_group != {int:regular_group}';]]></search>
		<add><![CDATA[$sendQuery .= ' AND mem.id_group != {int:regular_group}'; // TODO: -sigh-]]></add>
	</operation>
</file>
<file name="$sourcedir/ManagePaid.php">
	<!-- ModifySubscription function -->
	<operation>	<!-- line 363 -->
		<search position="before"><![CDATA[function ModifySubscription()
{
	global $context, $txt, $modSettings, $smcFunc]]></search>
		<add><![CDATA[, $forumid]]></add>
	</operation>
	<operation>	<!-- line -->
		<search position="replace"><![CDATA[WHERE id_group != {int:moderator_group}
			AND min_posts = {int:min_posts}',
		array(]]></search>
		<add><![CDATA[WHERE id_group != {int:moderator_group}
			AND min_posts = {int:min_posts}
			AND (forumid = {int:global_forumid} OR forumid = {int:forumid})',
		array(
			'global_forumid' => -1,
			'forumid' => (int) $forumid,]]></add>
	</operation>

	<!-- ModifyUserSubscription function -->
	<operation> <!-- line 869 -->
		<search position="before"><![CDATA[function ModifyUserSubscription()
{
	global $context, $txt, $modSettings, $smcFunc]]></search>
		<add><![CDATA[, $forumid]]></add>
	</operation>
	<operation>	<!-- line 924 -->
		<search position="replace"><![CDATA[SELECT id_member, id_group
				FROM {db_prefix}members
				WHERE real_name = {string:name}
				LIMIT 1',
				array(]]></search>
		<add><![CDATA[SELECT mem.id_member, COALESCE(pm.id_group, 0) AS id_group
				FROM {db_prefix}members
					LEFT JOIN smf_primary_membergroups AS pm ON (pm.forumid = {int:forumid} AND pm.id_member = mem.id_member)
				WHERE real_name = {string:name}
				LIMIT 1',
				array(
					'forumid' => (int) $forumid,]]></add>
	</operation>

	<!-- reapplySubscriptions function -->
	<operation>	<!-- line 1199 -->
		<search position="before"><![CDATA[function reapplySubscriptions($users)
{
	global $smcFunc]]></search>
		<add><![CDATA[, $forumid]]></add>
	</operation>
	<operation>	<!-- line 1208 -->
		<search position="replace"><![CDATA[SELECT id_member, id_group, additional_groups
		FROM {db_prefix}members
		WHERE id_member IN ({array_int:user_list})',
		array(]]></search>
		<add><![CDATA[SELECT id_member, COALESCE(pm.id_group, 0) AS id_group, additional_groups
		FROM {db_prefix}members
			LEFT JOIN {db_prefix}primary_membergroups AS pm ON (pm.forumid = {int:forumid} AND pm.id_member = mem.id_member)
		WHERE id_member IN ({array_int:user_list})',
		array(
			'forumid' => (int) $forumid,]]></add>
	</operation>
	<operation>	<!-- line 1261 -->
		<search position="replace"><![CDATA[$smcFunc['db_query']('', '
			UPDATE {db_prefix}members
			SET id_group = {int:primary_group}, additional_groups = {string:additional_groups}
			WHERE id_member = {int:current_member}
			LIMIT 1',
			array(
				'primary_group' => $group['primary'],]]></search>
		<add><![CDATA[$smcFunc['db_query']('', '
			REPLACE INTO {db_prefix}primary_membergroups (forumid, id_member, id_group)
			VALUES ({int:forumid}, {int:current_member}, {int:primary_group})',
			array(
				'primary_group' => $group['primary'],
				'current_member' => $id,
				'forumid' => (int) $forumid,
			)
		);

		$smcFunc['db_query']('', '
			UPDATE {db_prefix}members
			SET additional_groups = {string:additional_groups}
			WHERE id_member = {int:current_member}
			LIMIT 1',
			array(]]></add>
	</operation>

	<!-- addSubscription function -->
	<operation>	<!-- line 1276 -->
		<search position="before"><![CDATA[function addSubscription($id_subscribe, $id_member, $renewal = 0, $forceStartTime = 0, $forceEndTime = 0)
{
	global $context, $smcFunc]]></search>
		<add><![CDATA[, $forumid]]></add>
	</operation>
	<operation>	<!-- line 1361 -->
		<search position="replace"><![CDATA[SELECT m.id_group, m.additional_groups
		FROM {db_prefix}members AS m
		WHERE m.id_member = {int:current_member}',
		array(]]></search>
		<add><![CDATA[SELECT COALESCE(pm.id_group, 0) AS id_group, m.additional_groups
		FROM {db_prefix}members AS m
			LEFT JOIN {db_prefix}primary_membergroups AS pm ON (pm.id_member = m.id_member AND pm.forumid = {int:forumid})
		WHERE m.id_member = {int:current_member}',
		array(
			'forumid' => (int) $forumid,]]></add>
	</operation>
	<operation>	<!-- line 1402 -->
		<search position="replace"><![CDATA[UPDATE {db_prefix}members
		SET id_group = {int:primary_group}, additional_groups = {string:additional_groups}
		WHERE id_member = {int:current_member}',
		array(
			'primary_group' => $id_group,
			'current_member' => $id_member,
			'additional_groups' => $newAddGroups,
		)
	);]]></search>
		<add><![CDATA[UPDATE {db_prefix}members
		SET additional_groups = {string:additional_groups}
		WHERE id_member = {int:current_member}',
		array(
			'current_member' => $id_member,
			'additional_groups' => $newAddGroups,
		)
	);
	$smcFunc['db_query']('', '
		REPLACE INTO {db_prefix}primary_membergroups (forumid, id_member, id_group)
		VALUES ({int:forumid}, {int:current_member}, {int:primary_group})',
		array(
			'primary_group' => $id_group,
			'current_member' => $id_member,
			'forumid' => (int) $forumid,
		)
	);]]></add>
	</operation>

	<!-- removeSubscription function -->
	<operation>	<!-- line 1487 -->
		<search position="before"><![CDATA[function removeSubscription($id_subscribe, $id_member, $delete = false)
{
	global $context, $smcFunc]]></search>
		<add><![CDATA[, $forumid]]></add>
	</operation>
	<operation>	<!-- line 1493 -->
		<search position="replace"><![CDATA[SELECT m.id_group, m.additional_groups
		FROM {db_prefix}members AS m
		WHERE m.id_member = {int:current_member}',
		array(]]></search>
		<add><![CDATA[SELECT COALESCE(pm.id_group, 0) AS id_group, m.additional_groups
		FROM {db_prefix}members AS m
			LEFT JOIN {db_prefix}primary_membergroups AS pm ON (pm.id_member = m.id_member AND pm.forumid = {int:forumid})
		WHERE m.id_member = {int:current_member}',
		array(
			'forumid' => (int) $forumid,]]></add>
	</operation>
	<operation>	<!-- line 1602 -->
		<search position="after"><![CDATA[
	// Disable the subscription.]]></search>
		<add><![CDATA[	if ($id_group == 0)
	{
		// Delete the entry
		$smcFunc['db_query']('', '
		DELETE FROM {db_prefix}primary_membergroups
		WHERE id_member = {int:current_member} AND forumid={int:forumid}',
			array(
				'current_member' => $id_member,
				'forumid' => (int) $forumid,
			)
		);
	}
	else
	{
		// Update the entry
		$smcFunc['db_query']('', '
		REPLACE INTO {db_prefix}primary_membergroups (forumid, id_member, id_group)
		VALUES ({int:forumid}, {int:current_member}, {int:primary_group})',
			array(
				'primary_group' => $id_group,
				'current_member' => $id_member,
				'forumid' => (int) $forumid,
			)
		);
	}
]]></add>
	</operation>
</file>
<file name="$sourcedir/ManagePermissions.php">
	<!-- PermissionIndex function -->
	<operation>	<!-- line 137 -->
		<search position="before"><![CDATA[global $txt, $scripturl, $context, $settings, $modSettings, $smcFunc]]></search>
		<add><![CDATA[, $forumid]]></add>
	</operation>
	<operation>	<!-- line 156 -->
		<search position="replace"><![CDATA[SELECT COUNT(*)
		FROM {db_prefix}members]]></search>
		<add><![CDATA[SELECT COUNT(*)
		FROM {db_prefix}primary_membergroups]]></add>
	</operation>
	<operation>	<!-- line 213 -->
		<search position="replace"><![CDATA[SELECT id_group, id_parent, group_name, min_posts, online_color, stars
		FROM {db_prefix}membergroups' . (empty($modSettings['permission_enable_postgroups']) ? '
		WHERE min_posts = {int:min_posts}' : '') . '
		ORDER BY id_parent = {int:not_inherited} DESC, min_posts, CASE WHEN id_group < {int:newbie_group} THEN id_group ELSE 4 END, group_name',
		array(]]></search>
		<add><![CDATA[SELECT id_group, id_parent, group_name, min_posts, online_color, stars
		FROM {db_prefix}membergroups
		WHERE forumid IN({int:global_forumid}, {int:forumid})' . (empty($modSettings['permission_enable_postgroups']) ? '
			AND min_posts = {int:min_posts}' : '') . '
		ORDER BY id_parent = {int:not_inherited} DESC, min_posts, CASE WHEN id_group < {int:newbie_group} THEN id_group ELSE 4 END, group_name',
		array(
			'global_forumid' => -1,
			'forumid' => (int) $forumid,]]></add>
	</operation>
	<operation>	<!-- line 281 -->
		<search position="replace"><![CDATA[SELECT id_group, COUNT(*) AS num_members
			FROM {db_prefix}members
			WHERE id_group IN ({array_int:normal_group_list})
			GROUP BY id_group',]]></search>
		<add><![CDATA[SELECT id_group, COUNT(*) AS num_members
			FROM {db_prefix}primary_membergroups
			WHERE id_group IN ({array_int:normal_group_list})
			GROUP BY id_group',]]></add>
	</operation>
	<operation>	<!-- line 293 -->
		<search position="after"><![CDATA[// This one is slower, but it's okay... careful not to count twice!]]></search>
		<add><![CDATA[// We need to disable query checks for this next operation:
		if (isset($modSettings['disableQueryCheck']))
			$tmp = $modSettings['disableQueryCheck'];
		$modSettings['disableQueryCheck'] = true;

		]]></add>
	</operation>
	<operation>	<!-- line 294 -->
		<search position="replace"><![CDATA[$query = $smcFunc['db_query']('', '
			SELECT mg.id_group, COUNT(*) AS num_members
			FROM {db_prefix}membergroups AS mg
				INNER JOIN {db_prefix}members AS mem ON (mem.additional_groups != {string:blank_string}
					AND mem.id_group != mg.id_group
					AND FIND_IN_SET(mg.id_group, mem.additional_groups) != 0)
			WHERE mg.id_group IN ({array_int:normal_group_list})
			GROUP BY mg.id_group',
			array(
				'normal_group_list' => $normalGroups,
				'blank_string' => '',
			)
		);]]></search>
		<add><![CDATA[$query = $smcFunc['db_query']('', '
			SELECT mg.id_group, COUNT(*) AS num_members
			FROM {db_prefix}membergroups AS mg
				INNER JOIN (SELECT mem.additional_groups, pm.id_group
					FROM smf_members AS mem
						LEFT JOIN smf_primary_membergroups pm ON (pm.id_member = mem.id_member AND pm.forumid = {int:forumid})
					) AS pmem ON (pmem.additional_groups != {string:blank_string}
					AND pmem.id_group != mg.id_group
					AND FIND_IN_SET(mg.id_group, pmem.additional_groups) != 0)
			WHERE mg.id_group IN ({array_int:normal_group_list})
			GROUP BY mg.id_group',
			array(
				'normal_group_list' => $normalGroups,
				'blank_string' => '',
				'forumid' => (int) $forumid,
			)
		);]]></add>
	</operation>
	<operation>	<!-- line 315 -->
		<search position="after"><![CDATA[	}

	foreach ($context['groups'] as $id => $data)]]></search>
		<add><![CDATA[
		// Restore query checks to previous status:
		if (isset($tmp))
			$modSettings['disableQueryCheck'] = $tmp;
]]></add>
	</operation>

	<!-- PermissionByBoard function -->
	<operation>	<!-- line 394 -->
		<search position="before"><![CDATA[global $context, $modSettings, $txt, $smcFunc, $sourcedir, $cat_tree, $boardList, $boards]]></search>
		<add><![CDATA[, $forumid]]></add>
	</operation>
	<operation>	<!-- line 433 -->
		<search position="replace"><![CDATA[getBoardTree();

	// Build the list of the boards.
	$context['categories'] = array();
	foreach ($cat_tree as $catid => $tree)
	{
		$context['categories'][$catid] = array(]]></search>
		<add><![CDATA[getBoardTree( ($forumid == 0 ? -1 : $forumid) );

	// Build the list of the boards.
	$context['categories'] = array();
	foreach ($cat_tree as $catid => $tree)
	{
		$id = $cat_tree[$catid]['node']['forumid'];
		$context['categories'][$id][$catid] = array(]]></add>
	</operation>
	<operation>	<!-- line 449 -->
		<search position="replace"><![CDATA[$context['categories'][$catid]['boards'][$boardid] = array(]]></search>
		<add><![CDATA[$context['categories'][$id][$catid]['boards'][$boardid] = array(]]></add>
	</operation>

	<!-- GeneralPermissionSettings function -->
	<operation>	<!-- line 990 -->
		<search position="before"><![CDATA[global $context, $modSettings, $sourcedir, $txt, $scripturl, $smcFunc]]></search>
		<add><![CDATA[, $forumid]]></add>
	</operation>
	<operation>	<!-- line 1051 -->
		<search position="replace"><![CDATA[WHERE min_posts != {int:min_posts}',
				array(
					'min_posts' => -1,
				)
			);]]></search>
		<add><![CDATA[WHERE min_posts != {int:min_posts}
					AND forumid IN ({int:global_forumid}, int:forumid})',
				array(
					'min_posts' => -1,
					'global_forumid' => -1,
					'forumid' => (int) $forumid,
				)
			);]]></add>
	</operation>

	<!-- init_inline_permissions function -->
	<operation>	<!-- line 1702 -->
		<search position="before"><![CDATA[function init_inline_permissions($permissions, $excluded_groups = array())
{
	global $context, $txt, $modSettings, $smcFunc]]></search>
		<add><![CDATA[, $forumid]]></add>
	</operation>
	<operation>	<!-- line 1746 -->
		<search position="replace"><![CDATA[SELECT mg.id_group, mg.group_name, mg.min_posts, IFNULL(p.add_deny, -1) AS status, p.permission
		FROM {db_prefix}membergroups AS mg
			LEFT JOIN {db_prefix}permissions AS p ON (p.id_group = mg.id_group AND p.permission IN ({array_string:permissions}))
		WHERE mg.id_group NOT IN (1, 3)
			AND mg.id_parent = {int:not_inherited}' . (empty($modSettings['permission_enable_postgroups']) ? '
			AND mg.min_posts = {int:min_posts}' : '') . '
		ORDER BY mg.min_posts, CASE WHEN mg.id_group < {int:newbie_group} THEN mg.id_group ELSE 4 END, mg.group_name',
		array(]]></search>
		<add><![CDATA[SELECT mg.id_group, mg.group_name, mg.min_posts, IFNULL(p.add_deny, -1) AS status, p.permission
		FROM {db_prefix}membergroups AS mg
			LEFT JOIN {db_prefix}permissions AS p ON (p.id_group = mg.id_group AND p.permission IN ({array_string:permissions}))
		WHERE mg.id_group NOT IN (1, 3)
			AND mg.forumid IN ({int:global_forumid}, {int:forumid})
			AND mg.id_parent = {int:not_inherited}' . (empty($modSettings['permission_enable_postgroups']) ? '
			AND mg.min_posts = {int:min_posts}' : '') . '
		ORDER BY mg.min_posts, CASE WHEN mg.id_group < {int:newbie_group} THEN mg.id_group ELSE 4 END, mg.group_name',
		array(
			'global_forumid' => -1,
			'forumid' => (int) $forumid,]]></add>
	</operation>

	<!-- ModifyPostModeration function -->
	<operation>	<!-- line 2206 -->
		<search position="before"><![CDATA[global $context, $txt, $smcFunc, $modSettings]]></search>
		<add><![CDATA[, $forumid]]></add>
	</operation>
	<operation>	<!-- line 2252 -->
		<search position="replace"><![CDATA[SELECT id_group, group_name, online_color, id_parent
		FROM {db_prefix}membergroups
		WHERE id_group != {int:admin_group}
			' . (empty($modSettings['permission_enable_postgroups']) ? ' AND min_posts = {int:min_posts}' : '') . '
		ORDER BY id_parent ASC',
		array(]]></search>
		<add><![CDATA[SELECT id_group, group_name, online_color, id_parent
		FROM {db_prefix}membergroups
		WHERE id_group != {int:admin_group}
			AND forumid IN ({int:global_forumid}, {int:forumid})
			' . (empty($modSettings['permission_enable_postgroups']) ? ' AND min_posts = {int:min_posts}' : '') . '
		ORDER BY id_parent ASC',
		array(
			'global_forumid' => -1,
			'forumid' => (int) $forumid,]]></add>
	</operation>
</file>
<file name="$sourcedir/ManageRegistration.php">
	<!-- AdminRegister function -->
	<operation>	<!-- line 107 -->
		<search position="before"><![CDATA[global $txt, $context, $sourcedir, $scripturl, $smcFunc]]></search>
		<add><![CDATA[, $forumid]]></add>
	</operation>
	<operation>	<!-- line 161 -->
		<search position="replace"><![CDATA[AND hidden != {int:hidden_group}
			ORDER BY min_posts, CASE WHEN id_group < {int:newbie_group} THEN id_group ELSE 4 END, group_name',
			array(]]></search>
		<add><![CDATA[AND hidden != {int:hidden_group}
				AND forumid IN({int:global_forumid}, {int:forumid})
			ORDER BY min_posts, CASE WHEN id_group < {int:newbie_group} THEN id_group ELSE 4 END, group_name',
			array(
				'global_forumid' => -1,
				'forumid' => (int) $forumid,]]></add>
	</operation>

	<!-- EditAgreement function -->
	<operation>	<!-- line 184 -->
		<search position="before"><![CDATA[global $txt, $boarddir, $context, $modSettings, $smcFunc, $settings]]></search>
		<add><![CDATA[, $forumid]]></add>
	</operation>
	<operation>	<!-- line 197 -->
		<search position="replace"><![CDATA[// Try to figure out if we have more agreements.
	foreach ($context['languages'] as $lang)
	{
		if (file_exists($boarddir . '/agreement.' . $lang['filename'] . '.txt'))]]></search>
		<add><![CDATA[// Try to figure out if we have more agreements.
	$agree = 'agreement' . ($forumid == 0 ? '' : '.forum' . $forumid);
	foreach ($context['languages'] as $lang)
	{
		if (file_exists($boarddir . '/' . $agree . $lang['filename'] . '.txt'))]]></add>
	</operation>
	<operation>	<!-- line 214 -->
		<search position="replace"><![CDATA[$fp = fopen($boarddir . '/agreement' . $context['current_agreement'] . '.txt', 'w');]]></search>
		<add><![CDATA[$fp = fopen($boarddir . '/' . $agree . $context['current_agreement'] . '.txt', 'w');]]></add>
	</operation>
	<operation>	<!-- line 221 -->
		<search position="replace"><![CDATA[$context['agreement'] = file_exists($boarddir . '/agreement' . $context['current_agreement'] . '.txt') ? htmlspecialchars(file_get_contents($boarddir . '/agreement' . $context['current_agreement'] . '.txt')) : '';
	$context['warning'] = is_writable($boarddir . '/agreement' . $context['current_agreement'] . '.txt') ? '' : $txt['agreement_not_writable'];]]></search>
		<add><![CDATA[$context['agreement'] = file_exists($boarddir . '/' . $agree . $context['current_agreement'] . '.txt') ? htmlspecialchars(file_get_contents($boarddir . '/' . $agree . $context['current_agreement'] . '.txt')) : '';
	$context['warning'] = is_writable($boarddir . '/' . $agree . $context['current_agreement'] . '.txt') ? '' : $txt['agreement_not_writable'];]]></add>
	</operation>

	<!-- ModifyRegistrationSettings function -->
	<operation>	<!-- line 266 -->
		<search position="before"><![CDATA[global $txt, $context, $scripturl, $modSettings, $sourcedir]]></search>
		<add><![CDATA[, $smcFunc, $forumid]]></add>
	</operation>
	<operation>	<!-- line 271 -->
		<search position="after"><![CDATA[$config_vars = array(
			array('select', 'registration_method', array($txt['setting_registration_standard'], $txt['setting_registration_activate'], $txt['setting_registration_approval'], $txt['setting_registration_disabled'])),]]></search>
		<add><![CDATA[// Build an array for the membergroup list:
    loadLanguage('Profile');
	$group_list = array($txt['admin_register_group_none']);
	$request = $smcFunc['db_query']('', '
		SELECT group_name, id_group, min_posts
		FROM {db_prefix}membergroups
		WHERE id_group > {int:moderator_group}
			AND forumid IN ({int:global_forumid}, {int:forumid})
		ORDER BY min_posts, group_name',
		array(
			'moderator_group' => 3,
			'global_forumid' => -1,
			'forumid' => (int) $forumid,
		)
	);
    while ($row = $smcFunc['db_fetch_assoc']($request))
		if ($row['min_posts'] != -1) $group_list[$row['id_group']] = $row['group_name'];
    $smcFunc['db_free_result']($request);

	]]></add>
	</operation>
	<operation>	<!-- line 275 -->
		<search position="before"><![CDATA[array('check', 'send_welcomeEmail'),]]></search>
		<add><![CDATA[
			array('select', 'primary_membergroup', $group_list),]]></add>
	</operation>
</file>
<file name="$sourcedir/ManageServer.php">
	<!-- ModifyDatabaseSettings function -->
	<operation>	<!-- line 247 -->
		<search position="before"><![CDATA[array('cachedir', $txt['cachedir'], 'file', 'text', 36),]]></search>
		<add><![CDATA[
		array('favicon', $txt['favicon'], 'file', 'text', 36),]]></add>
	</operation>

	<!-- saveSettings function -->
	<operation>	<!-- line 1972 -->
		<search position="before"><![CDATA['boarddir', 'sourcedir', 'cachedir',]]></search>
		<add><![CDATA[ 'favicon',]]></add>
	</operation>
</file>
<file name="$sourcedir/ManageSettings.php">
	<!-- ModifySignatureSettings function -->
	<operation>	<!-- line 901 -->
		<search position="before"><![CDATA[global $context, $txt, $modSettings, $sig_start, $smcFunc, $helptxt, $scripturl]]></search>
		<add><![CDATA[, $forumid]]></add>
	</operation>
	<operation>	<!-- line 962 -->
		<search position="replace"><![CDATA[SELECT id_member, signature
				FROM {db_prefix}members
				WHERE id_member BETWEEN ' . $_GET['step'] . ' AND ' . $_GET['step'] . ' + 49
					AND id_group != {int:admin_group}
					AND FIND_IN_SET({int:admin_group}, additional_groups) = 0',
				array(]]></search>
		<add><![CDATA[SELECT mem.id_member, mem.signature
				FROM {db_prefix}members mem
					LEFT JOIN smf_primary_membergroups AS pm ON (pm.forumid = {int:forumid} AND pm.id_member = mem.id_member)
				WHERE mem.id_member BETWEEN ' . $_GET['step'] . ' AND ' . $_GET['step'] . ' + 49
					AND pm.id_group != {int:admin_group}
					AND FIND_IN_SET({int:admin_group}, mem.additional_groups) = 0',
				array(
					'forumid' => (int) $forumid,]]></add>
	</operation>
</file>
<file name="$sourcedir/Memberlist.php">
	<!-- MLAll function -->
	<operation>	<!-- line 161 -->
		<search position="before"><![CDATA[global $modSettings, $context, $smcFunc]]></search>
		<add><![CDATA[, $forumid]]></add>
	</operation>
	<operation>	<!-- line 342 -->
		<search position="before"><![CDATA['sort' => $sort_methods[$_REQUEST['sort']][$context['sort_direction']],]]></search>
		<add><![CDATA[
		'forumid' => (int) $forumid,]]></add>
	</operation>
	<operation>	<!-- line 373 -->
		<search position="replace"><![CDATA[SELECT mem.id_member
		FROM {db_prefix}members AS mem' . ($_REQUEST['sort'] === 'is_online' ? '
			LEFT JOIN {db_prefix}log_online AS lo ON (lo.id_member = mem.id_member)' : '') . ($_REQUEST['sort'] === 'id_group' ? '
			LEFT JOIN {db_prefix}membergroups AS mg ON (mg.id_group = CASE WHEN mem.id_group = {int:regular_id_group} THEN mem.id_post_group ELSE mem.id_group END)' : '') . '
		WHERE mem.is_activated = {int:is_activated}' . (empty($where) ? '' : ']]></search>
		<add><![CDATA[SELECT mem.id_member
		FROM {db_prefix}members AS mem
			LEFT JOIN {db_prefix}primary_membergroups AS pm ON (mem.id_member = pm.id_member AND forumid = {int:forumid})' . ($_REQUEST['sort'] === 'is_online' ? '
			LEFT JOIN {db_prefix}log_online AS lo ON (lo.id_member = mem.id_member)' : '') . ($_REQUEST['sort'] === 'id_group' ? '
			LEFT JOIN {db_prefix}membergroups AS mg ON (mg.id_group = CASE WHEN pm.id_group = {int:regular_id_group} THEN mem.id_post_group ELSE pm.id_group END)' : '') . '
		WHERE mem.is_activated = {int:is_activated}' . (empty($where) ? '' : ']]></add>
	</operation>

	<!-- MLSearch function -->
	<operation>	<!-- line 406 -->
		<search position="before"><![CDATA[global $txt, $scripturl, $context, $user_info, $modSettings, $smcFunc]]></search>
		<add><![CDATA[, $forumid]]></add>
	</operation>
	<operation>	<!-- line 468 -->
		<search position="before"><![CDATA['search' => '%' . strtr($smcFunc['htmlspecialchars']($_POST['search'], ENT_QUOTES), array('_' => '\\_', '%' => '\\%', '*' => '%')) . '%',]]></search>
		<add><![CDATA[
			'forumid' => (int) $forumid,]]></add>
	</operation>
	<operation>	<!-- line 531 -->
		<search position="replace"><![CDATA[FROM {db_prefix}members AS mem
				LEFT JOIN {db_prefix}membergroups AS mg ON (mg.id_group = CASE WHEN mem.id_group = {int:regular_id_group} THEN mem.id_post_group ELSE mem.id_group END)' .]]></search>
		<add><![CDATA[FROM {db_prefix}members AS mem
				LEFT JOIN {db_prefix}primary_membergroups AS pm ON (mem.id_member = pm.id_member AND forumid = {int:forumid})
				LEFT JOIN {db_prefix}membergroups AS mg ON (mg.id_group = CASE WHEN pm.id_group = {int:regular_id_group} THEN pm.id_post_group ELSE pm.id_group END)' .]]></add>
	</operation>
	<operation>	<!-- line 549 -->
		<search position="replace"><![CDATA[FROM {db_prefix}members AS mem
				LEFT JOIN {db_prefix}log_online AS lo ON (lo.id_member = mem.id_member)
				LEFT JOIN {db_prefix}membergroups AS mg ON (mg.id_group = CASE WHEN mem.id_group = {int:regular_id_group} THEN mem.id_post_group ELSE mem.id_group END)' .]]></search>
		<add><![CDATA[FROM {db_prefix}members AS mem
				LEFT JOIN {db_prefix}primary_membergroups AS pm ON (mem.id_member = pm.id_member AND forumid = {int:forumid})
				LEFT JOIN {db_prefix}log_online AS lo ON (lo.id_member = mem.id_member)
				LEFT JOIN {db_prefix}membergroups AS mg ON (mg.id_group = CASE WHEN pm.id_group = {int:regular_id_group} THEN mem.id_post_group ELSE pm.id_group END)' .]]></add>
	</operation>
</file>
<file name="$sourcedir/MessageIndex.php">
	<!-- MessageIndex function -->
	<operation>	<!-- line 32 -->
		<search position="before"><![CDATA[global $options, $settings, $board_info, $user_info, $smcFunc, $sourcedir]]></search>
		<add><![CDATA[, $forumid]]></add>
	</operation>
	<operation>	<!-- line 235 -->
		<search position="replace"><![CDATA[mg.online_color, mg.id_group, mg.group_name
			FROM {db_prefix}log_online AS lo
				LEFT JOIN {db_prefix}members AS mem ON (mem.id_member = lo.id_member)
				LEFT JOIN {db_prefix}membergroups AS mg ON (mg.id_group = CASE WHEN mem.id_group = {int:reg_member_group} THEN mem.id_post_group ELSE mem.id_group END)
			WHERE INSTR(lo.url, {string:in_url_string}) > 0 OR lo.session = {string:session}',
			array(]]></search>
		<add><![CDATA[mg.online_color, COALESCE(pm.id_group, 0) AS id_group, mg.group_name
			FROM {db_prefix}log_online AS lo
				LEFT JOIN {db_prefix}members AS mem ON (mem.id_member = lo.id_member)
				LEFT JOIN {db_prefix}primary_membergroups AS pm ON (mem.id_member = pm.id_member AND pm.forumid = {int:forumid})
				LEFT JOIN {db_prefix}membergroups AS mg ON (mg.id_group = CASE WHEN COALESCE(pm.id_group, 0) = {int:reg_member_group} THEN mem.id_post_group ELSE COALESCE(pm.id_group, 0) END)
			WHERE INSTR(lo.url, {string:in_url_string}) > 0 OR lo.session = {string:session}',
			array(
				'forumid' => (int) $forumid,]]></add>
	</operation>
</file>
<file name="$sourcedir/ModerationCenter.php">
	<!-- ModBlockGroupRequests function -->
	<operation>	<!-- line 476 -->
		<search position="before"><![CDATA[function ModBlockGroupRequests()
{
	global $context, $user_info, $scripturl, $smcFunc]]></search>
		<add><![CDATA[, $forumid]]></add>
	</operation>
	<operation>	<!-- line 491 -->
		<search position="replace"><![CDATA[WHERE ' . ($user_info['mod_cache']['gq'] == '1=1' || $user_info['mod_cache']['gq'] == '0=1' ? $user_info['mod_cache']['gq'] : 'lgr.' . $user_info['mod_cache']['gq']) . '
		ORDER BY lgr.id_request DESC
		LIMIT 10',
		array(
		)]]></search>
		<add><![CDATA[WHERE ' . ($user_info['mod_cache']['gq'] == '1=1' || $user_info['mod_cache']['gq'] == '0=1' ? $user_info['mod_cache']['gq'] : 'lgr.' . $user_info['mod_cache']['gq']) . '
			AND mg.forumid IN ({int:global_forumid}, {int:forumid})
		ORDER BY lgr.id_request DESC
		LIMIT 10',
		array(
			'global_forumid' => -1,
			'forumid' => (int) $forumid,
		)]]></add>
	</operation>
</file>
<file name="$sourcedir/Modlog.php">
	<!-- list_getModLogEntryCount function -->
	<operation>	<!-- line 308 -->
		<search position="before"><![CDATA[global $smcFunc, $user_info]]></search>
		<add><![CDATA[, $forumid]]></add>
	</operation>
	<operation>	<!-- line 313 -->
		<search position="replace"><![CDATA[SELECT COUNT(*)
		FROM {db_prefix}log_actions AS lm
			LEFT JOIN {db_prefix}members AS mem ON (mem.id_member = lm.id_member)
			LEFT JOIN {db_prefix}membergroups AS mg ON (mg.id_group = CASE WHEN mem.id_group = {int:reg_group_id} THEN mem.id_post_group ELSE mem.id_group END)
			LEFT JOIN {db_prefix}boards AS b ON (b.id_board = lm.id_board)
			LEFT JOIN {db_prefix}topics AS t ON (t.id_topic = lm.id_topic)
		WHERE id_log = {int:log_type}
			AND {raw:modlog_query}'
			. (!empty($query_string) ? '
				AND ' . $query_string : ''),
		array_merge($query_params, array(]]></search>
		<add><![CDATA[SELECT COUNT(*)
		FROM {db_prefix}log_actions AS lm
			LEFT JOIN {db_prefix}members AS mem ON (mem.id_member = lm.id_member)
			LEFT JOIN {db_prefix}primary_membergroups AS pm ON (mem.id_member = pm.id_member AND pm.forumid = {int:forumid})
			LEFT JOIN {db_prefix}membergroups AS mg ON (mg.id_group = CASE WHEN COALESCE(pm.id_group, 0) = {int:reg_group_id} THEN mem.id_post_group ELSE COALESCE(pm.id_group, 0) END)
			LEFT JOIN {db_prefix}boards AS b ON (b.id_board = lm.id_board)
			LEFT JOIN {db_prefix}topics AS t ON (t.id_topic = lm.id_topic)
		WHERE id_log = {int:log_type}
			AND {raw:modlog_query}'
			. (!empty($query_string) ? '
				AND ' . $query_string : ''),
		array_merge($query_params, array(
			'forumid' => (int) $forumid,]]></add>
	</operation>

	<!-- list_getModLogEntries function -->
	<operation>	<!-- line 337 -->
		<search position="before"><![CDATA[global $context, $scripturl, $txt, $smcFunc, $user_info]]></search>
		<add><![CDATA[, $forumid]]></add>
	</operation>
	<operation>	<!-- line 350 -->
		<search position="replace"><![CDATA[SELECT
			lm.id_action, lm.id_member, lm.ip, lm.log_time, lm.action, lm.id_board, lm.id_topic, lm.id_msg, lm.extra,
			mem.real_name, mg.group_name
		FROM {db_prefix}log_actions AS lm
			LEFT JOIN {db_prefix}members AS mem ON (mem.id_member = lm.id_member)
			LEFT JOIN {db_prefix}membergroups AS mg ON (mg.id_group = CASE WHEN mem.id_group = {int:reg_group_id} THEN mem.id_post_group ELSE mem.id_group END)
			LEFT JOIN {db_prefix}boards AS b ON (b.id_board = lm.id_board)
			LEFT JOIN {db_prefix}topics AS t ON (t.id_topic = lm.id_topic)
			WHERE id_log = {int:log_type}
				AND {raw:modlog_query}'
			. (!empty($query_string) ? '
				AND ' . $query_string : '') . '
		ORDER BY ' . $sort . '
		LIMIT ' . $start . ', ' . $items_per_page,
		array_merge($query_params, array(]]></search>
		<add><![CDATA[SELECT
			lm.id_action, lm.id_member, lm.ip, lm.log_time, lm.action, lm.id_board, lm.id_topic, lm.id_msg, lm.extra,
			mem.real_name, mg.group_name
		FROM {db_prefix}log_actions AS lm
			LEFT JOIN {db_prefix}members AS mem ON (mem.id_member = lm.id_member)
			LEFT JOIN {db_prefix}primary_membergroups AS pm ON (mem.id_member = pm.id_member AND pm.forumid = {int:forumid})
			LEFT JOIN {db_prefix}membergroups AS mg ON (mg.id_group = CASE WHEN COALESCE(pm.id_group, 0) = {int:reg_group_id} THEN mem.id_post_group ELSE COALESCE(pm.id_group, 0) END)
			LEFT JOIN {db_prefix}boards AS b ON (b.id_board = lm.id_board)
			LEFT JOIN {db_prefix}topics AS t ON (t.id_topic = lm.id_topic)
			WHERE id_log = {int:log_type}
				AND {raw:modlog_query}'
			. (!empty($query_string) ? '
				AND ' . $query_string : '') . '
		ORDER BY ' . $sort . '
		LIMIT ' . $start . ', ' . $items_per_page,
		array_merge($query_params, array(
			'forumid' => (int) $forumid,]]></add>
	</operation>
</file>
<file name="$sourcedir/MoveTopic.php">
	<!-- MoveTopic function -->
	<operation>	<!-- line 49 -->
		<search position="before"><![CDATA[global $txt, $board, $topic, $user_info, $context, $language, $scripturl, $settings, $smcFunc, $modSettings]]></search>
		<add><![CDATA[, $forumid]]></add>
	</operation>
	<operation>	<!-- line 88 -->
		<search position="replace"><![CDATA[SELECT b.id_board, b.name, b.child_level, c.name AS cat_name, c.id_cat
		FROM {db_prefix}boards AS b
			LEFT JOIN {db_prefix}categories AS c ON (c.id_cat = b.id_cat)
		WHERE {query_see_board}
			AND b.redirect = {string:blank_redirect}
			AND b.id_board != {int:current_board}',
		array(]]></search>
		<add><![CDATA[SELECT b.id_board, b.name, b.child_level, c.name AS cat_name, c.id_cat, c.forumid
		FROM {db_prefix}boards AS b
			LEFT JOIN {db_prefix}categories AS c ON (c.id_cat = b.id_cat AND c.forumid = {int:forumid})
		WHERE {query_see_board}
			AND b.redirect = {string:blank_redirect}
			AND c.forumid = {int:forumid}
			AND b.id_board != {int:current_board}',
		array(
            'forumid' => (int) $forumid,]]></add>
	</operation>
</file>
<file name="$sourcedir/News.php">
	<!-- getXmlNews function -->
	<operation>	<!-- line 569 -->
		<search position="before"><![CDATA[function getXmlNews($xml_format)
{
	global $user_info, $scripturl, $modSettings, $board]]></search>
		<add><![CDATA[, $forumid]]></add>
	</operation>
	<operation>	<!-- line 593 -->
		<search position="replace"><![CDATA[INNER JOIN {db_prefix}boards AS b ON (b.id_board = t.id_board)
				LEFT JOIN {db_prefix}members AS mem ON (mem.id_member = m.id_member)
			WHERE ' . $query_this_board . (empty($optimize_msg) ? '' : '
				AND {raw:optimize_msg}') . (empty($board) ? '' : '
				AND t.id_board = {int:current_board}') . ($modSettings['postmod_active'] ? '
				AND t.approved = {int:is_approved}' : '') . '
			ORDER BY t.id_first_msg DESC
			LIMIT {int:limit}',
			array(]]></search>
		<add><![CDATA[INNER JOIN {db_prefix}boards AS b ON (b.id_board = t.id_board)
				INNER JOIN {db_prefix}categories AS c ON (b.id_cat = c.id_cat)
				LEFT JOIN {db_prefix}members AS mem ON (mem.id_member = m.id_member)
			WHERE ' . $query_this_board . (empty($optimize_msg) ? '' : '
				AND {raw:optimize_msg}') . (empty($board) ? '' : '
				AND t.id_board = {int:current_board}') . ($modSettings['postmod_active'] ? '
				AND t.approved = {int:is_approved}' : '') . '
			AND c.forumid = {int:forumid}
			ORDER BY t.id_first_msg DESC
			LIMIT {int:limit}',
			array(
				'forumid' => (int) $forumid,]]></add>
	</operation>

	<!-- getXmlRecent function -->
	<operation>	<!-- line 696 -->
		<search position="before"><![CDATA[function getXmlRecent($xml_format)
{
	global $user_info, $scripturl, $modSettings, $board]]></search>
		<add><![CDATA[, $forumid]]></add>
	</operation>
	<operation>
		<search position="replace"><![CDATA[FROM {db_prefix}messages AS m
				INNER JOIN {db_prefix}boards AS b ON (b.id_board = m.id_board)
				INNER JOIN {db_prefix}topics AS t ON (t.id_topic = m.id_topic)
			WHERE ' . $query_this_board . (empty($optimize_msg) ? '' : '
				AND {raw:optimize_msg}') . (empty($board) ? '' : '
				AND m.id_board = {int:current_board}') . ($modSettings['postmod_active'] ? '
				AND m.approved = {int:is_approved}' : '') . '
			ORDER BY m.id_msg DESC
			LIMIT {int:limit}',
			array(]]></search>
		<add><![CDATA[FROM {db_prefix}messages AS m
				INNER JOIN {db_prefix}boards AS b ON (b.id_board = m.id_board)
			INNER JOIN {db_prefix}categories AS c ON (b.id_cat = c.id_cat)
				INNER JOIN {db_prefix}topics AS t ON (t.id_topic = m.id_topic)
			WHERE ' . $query_this_board . (empty($optimize_msg) ? '' : '
				AND {raw:optimize_msg}') . (empty($board) ? '' : '
				AND m.id_board = {int:current_board}') . ($modSettings['postmod_active'] ? '
				AND m.approved = {int:is_approved}' : '') . '
			AND c.forumid = {int:forumid}
			ORDER BY m.id_msg DESC
			LIMIT {int:limit}',
			array(
				'forumid' => (int) $forumid,]]></add>
	</operation>
</file>
<file name="$sourcedir/Packages.php">
	<!-- Packages function -->
	<operation>	<!-- line 56 -->
		<search position="before"><![CDATA[global $txt, $scripturl, $sourcedir, $context]]></search>
		<add><![CDATA[, $forumid]]></add>
	</operation>
	<operation>	<!-- line 58 -->
		<search position="after"><![CDATA[//!!! Remove this!]]></search>
		<add><![CDATA[// Subforum means no packages access
	if ($forumid <> 0)
	{
		isAllowedTo('admin_forum');
		require_once($sourcedir . '/Subs-Package.php');
		loadLanguage('Packages');
		loadTemplate('Packages', 'packages');
		$context[$context['admin_menu_name']]['tab_data'] = array(
			'title' => &$txt['package_manager'],
			'description' => $txt['package_manager_desc'],
			'tabs' => array());
		fatal_lang_error('no_pack_in_subforum', false);
	}

	]]></add>
	</operation>
</file>
<file name="$sourcedir/PersonalMessage.php">
	<!-- MessageMain function -->
	<operation>	<!-- line 102 -->
		<search position="before"><![CDATA[global $txt, $scripturl, $sourcedir, $context, $user_info, $user_settings, $smcFunc, $modSettings]]></search>
		<add><![CDATA[, $forumid]]></add>
	</operation>
	<operation>	<!-- line 131 -->
		<search position="replace"><![CDATA[WHERE id_group IN ({array_int:users_groups})',
			array(]]></search>
		<add><![CDATA[WHERE id_group IN ({array_int:users_groups})
				AND forumid IN ({int:global_forumid}, {int:forumid})',
			array(
				'global_forumid' => -1,
				'forumid' => (int) $forumid,]]></add>
	</operation>

	<!-- ReportMessage function -->
	<operation>	<!-- line 3045 -->
		<search position="before"><![CDATA[global $user_info, $language, $modSettings, $smcFunc]]></search>
		<add><![CDATA[, $forumid]]></add>
	</operation>
	<operation>	<!-- line 3067 -->
		<search position="replace"><![CDATA[SELECT id_member, real_name
			FROM {db_prefix}members
			WHERE id_group = {int:admin_group} OR FIND_IN_SET({int:admin_group}, additional_groups) != 0
			ORDER BY real_name',
			array(]]></search>
		<add><![CDATA[SELECT mem.id_member, real_name
			FROM {db_prefix}members
				LEFT JOIN {db_prefix}primary_membergroups AS pm ON (mem.id_member = pm.id_member AND pm.forumid = {int:forumid})
			WHERE COALESCE(pm.id_group, 0) = {int:admin_group} OR FIND_IN_SET({int:admin_group}, additional_groups) != 0
			ORDER BY real_name',
			array(
				'forumid' => (int) $forumid,]]></add>
	</operation>
	<operation>	<!-- line 3143 -->
		<search position="replace"><![CDATA[SELECT id_member, real_name, lngfile
			FROM {db_prefix}members
			WHERE (id_group = {int:admin_id} OR FIND_IN_SET({int:admin_id}, additional_groups) != 0)
				' . (empty($_POST['ID_ADMIN']) ? '' : 'AND id_member = {int:specific_admin}') . '
			ORDER BY lngfile',
			array(]]></search>
		<add><![CDATA[SELECT mem.id_member, real_name, lngfile
			FROM {db_prefix}members
				LEFT JOIN {db_prefix}primary_membergroups AS pm ON (mem.id_member = pm.id_member AND pm.forumid = {int:forumid})
			WHERE (COALESCE(pm.id_group, 0) = {int:admin_id} OR FIND_IN_SET({int:admin_id}, additional_groups) != 0)
				' . (empty($_POST['ID_ADMIN']) ? '' : 'AND id_member = {int:specific_admin}') . '
			ORDER BY lngfile',
			array(
				'forumid' => (int) $forumid,]]></add>
	</operation>

	<!-- ApplyRules function -->
	<operation>	<!-- line 3436 -->
		<search position="before"><![CDATA[global $user_info, $smcFunc, $context, $options]]></search>
		<add><![CDATA[, $forumid]]></add>
	</operation>
	<operation>	<!-- line 3451 -->
		<search position="replace"><![CDATA[SELECT
			pmr.id_pm, pm.id_member_from, pm.subject, pm.body, mem.id_group, pmr.labels
		FROM {db_prefix}pm_recipients AS pmr
			INNER JOIN {db_prefix}personal_messages AS pm ON (pm.id_pm = pmr.id_pm)
			LEFT JOIN {db_prefix}members AS mem ON (mem.id_member = pm.id_member_from)
		WHERE pmr.id_member = {int:current_member}
			AND pmr.deleted = {int:not_deleted}
			' . $ruleQuery,
		array(]]></search>
		<add><![CDATA[SELECT
			pmr.id_pm, pm.id_member_from, pm.subject, pm.body, COALESCE(pm.id_group, 0) AS id_group, pmr.labels
		FROM {db_prefix}pm_recipients AS pmr
			INNER JOIN {db_prefix}personal_messages AS pm ON (pm.id_pm = pmr.id_pm)
			LEFT JOIN {db_prefix}members AS mem ON (mem.id_member = pm.id_member_from)
			LEFT JOIN {db_prefix}primary_membergroups AS pm ON (mem.id_member = pm.id_member AND pm.forumid = {int:forumid})
		WHERE pmr.id_member = {int:current_member}
			AND pmr.deleted = {int:not_deleted}
			' . $ruleQuery,
		array(
			'forumid' => (int) $forumid,]]></add>
	</operation>
</file>
<file name="$sourcedir/Post.php">
	<!-- Post function -->
	<operation>	<!-- line 85 -->
		<search position="before"><![CDATA[global $txt, $scripturl, $topic, $modSettings, $board]]></search>
		<add><![CDATA[, $forumid]]></add>
	</operation>
	<operation>	<!-- line 295 -->
		<search position="replace"><![CDATA[WHERE id_event = {int:id_event}
				LIMIT 1',
				array(]]></search>
		<add><![CDATA[WHERE id_event = {int:id_event}
					AND forumid = {int:forumid}
				LIMIT 1',
				array(
					'forumid' => (int) $forumid,]]></add>
	</operation>

	<!-- Post2 function -->
	<operation>	<!-- line 1212 -->
		<search position="before"><![CDATA[global $user_info, $board_info, $options, $smcFunc]]></search>
		<add><![CDATA[, $forumid]]></add>
	</operation>
	<operation>	<!-- line 1954 -->
		<search position="replace"><![CDATA[WHERE id_event = {int:id_event}',
				array(]]></search>
		<add><![CDATA[WHERE id_event = {int:id_event}
					AND forumid = {int:forumid}',
				array(
					'forumid' => (int) $forumid,]]></add>
	</operation>
	<operation>	<!-- line 1971 -->
		<search position="replace"><![CDATA[WHERE id_event = {int:id_event}',
				array(]]></search>
		<add><![CDATA[WHERE id_event = {int:id_event}
					AND forumid = {int:forumid}',
				array(
					'forumid' => (int) $forumid,]]></add>
	</operation>
	<operation>	<!-- line 1986 -->
		<search position="replace"><![CDATA[WHERE id_event = {int:id_event}',
				array(]]></search>
		<add><![CDATA[WHERE id_event = {int:id_event}
					AND forumid = {int:forumid}',
				array(
					'forumid' => (int) $forumid,]]></add>
	</operation>

	<!-- AnnouncementSelectMembergroup function -->
	<operation>	<!-- line 2139 -->
		<search position="before"><![CDATA[global $txt, $context, $topic, $board, $board_info, $smcFunc]]></search>
		<add><![CDATA[, $forumid]]></add>
	</operation>
	<operation>	<!-- line 2159 -->
		<search position="replace"><![CDATA[LEFT JOIN {db_prefix}members AS mem ON (mem.id_group = mg.id_group OR FIND_IN_SET(mg.id_group, mem.additional_groups) != 0 OR mg.id_group = mem.id_post_group)
		WHERE mg.id_group IN ({array_int:group_list})
		GROUP BY mg.id_group',
		array(]]></search>
		<add><![CDATA[LEFT JOIN {db_prefix}primary_membergroups AS pm ON (mem.id_member = pm.id_member AND pm.forumid = {int:forumid})
			LEFT JOIN {db_prefix}members AS mem ON (COALESCE(pm.id_group, 0) = mg.id_group OR FIND_IN_SET(mg.id_group, mem.additional_groups) != 0 OR mg.id_group = mem.id_post_group)
		WHERE mg.id_group IN ({array_int:group_list})
		GROUP BY mg.id_group',
		array(
			'forumid' => (int) $forumid,]]></add>
	</operation>

	<!-- AnnouncementSend function -->
	<operation>	<!-- line 2215 -->
		<search position="before"><![CDATA[global $language, $scripturl, $txt, $user_info, $sourcedir, $smcFunc]]></search>
		<add><![CDATA[, $forumid]]></add>
	</operation>
	<operation>	<!-- line 2260 -->
		<search position="replace"><![CDATA[FROM {db_prefix}members AS mem
		WHERE mem.id_member != {int:current_member}' . (!empty($modSettings['allow_disableAnnounce']) ? '
			AND mem.notify_announcements = {int:notify_announcements}' : '') . '
			AND mem.is_activated = {int:is_activated}
			AND (mem.id_group IN ({array_int:group_list}) OR mem.id_post_group IN ({array_int:group_list}) OR FIND_IN_SET({raw:additional_group_list}, mem.additional_groups) != 0)
			AND mem.id_member > {int:start}
		ORDER BY mem.id_member
		LIMIT ' . $chunkSize,
		array(]]></search>
		<add><![CDATA[FROM {db_prefix}members AS mem
			LEFT JOIN {db_prefix}primary_membergroups AS pm ON (mem.id_member = pm.id_member AND pm.forumid = {int:forumid})
		WHERE mem.id_member != {int:current_member}' . (!empty($modSettings['allow_disableAnnounce']) ? '
			AND mem.notify_announcements = {int:notify_announcements}' : '') . '
			AND mem.is_activated = {int:is_activated}
			AND (COALESCE(pm.id_group, 0) IN ({array_int:group_list}) OR mem.id_post_group IN ({array_int:group_list}) OR FIND_IN_SET({raw:additional_group_list}, mem.additional_groups) != 0)
			AND mem.id_member > {int:start}
		ORDER BY mem.id_member
		LIMIT ' . $chunkSize,
		array(
			'forumid' => (int) $forumid,]]></add>
	</operation>

	<!-- notifyMembersBoard function -->
	<operation>	<!-- line 2337 -->
		<search position="before"><![CDATA[global $modSettings, $sourcedir, $board, $smcFunc, $context]]></search>
		<add><![CDATA[, $forumid]]></add>
	</operation>
	<operation>	<!-- line 2388 -->
		<search position="replace"><![CDATA[ln.sent, ln.id_board, mem.id_group, mem.additional_groups, b.member_groups,]]></search>
		<add><![CDATA[ln.sent, ln.id_board, COALESCE(pm.id_group, 0) AS id_group, mem.additional_groups, b.member_groups,]]></add>
	</operation>
	<operation>	<!-- line 2392 -->
		<search position="before"><![CDATA[INNER JOIN {db_prefix}members AS mem ON (mem.id_member = ln.id_member)]]></search>
		<add><![CDATA[
			LEFT JOIN {db_prefix}primary_membergroups AS pm ON (mem.id_member = pm.id_member AND pm.forumid = {int:forumid})]]></add>
	</operation>
	<operation>	<!-- line 2404 -->
		<search position="before"><![CDATA['notify_regularity' => 2,]]></search>
		<add><![CDATA[
			'forumid' => (int) $forumid,]]></add>
	</operation>
</file>
<file name="$sourcedir/PostModeration.php">
	<!-- UnapprovedPosts function -->
	<operation>	<!-- line 49 -->
		<search position="before"><![CDATA[global $txt, $scripturl, $context, $user_info, $sourcedir, $smcFunc]]></search>
		<add><![CDATA[, $forumid]]></add>
	</operation>
	<operation>	<!-- line 245 -->
		<search position="replace"><![CDATA[LEFT JOIN {db_prefix}categories AS c ON (c.id_cat = b.id_cat)
		WHERE m.approved = {int:not_approved}
			AND t.id_first_msg ' . ($context['current_view'] == 'topics' ? '=' : '!=') . ' m.id_msg
			AND {query_see_board}
			' . $approve_query . '
		LIMIT ' . $context['start'] . ', 10',
		array(]]></search>
		<add><![CDATA[LEFT JOIN {db_prefix}categories AS c ON (c.id_cat = b.id_cat AND c.forumid = {int:forumid})
		WHERE m.approved = {int:not_approved}
			AND t.id_first_msg ' . ($context['current_view'] == 'topics' ? '=' : '!=') . ' m.id_msg
			AND {query_see_board}
			' . $approve_query . '
		LIMIT ' . $context['start'] . ', 10',
		array(
			'forumid' => (int) $forumid,]]></add>
	</operation>
</file>
<file name="$sourcedir/Profile-Actions.php">
	<!-- deleteAccount2 function -->
	<operation>	<!-- line 417 -->
		<search position="before"><![CDATA[global $user_info, $sourcedir, $context, $cur_profile, $modSettings, $smcFunc]]></search>
		<add><![CDATA[, $forumid]]></add>
	</operation>
	<operation>	<!-- line 441 -->
		<search position="replace"><![CDATA[FROM {db_prefix}members
			WHERE (id_group = {int:admin_group} OR FIND_IN_SET({int:admin_group}, additional_groups) != 0)
				AND id_member != {int:selected_member}
			LIMIT 1',
			array(]]></search>
		<add><![CDATA[FROM {db_prefix}members
				LEFT JOIN {db_prefix}primary_membergroups AS pm ON (mem.id_member = pm.id_member AND pm.forumid = {int:forumid})
			WHERE (COALESCE(pm.id_group, 0) = {int:admin_group} OR FIND_IN_SET({int:admin_group}, additional_groups) != 0)
				AND id_member != {int:selected_member}
			LIMIT 1',
			array(
				'forumid' => (int) $forumid,]]></add>
	</operation>
</file>
<file name="$sourcedir/Profile-Modify.php">
	<!-- ignoreboards function -->
	<operation>	<!-- line 2199 -->
		<search position="before"><![CDATA[global $txt, $user_info, $context, $modSettings, $smcFunc, $cur_profile]]></search>
		<add><![CDATA[, $forumid]]></add>
	</operation>
	<operation>	<!-- line 2210 -->
		<search position="replace"><![CDATA[LEFT JOIN {db_prefix}categories AS c ON (c.id_cat = b.id_cat)
		WHERE {query_see_board}
			AND redirect = {string:empty_string}',
		array(]]></search>
		<add><![CDATA[LEFT JOIN {db_prefix}categories AS c ON (c.id_cat = b.id_cat AND c.forumid = {int:forumid})
		WHERE {query_see_board}
			AND redirect = {string:empty_string}',
		array(
			'forumid' => (int) $forumid,]]></add>
	</operation>

	<!-- profileLoadGroups function -->
	<operation>	<!-- line 2296 -->
		<search position="before"><![CDATA[global $cur_profile, $txt, $context, $smcFunc, $user_settings]]></search>
		<add><![CDATA[, $forumid]]></add>
	</operation>
	<operation>	<!-- line 2314 -->
		<search position="replace"><![CDATA[AND min_posts = {int:min_posts}' . (allowedTo('admin_forum') ? '' : '
			AND group_type != {int:is_protected}') . '
		ORDER BY min_posts, CASE WHEN id_group < {int:newbie_group} THEN id_group ELSE 4 END, group_name',
		array(]]></search>
		<add><![CDATA[AND min_posts = {int:min_posts}
			AND forumid IN ({int:global_forumid}, {int:forumid})' . (allowedTo('admin_forum') ? '' : '
			AND group_type != {int:is_protected}') . '
		ORDER BY min_posts, CASE WHEN id_group < {int:newbie_group} THEN id_group ELSE 4 END, group_name',
		array(
			'global_forumid' => -1,
			'forumid' => (int) $forumid,]]></add>
	</operation>

	<!-- groupMembership function -->
	<operation>	<!-- line 3070 -->
		<search position="before"><![CDATA[function groupMembership($memID)
{
	global $txt, $scripturl, $user_profile, $user_info, $context, $modSettings, $smcFunc]]></search>
		<add><![CDATA[, $forumid]]></add>
	</operation>
	<operation>	<!-- line 3101 -->
		<search position="replace"><![CDATA[AND mg.id_group != {int:moderator_group}
		ORDER BY group_name',
		array(]]></search>
		<add><![CDATA[AND mg.id_group != {int:moderator_group}
			AND mg.forumid IN ({int:global_forumid}, {int:forumid})
		ORDER BY group_name',
		array(
			'global_forumid' => -1,
			'forumid' => (int) $forumid,]]></add>
	</operation>
</file>
<file name="$sourcedir/Profile-View.php">
	<!-- showPermissions function -->
	<operation>	<!-- line 1684 -->
		<search position="before"><![CDATA[global $scripturl, $txt, $board, $modSettings]]></search>
		<add><![CDATA[, $forumid]]></add>
	</operation>
	<operation>	<!-- line 1764 -->
		<search position="replace"><![CDATA[WHERE p.id_group IN ({array_int:group_list})
		ORDER BY p.add_deny DESC, p.permission, mg.min_posts, CASE WHEN mg.id_group < {int:newbie_group} THEN mg.id_group ELSE 4 END, mg.group_name',
		array(]]></search>
		<add><![CDATA[WHERE p.id_group IN ({array_int:group_list})
			AND mg.forumid IN ({int:global_forumid}, {int:forumid})
		ORDER BY p.add_deny DESC, p.permission, mg.min_posts, CASE WHEN mg.id_group < {int:newbie_group} THEN mg.id_group ELSE 4 END, mg.group_name',
		array(
			'global_forumid' => -1,
			'forumid' => (int) $forumid,]]></add>
	</operation>
	<operation>	<!-- line 1817 -->
		<search position="replace"><![CDATA[AND (mods.id_member IS NOT NULL OR bp.id_group != {int:moderator_group})'),
		array(]]></search>
		<add><![CDATA[AND (mods.id_member IS NOT NULL OR bp.id_group != {int:moderator_group})
			AND mg.forumid IN ({int:global_forumid}, {int:forumid})'),
		array(
			'global_forumid' => -1,
			'forumid' => (int) $forumid,]]></add>
	</operation>
</file>
<file name="$sourcedir/Recent.php">
	<!-- getLastPost function -->
	<operation>	<!-- line 36 -->
		<search position="before"><![CDATA[global $user_info, $scripturl, $modSettings, $smcFunc]]></search>
		<add><![CDATA[, $forumid]]></add>
	</operation>
	<operation>	<!-- line 43 -->
		<search position="replace"><![CDATA[INNER JOIN {db_prefix}messages AS ml ON (ml.id_msg = b.id_last_msg)
		WHERE {query_wanna_see_board}' . (!empty($modSettings['recycle_enable']) && $modSettings['recycle_board'] > 0 ? '
			AND b.id_board != {int:recycle_board}' : '') . '
			AND ml.approved = {int:is_approved}
		ORDER BY b.id_msg_updated DESC
		LIMIT 1',
		array(]]></search>
		<add><![CDATA[INNER JOIN {db_prefix}messages AS ml ON (ml.id_msg = b.id_last_msg)
			INNER JOIN {db_prefix}categories AS c ON (b.id_cat = c.id_cat)
		WHERE {query_wanna_see_board}' . (!empty($modSettings['recycle_enable']) && $modSettings['recycle_board'] > 0 ? '
			AND b.id_board != {int:recycle_board}' : '') . '
			AND ml.approved = {int:is_approved}
			AND c.forumid = {int:forumid}
		ORDER BY b.id_msg_updated DESC
		LIMIT 1',
		array(
			'forumid' => (int) $forumid,]]></add>
	</operation>

	<!-- RecentPosts function -->
	<operation>	<!-- line 81 -->
		<search position="before"><![CDATA[global $txt, $scripturl, $user_info, $context, $modSettings, $sourcedir, $board, $smcFunc]]></search>
		<add><![CDATA[, $forumid]]></add>
	</operation>
	<operation>	<!-- line 103 -->
		<search position="replace"><![CDATA[WHERE id_cat = {int:id_cat}
				LIMIT 1',
				array(]]></search>
		<add><![CDATA[WHERE id_cat = {int:id_cat}
					AND forumid = {int:forumid}
				LIMIT 1',
				array(
					'forumid' => (int) $forumid,]]></add>
	</operation>
	<operation>	<!-- line 123 -->
		<search position="replace"><![CDATA[FROM {db_prefix}boards AS b
			WHERE b.id_cat IN ({array_int:category_list})
				AND {query_see_board}',
			array(]]></search>
		<add><![CDATA[FROM {db_prefix}boards AS b
				LEFT JOIN {db_prefix}categories AS c ON (c.id_cat = b.id_cat)
			WHERE b.id_cat IN ({array_int:category_list})
				AND c.forumid = {int:forumid}
				AND {query_see_board}',
			array(
				'forumid' => (int) $forumid,]]></add>
	</operation>
	<operation>	<!-- line 163 -->
		<search position="replace"><![CDATA[FROM {db_prefix}boards AS b
			WHERE b.id_board IN ({array_int:board_list})
				AND {query_see_board}
			LIMIT {int:limit}',
			array(]]></search>
		<add><![CDATA[FROM {db_prefix}boards AS b
				LEFT JOIN {db_prefix}categories AS c ON (c.id_cat = b.id_cat)
			WHERE b.id_board IN ({array_int:board_list})
				AND c.forumid = {int:forumid}
				AND {query_see_board}
			LIMIT {int:limit}',
			array(
				'forumid' => (int) $forumid,]]></add>
	</operation>
	<operation>	<!-- line 201 -->
		<search position="replace"><![CDATA[FROM {db_prefix}boards
			WHERE id_board = {int:current_board}
			LIMIT 1',
			array(]]></search>
		<add><![CDATA[FROM {db_prefix}boards
				LEFT JOIN {db_prefix}categories AS c ON (c.id_cat = b.id_cat)
			WHERE id_board = {int:current_board}
				AND c.forumid = {int:forumid}
			LIMIT 1',
			array(
				'forumid' => (int) $forumid,]]></add>
	</operation>
	<operation>	<!-- line 252 -->
		<search position="replace"><![CDATA[INNER JOIN {db_prefix}boards AS b ON (b.id_board = m.id_board)
				WHERE ' . $query_this_board . '
					AND m.approved = {int:is_approved}
				ORDER BY m.id_msg DESC
				LIMIT {int:offset}, {int:limit}',
				array_merge($query_parameters, array(]]></search>
		<add><![CDATA[INNER JOIN {db_prefix}boards AS b ON (b.id_board = m.id_board)
					INNER JOIN {db_prefix}categories AS c ON (b.id_cat = c.id_cat)
				WHERE ' . $query_this_board . '
					AND m.approved = {int:is_approved}
					AND c.forumid = {int:forumid}
				ORDER BY m.id_msg DESC
				LIMIT {int:offset}, {int:limit}',
				array_merge($query_parameters, array(
					'forumid' => (int) $forumid,]]></add>
	</operation>

	<!-- UnreadTopics function -->
	<operation>	<!-- line 425 -->
		<search position="before"><![CDATA[global $board, $txt, $scripturl, $sourcedir]]></search>
		<add><![CDATA[, $forumid]]></add>
	</operation>
	<operation>	<!-- line 475 -->
		<search position="replace"><![CDATA[FROM {db_prefix}boards AS b
			WHERE {query_wanna_see_board}
				AND b.child_level > {int:no_child}
				AND b.id_board NOT IN ({array_int:boards})
			ORDER BY child_level ASC
			',
			array(]]></search>
		<add><![CDATA[FROM {db_prefix}boards AS b
				INNER JOIN {db_prefix}categories AS c ON (c.id_cat = b.id_cat)
			WHERE {query_wanna_see_board}
				AND b.child_level > {int:no_child}
				AND b.id_board NOT IN ({array_int:boards})' . ($_REQUEST['action'] == 'unreadglobal' ? '' : '
				AND c.forumid = {int:forumid}') . '
			ORDER BY child_level ASC
			',
			array(
				'forumid' => (int) $forumid,]]></add>
	</operation>
	<operation>	<!-- line 514 -->
		<search position="replace"><![CDATA[FROM {db_prefix}boards AS b
			WHERE {query_see_board}
				AND b.id_board IN ({array_int:board_list})',
			array(]]></search>
		<add><![CDATA[FROM {db_prefix}boards AS b
				INNER JOIN {db_prefix}categories AS c ON (c.id_cat = b.id_cat)
			WHERE {query_see_board}
				AND b.id_board IN ({array_int:board_list})' . ($_REQUEST['action'] == 'unreadglobal' ? '' : '
				AND c.forumid = {int:forumid}'),
			array(
				'forumid' => (int) $forumid,]]></add>
	</operation>
	<operation>	<!-- line 542 -->
		<search position="replace"><![CDATA[FROM {db_prefix}boards AS b
			WHERE ' . $user_info[$see_board] . '
				AND b.id_cat IN ({array_int:id_cat})',
			array(]]></search>
		<add><![CDATA[FROM {db_prefix}boards AS b
				INNER JOIN {db_prefix}categories AS c ON (c.id_cat = b.id_cat)
			WHERE ' . $user_info[$see_board] . '
				AND b.id_cat IN ({array_int:id_cat})' . ($_REQUEST['action'] == 'unreadglobal' ? '' : '
				AND c.forumid = {int:forumid}'),
			array(
				'forumid' => (int) $forumid,]]></add>
	</operation>
	<operation>	<!-- line 567 -->
		<search position="replace"><![CDATA[FROM {db_prefix}boards AS b
			WHERE ' . $user_info[$see_board] . (!empty($modSettings['recycle_enable']) && $modSettings['recycle_board'] > 0 ? '
				AND b.id_board != {int:recycle_board}' : ''),
			array(]]></search>
		<add><![CDATA[FROM {db_prefix}boards AS b
				INNER JOIN {db_prefix}categories AS c ON (b.id_cat = c.id_cat)
			WHERE ' . $user_info[$see_board] . (!empty($modSettings['recycle_enable']) && $modSettings['recycle_board'] > 0 ? '
				AND b.id_board != {int:recycle_board}' : '') . ($_REQUEST['action'] == 'unreadglobal' ? '' : '
				AND c.forumid = {int:forumid}'),
			array(
				'forumid' => (int) $forumid,]]></add>
	</operation>
	<operation>	<!-- line 648 -->
		<search position="replace"><![CDATA[$txt['unread_topics_visit_none'] = strtr($txt['unread_topics_visit_none'], array('?action=unread;all' => '?action=unread;all' . sprintf($context['querystring_board_limits'], 0) . $context['querystring_sort_limits']));]]></search>
		<add><![CDATA[$txt['unread_topics_visit_none'] = strtr($txt['unread_topics_visit_none'], array('?action=unread;all' => '?action=' . ($_REQUEST['action'] == 'unreadglobal' ? 'unreadglobal' : 'unread') . ';all' . sprintf($context['querystring_board_limits'], 0) . $context['querystring_sort_limits']));]]></add>
	</operation>
</file>
<file name="$sourcedir/Register.php">
	<!-- Register function -->
	<operation>	<!-- line 43 -->
		<search position="before"><![CDATA[global $txt, $boarddir, $context, $settings, $modSettings, $user_info]]></search>
		<add><![CDATA[, $forumid, $subforum_tree]]></add>
	</operation>
	<operation>	<!-- line 64 -->
		<search position="after"><![CDATA[// Do we need them to agree to the registration agreement, first?]]></search>
		<add><![CDATA[// If admin requires registration to be redirected to the primary forum, do so now:
	if (!empty($modSettings['subforum_settings_register_at_primary']) && $forumid != 0)
		redirectExit($subforum_tree[0]['boardurl'] . '/index.php?action=register');

	]]></add>
	</operation>
	<operation>	<!-- line 117 -->
		<search position="replace"><![CDATA[if (file_exists($boarddir . '/agreement.' . $user_info['language'] . '.txt'))
			$context['agreement'] = parse_bbc(file_get_contents($boarddir . '/agreement.' . $user_info['language'] . '.txt'), true, 'agreement_' . $user_info['language']);
		elseif (file_exists($boarddir . '/agreement.txt'))
			$context['agreement'] = parse_bbc(file_get_contents($boarddir . '/agreement.txt'), true, 'agreement');]]></search>
		<add><![CDATA[$agree = 'agreement' . ($forumid == 0 ? '' : '.forum' . $forumid);
		if (file_exists($boarddir . '/' . $agree . $user_info['language'] . '.txt'))
			$context['agreement'] = parse_bbc(file_get_contents($boarddir . '/' . $agree . $user_info['language'] . '.txt'), true, 'agreement_' . $user_info['language']);
		elseif (file_exists($boarddir . '/' . $agree . '.txt'))
			$context['agreement'] = parse_bbc(file_get_contents($boarddir . '/' . $agree . '.txt'), true, 'agreement');]]></add>
	</operation>
</file>
<file name="$sourcedir/RemoveTopic.php">
	<!-- removeTopics function -->
	<operation>	<!-- line 223 -->
		<search position="before"><![CDATA[global $sourcedir, $modSettings, $smcFunc]]></search>
		<add><![CDATA[, $forumid]]></add>
	</operation>
	<operation>	<!-- line 498 -->
		<search position="replace"><![CDATA[DELETE FROM {db_prefix}calendar
		WHERE id_topic IN ({array_int:topics})',
		array(]]></search>
		<add><![CDATA[DELETE FROM {db_prefix}calendar
		WHERE id_topic IN ({array_int:topics})
			AND forumid = {int:forumid}',
		array(
			'forumid' => (int) $forumid,]]></add>
	</operation>
</file>
<file name="$sourcedir/Reports.php">
	<!-- BoardReport function -->
	<operation>	<!-- line 183 -->
		<search position="before"><![CDATA[global $context, $txt, $sourcedir, $smcFunc]]></search>
		<add><![CDATA[, $forumid]]></add>
	</operation>
	<operation>	<!-- line 273 -->
		<search position="replace"><![CDATA[LEFT JOIN {db_prefix}categories AS c ON (c.id_cat = b.id_cat)
			LEFT JOIN {db_prefix}boards AS par ON (par.id_board = b.id_parent)
			LEFT JOIN {db_prefix}themes AS th ON (th.id_theme = b.id_theme AND th.variable = {string:name})',
		array(]]></search>
		<add><![CDATA[LEFT JOIN {db_prefix}categories AS c ON (c.id_cat = b.id_cat AND c.forumid = {int:forumid})
			LEFT JOIN {db_prefix}boards AS par ON (par.id_board = b.id_parent)
			LEFT JOIN {db_prefix}themes AS th ON (th.id_theme = b.id_theme AND th.variable = {string:name})',
		array(
			'forumid' => (int) $forumid,]]></add>
	</operation>

	<!-- StaffReport function -->
	<operation>	<!-- line 668 -->
		<search position="before"><![CDATA[global $sourcedir, $context, $txt, $smcFunc]]></search>
		<add><![CDATA[, $forumid]]></add>
	</operation>
	<operation>	<!-- line 738 -->
		<search position="replace"><![CDATA[SELECT id_member, real_name, id_group, posts, last_login
		FROM {db_prefix}members
		WHERE id_member IN ({array_int:staff_list})
		ORDER BY real_name',
		array(]]></search>
		<add><![CDATA[SELECT id_member, real_name, COALESCE(pm.id_group, 0) AS id_group, posts, last_login
		FROM {db_prefix}members
			LEFT JOIN {db_prefix}primary_membergroups AS pm ON (mem.id_member = pm.id_member AND pm.forumid = {int:forumid})
		WHERE id_member IN ({array_int:staff_list})
		ORDER BY real_name',
		array(
			'forumid' => (int) $forumid,]]></add>
	</operation>
</file>
<file name="$sourcedir/ScheduledTasks.php">
	<!-- scheduled_approval_notification function -->
	<operation>	<!-- line 181 -->
		<search position="before"><![CDATA[global $scripturl, $modSettings, $mbname, $txt, $sourcedir, $smcFunc]]></search>
		<add><![CDATA[, $forumid]]></add>
	</operation>
	<operation>	<!-- line 283 -->
		<search position="replace"><![CDATA[SELECT id_member, real_name, email_address, lngfile, id_group, additional_groups, mod_prefs
		FROM {db_prefix}members
		WHERE id_group IN ({array_int:additional_group_list})
			OR FIND_IN_SET({raw:additional_group_list_implode}, additional_groups) != 0' . (empty($members) ? '' : '
			OR id_member IN ({array_int:member_list})') . '
		ORDER BY lngfile',
		array(]]></search>
		<add><![CDATA[SELECT id_member, real_name, email_address, lngfile, COALESCE(pm.id_group, 0) AS id_group, additional_groups, mod_prefs
		FROM {db_prefix}members
			LEFT JOIN {db_prefix}primary_membergroups AS pm ON (mem.id_member = pm.id_member AND pm.forumid = {int:forumid})
		WHERE COALESCE(pm.id_group, 0) IN ({array_int:additional_group_list})
			OR FIND_IN_SET({raw:additional_group_list_implode}, additional_groups) != 0' . (empty($members) ? '' : '
			OR id_member IN ({array_int:member_list})') . '
		ORDER BY lngfile',
		array(
			'forumid' => (int) $forumid,]]></add>
	</operation>
</file>
<file name="$sourcedir/Search.php">
	<!-- PlushSearch1 function -->
	<operation>	<!-- line 55 -->
		<search position="before"><![CDATA[global $txt, $scripturl, $modSettings, $user_info, $context, $smcFunc, $sourcedir]]></search>
		<add><![CDATA[, $forumid]]></add>
	</operation>
	<operation>	<!-- line 143 -->
		<search position="replace"><![CDATA[SELECT b.id_cat, c.name AS cat_name, b.id_board, b.name, b.child_level]]></search>
		<add><![CDATA[SELECT b.id_cat, c.name AS cat_name, c.forumid, b.id_board, b.name, b.child_level]]></add>
	</operation>
	<operation>	<!-- line 157 -->
		<search position="after"><![CDATA[// This category hasn't been set up yet..]]></search>
		<add><![CDATA[if ((int) $row['forumid'] != $forumid) // non-viewable board
			continue;

		]]></add>
	</operation>

	<!-- PlushSearch2 function -->
	<operation>	<!-- line 254 -->
		<search position="before"><![CDATA[global $scripturl, $modSettings, $sourcedir, $txt, $db_connection]]></search>
		<add><![CDATA[, $forumid]]></add>
	</operation>
	<operation>	<!-- line 1768 -->
		<search position="replace"><![CDATA[INNER JOIN {db_prefix}categories AS c ON (c.id_cat = b.id_cat)]]></search>
		<add><![CDATA[INNER JOIN {db_prefix}categories AS c ON (c.id_cat = b.id_cat AND c.forumid = {int:forumid})]]></add>
	</operation>
	<operation>	<!-- line 1780 -->
		<search position="after"><![CDATA['message_list_in_set' => implode(',', $msg_list),]]></search>
		<add><![CDATA['forumid' => (int) $forumid,
				]]></add>
	</operation>
</file>
<file name="$sourcedir/SplitTopics.php">
	<!-- MergeExecute function -->
	<operation>	<!-- line 980 -->
		<search position="before"><![CDATA[global $smcFunc, $language, $modSettings]]></search>
		<add><![CDATA[, $forumid]]></add>
	</operation>
	<operation>	<!-- line 1403 -->
		<search position="replace"><![CDATA[SET
			id_topic = {int:id_topic},
			id_board = {int:target_board}
		WHERE id_topic IN ({array_int:deleted_topics})',
		array(]]></search>
		<add><![CDATA[SET
			id_topic = {int:id_topic},
			id_board = {int:target_board}
		WHERE id_topic IN ({array_int:deleted_topics})
			AND forumid = {int:forumid}',
		array(
			'forumid' => (int) $forumid,]]></add>
	</operation>
</file>
<file name="$sourcedir/Subs-Admin.php">
	<!-- updateSettingsFile function -->
	<operation>	<!-- line 248 -->
		<search position="after"><![CDATA[// When is Settings.php last changed?]]></search>
		<add><![CDATA[// Put available data in the Subforum Tree variable:
	SplitForum_PreUpdate($config_vars);

	]]></add>
	</operation>

	<!-- emailAdmins function -->
	<operation>	<!-- line 409 -->
		<search position="before"><![CDATA[global $smcFunc, $sourcedir, $language, $modSettings]]></search>
		<add><![CDATA[, $forumid]]></add>
	</operation>
	<operation>	<!-- line 433 -->
		<search position="replace"><![CDATA[SELECT id_member, member_name, real_name, lngfile, email_address
		FROM {db_prefix}members
		WHERE (id_group IN ({array_int:group_list}) OR FIND_IN_SET({raw:group_array_implode}, additional_groups) != 0)
			AND notify_types != {int:notify_types}
		ORDER BY lngfile',
		array(]]></search>
		<add><![CDATA[SELECT mem.id_member, member_name, real_name, lngfile, email_address
		FROM {db_prefix}members mem
			LEFT JOIN {db_prefix}primary_membergroups AS pm ON (mem.id_member = pm.id_member AND pm.forumid = {int:forumid})
		WHERE (COALESCE(pm.id_group, 0) IN ({array_int:group_list}) OR FIND_IN_SET({raw:group_array_implode}, additional_groups) != 0)
			AND notify_types != {int:notify_types}
		ORDER BY lngfile',
		array(
			'forumid' => (int) $forumid,]]></add>
	</operation>
</file>
<file name="$sourcedir/Subs-BoardIndex.php">
	<!-- getBoardIndex function -->
	<operation>	<!-- line 33 -->
		<search position="before"><![CDATA[global $settings, $context]]></search>
		<add><![CDATA[, $forumid]]></add>
	</operation>
	<operation>	<!-- line 57 -->
		<search position="replace"><![CDATA[LEFT JOIN {db_prefix}categories AS c ON (c.id_cat = b.id_cat)' : '') . ']]></search>
		<add><![CDATA[LEFT JOIN {db_prefix}categories AS c ON (c.id_cat = b.id_cat AND c.forumid = {int:forumid})' : '') . ']]></add>
	</operation>
	<operation>	<!-- line 68 -->
		<search position="before"><![CDATA['current_member' => $user_info['id'],]]></search>
		<add><![CDATA[
			'forumid' => (int) $forumid,]]></add>
	</operation>
	<operation>	<!-- line 89 -->
		<search position="after"><![CDATA[// Haven't set this category yet.]]></search>
		<add><![CDATA[// Skip this board, as its category parent is not visible
			if ((int) $row_board['id_cat'] == 0)
				continue;

			]]></add>
	</operation>
</file>
<file name="$sourcedir/Subs-Boards.php">
	<!-- modifyBoard function -->
	<operation>	<!-- line 475 -->
		<search position="before"><![CDATA[global $sourcedir, $cat_tree, $boards, $boardList, $modSettings, $smcFunc]]></search>
		<add><![CDATA[, $forumid]]></add>
	</operation>
	<operation>	<!-- line 477 -->
		<search position="replace"><![CDATA[// Get some basic information about all boards and categories.
	getBoardTree();]]></search>
		<add><![CDATA[// Get some basic information about all boards and categories.
	getBoardTree( ($forumid == 0 ? -1 : $forumid) );

	if (isset($boardOptions['access_groups'])) {
		$request = $smcFunc['db_query']('', '
			SELECT id_group
			FROM {db_prefix}membergroups
			WHERE id_group IN ({array_int:access_groups}) AND forumid != -1 AND forumid != {int:forumid}',
			array(
				'access_groups' => $boardOptions['access_groups'],
				'forumid' => (int) $forumid,
			)
		);
		if ($smcFunc['db_num_rows']($request) > 0)
			fatal_lang_error('subforum_error_bad_membergroup');
	}]]></add>
	</operation>
	<operation>	<!-- line 667 -->
		<search position="after"><![CDATA[// Set moderators of this board.]]></search>
		<add><![CDATA[// Edit the aliases to make sure they are valid for this subforum:
	if (array_key_exists('alias_child', $boardOptions))
	{
		require_once($sourcedir . '/Subs-ManageSplitForums.php');
		remove_bad_aliases();
	}

	]]></add>
	</operation>
	<operation>	<!-- line 780 -->
		<search position="after"><![CDATA[$board_id = $smcFunc['db_insert_id']('{db_prefix}boards', 'id_board');]]></search>
		<add><![CDATA[$_POST['boardid'] = ]]></add>
	</operation>

	<!-- deleteBoards function -->
	<operation>	<!-- line 832 -->
		<search position="before"><![CDATA[global $sourcedir, $boards, $smcFunc]]></search>
		<add><![CDATA[, $forumid]]></add>
	</operation>
	<operation>	<!-- line 916 -->
		<search position="replace"><![CDATA[DELETE FROM {db_prefix}calendar
		WHERE id_board IN ({array_int:boards_to_remove})',
		array(]]></search>
		<add><![CDATA[DELETE FROM {db_prefix}calendar
		WHERE id_board IN ({array_int:boards_to_remove})
			AND forumid = {int:forumid}',
		array(
			'forumid' => (int) $forumid,]]></add>
	</operation>

	<!-- reorderBoards function -->
	<operation>	<!-- line 966 -->
		<search position="replace"><![CDATA[getBoardTree();

	// Set the board order for each category.]]></search>
		<add><![CDATA[getBoardTree(-1);

	// Set the board order for each category.]]></add>
	</operation>

	<!-- getBoardTree function -->
	<operation>	<!-- line 1032 -->
		<search position="replace"><![CDATA[function getBoardTree()
{
	global $cat_tree, $boards, $boardList, $txt, $modSettings, $smcFunc]]></search>
		<add><![CDATA[function getBoardTree($reqid = 0)
{
	global $cat_tree, $boards, $boardList, $txt, $modSettings, $smcFunc, $forumid, $subforum_tree]]></add>
	</operation>
	<operation>	<!-- line 1034 -->
		<search position="after"><![CDATA[// Getting all the board and category information you'd ever wanted.]]></search>
		<add><![CDATA[// Build the subforum tree array:
	if ($forumid <> 0)
		$subforum_tree = array($forumid => $subforum_tree[$forumid]);

	// Getting all the board and category information you'd ever wanted.
	$reqid = (int) ($forumid == 0 ? $reqid : $forumid);

	]]></add>
	</operation>
	<operation>	<!-- line 1041 -->
		<search position="replace"><![CDATA[b.num_posts, b.num_topics, c.id_cat, c.name AS cat_name, c.cat_order, c.can_collapse
		FROM {db_prefix}categories AS c
			LEFT JOIN {db_prefix}boards AS b ON (b.id_cat = c.id_cat)
		ORDER BY c.cat_order, b.child_level, b.board_order',
		array(]]></search>
		<add><![CDATA[b.num_posts, b.num_topics, c.id_cat, c.name AS cat_name, c.cat_order, c.can_collapse, c.forumid
		FROM {db_prefix}categories AS c
			LEFT JOIN {db_prefix}boards AS b ON (b.id_cat = c.id_cat)
		'.($reqid <> -1 ? 'WHERE c.forumid = {int:forumid}' : '').'
		ORDER BY c.forumid, c.cat_order, b.child_level, b.board_order',
		array(
			'forumid' => (int) $reqid,]]></add>
	</operation>
	<operation>	<!-- line 1053 -->
		<search position="after"><![CDATA[if (!isset($cat_tree[$row['id_cat']]))]]></search>
		<add><![CDATA[if (!isset($subforum_tree[$row['forumid']]))
			$subforum_tree[$row['forumid']] = array('forumid' => (int) $row['forumid']);

		]]></add>
	</operation>
	<operation>	<!-- line 1060 -->
		<search position="before"><![CDATA['can_collapse' => $row['can_collapse']]]></search>
		<add><![CDATA[,
					'forumid' => $row['forumid']]]></add>
	</operation>
	<operation>	<!-- line 1075 -->
		<search position="before"><![CDATA[$boards[$row['id_board']] = array(]]></search>
		<add><![CDATA[
				'forumid' => (int) $row['forumid'],]]></add>
	</operation>
</file>
<file name="$sourcedir/Subs-Calendar.php">
	<!-- getEventRange function -->
	<operation>	<!-- line 165 -->
		<search position="before"><![CDATA[global $scripturl, $modSettings, $user_info, $smcFunc, $context]]></search>
		<add><![CDATA[, $forumid]]></add>
	</operation>
	<operation>	<!-- line 182 -->
		<search position="replace"><![CDATA[AND (cal.id_board = {int:no_board_link} OR {query_wanna_see_board})' : ''),
		array(]]></search>
		<add><![CDATA[AND (cal.id_board = {int:no_board_link} OR {query_wanna_see_board})' : '') .'
			AND cal.forumid = {int:forumid}',
		array(
			'forumid' => (int) $forumid,]]></add>
	</operation>

	<!-- getEventPoster function -->
	<operation>	<!-- line 816 -->
		<search position="before"><![CDATA[function getEventPoster($event_id)
{
	global $smcFunc]]></search>
		<add><![CDATA[, $forumid]]></add>
	</operation>
	<operation>	<!-- line 818 -->
		<search position="replace"><![CDATA[// A simple database query, how hard can that be?
	$request = $smcFunc['db_query']('', '
		SELECT id_member
		FROM {db_prefix}calendar
		WHERE id_event = {int:id_event}
		LIMIT 1',
		array(]]></search>
		<add><![CDATA[// A simple database query, how hard can that be?
	$request = $smcFunc['db_query']('', '
		SELECT id_member
		FROM {db_prefix}calendar
		WHERE id_event = {int:id_event}
			AND forumid = {int:forumid}
		LIMIT 1',
		array(
			'forumid' => (int) $forumid,]]></add>
	</operation>

	<!-- insertEvent function -->
	<operation>	<!-- line 839 -->
		<search position="before"><![CDATA[function insertEvent(&$eventOptions)
{
	global $modSettings, $smcFunc]]></search>
		<add><![CDATA[, $forumid]]></add>
	</operation>
	<operation>	<!-- line 867 -->
		<search position="before"><![CDATA['start_date' => 'date', 'end_date' => 'date',]]></search>
		<add><![CDATA[ 'forumid' => 'int',]]></add>
	</operation>
	<operation>	<!-- line 871 -->
		<search position="before"><![CDATA[$eventOptions['start_date'], $eventOptions['end_date'],]]></search>
		<add><![CDATA[ $forumid,]]></add>
	</operation>

	<!-- modifyEvent function -->
	<operation>	<!-- line 887 -->
		<search position="before"><![CDATA[function modifyEvent($event_id, &$eventOptions)
{
	global $smcFunc]]></search>
		<add><![CDATA[, $forumid]]></add>
	</operation>
	<operation>	<!-- line 913 -->
		<search position="replace"><![CDATA[WHERE id_event = {int:id_event}',
		array(
			'start_date' => $eventOptions['start_date'],]]></search>
		<add><![CDATA[WHERE id_event = {int:id_event}
			AND forumid = {int:forumid}',
		array(
			'forumid' => (int) $forumid,
			'start_date' => $eventOptions['start_date'],]]></add>
	</operation>

	<!-- removeEvent function -->
	<operation>	<!-- line 927 -->
		<search position="before"><![CDATA[function removeEvent($event_id)
{
	global $smcFunc]]></search>
		<add><![CDATA[, $forumid]]></add>
	</operation>
	<operation>	<!-- line 931 -->
		<search position="replace"><![CDATA[$smcFunc['db_query']('', '
		DELETE FROM {db_prefix}calendar
		WHERE id_event = {int:id_event}',
		array(]]></search>
		<add><![CDATA[$smcFunc['db_query']('', '
		DELETE FROM {db_prefix}calendar
		WHERE id_event = {int:id_event}
			AND forumid = {int:forumid}',
		array(
			'forumid' => (int) $forumid,]]></add>
	</operation>

	<!-- getEventProperties function -->
	<operation>	<!-- line 944 -->
		<search position="before"><![CDATA[function getEventProperties($event_id)
{
	global $smcFunc]]></search>
		<add><![CDATA[, $forumid]]></add>
	</operation>
	<operation>	<!-- line 956 -->
		<search position="replace"><![CDATA[WHERE c.id_event = {int:id_event}',
		array(]]></search>
		<add><![CDATA[WHERE c.id_event = {int:id_event}
			AND c.forumid = {int:forumid}',
		array(
			'forumid' => (int) $forumid,]]></add>
	</operation>
</file>
<file name="$sourcedir/Subs-Categories.php">
	<!-- modifyCategory function -->
	<operation>	<!-- line 114 -->
		<search position="after"><![CDATA[// Do the updates (if any).]]></search>
		<add><![CDATA[// Which forum will this category be displayed on?
	if (isset($catOptions['forumid']))
	{
		$catUpdates[] = 'forumid = {int:forumid}';
		$catParameters['forumid'] = (int)$catOptions['forumid'];
	}

	]]></add>
	</operation>
</file>
<file name="$sourcedir/Subs-Membergroups.php">
	<!-- deleteMembergroups function -->
	<operation>	<!-- line 151 -->
		<search position="replace"><![CDATA[// Update the primary groups of members.
	$smcFunc['db_query']('', '
		UPDATE {db_prefix}members
		SET id_group = {int:regular_group}
		WHERE id_group IN ({array_int:group_list})',
		array(
			'group_list' => $groups,
			'regular_group' => 0,
		)
	);]]></search>
		<add><![CDATA[// Update the primary groups of members.
	$smcFunc['db_query']('', '
		DELETE FROM {db_prefix}primary_membergroups
		WHERE id_group IN ({array_int:group_list})',
		array(
			'group_list' => $groups,
		)
	);]]></add>
	</operation>

	<!-- removeMembersFromGroups function -->
	<operation>	<!-- line 231 -->
		<search position="before"><![CDATA[function removeMembersFromGroups($members, $groups = null, $permissionCheckDone = false)
{
	global $smcFunc, $user_info, $modSettings]]></search>
		<add><![CDATA[, $forumid]]></add>
	</operation>
	<operation>	<!-- line 271 -->
		<search position="replace"><![CDATA[$smcFunc['db_query']('', '
			UPDATE {db_prefix}members
			SET
				id_group = {int:regular_member},
				additional_groups = {string:blank_string}
			WHERE id_member IN ({array_int:member_list})' . (allowedTo('admin_forum') ? '' : '
				AND id_group != {int:admin_group}
				AND FIND_IN_SET({int:admin_group}, additional_groups) = 0'),
			array(
				'member_list' => $members,
				'regular_member' => 0,
				'admin_group' => 1,
				'blank_string' => '',
			)
		);]]></search>
		<add><![CDATA[$smcFunc['db_query']('', '
			UPDATE {db_prefix}members mem, {db_prefix}primary_membergroups pm
				LEFT JOIN {db_prefix}primary_membergroups AS pm ON (pm.id_member = mem.id_member AND pm.forumid = {int:forumid})
			SET
				mem.additional_groups = {string:blank_string}
			WHERE mem.id_member IN ({array_int:member_list})' . (allowedTo('admin_forum') ? '' : '
				AND pm.id_group != {int:admin_group}
				AND FIND_IN_SET({int:admin_group}, mem.additional_groups) = 0'),
			array(
				'member_list' => $members,
				'regular_member' => 0,
				'admin_group' => 1,
				'blank_string' => '',
				'forumid' => (int) $forumid,
			)
		);
		$smcFunc['db_query']('', '
			DELETE FROM {db_prefix}primary_membergroups
			WHERE id_member IN ({array_int:member_list})
				AND forumid = {int:forumid}' . (allowedTo('admin_forum') ? '' : '
				AND id_group != {int:admin_group}'),
			array(
				'member_list' => $members,
				'forumid' => (int) $forumid,
				'admin_group' => 1,
			)
		);]]></add>
	</operation>
	<operation>	<!-- line 356 -->
		<search position="replace"><![CDATA[SELECT id_member, id_group
		FROM {db_prefix}members AS members
		WHERE id_group IN ({array_int:group_list})
			AND id_member IN ({array_int:member_list})',]]></search>
		<add><![CDATA[SELECT id_member, id_group
		FROM {db_prefix}primary_membergroups AS primary_membergroups
		WHERE id_group IN ({array_int:group_list})
			AND id_member IN ({array_int:member_list})',]]></add>
	</operation>
	<operation>	<!-- line 373 -->
		<search position="replace"><![CDATA[$smcFunc['db_free_result']($request);

	$smcFunc['db_query']('', '
		UPDATE {db_prefix}members
		SET id_group = {int:regular_member}]]></search>
		<add><![CDATA[$smcFunc['db_free_result']($request);

	$smcFunc['db_query']('', '
		DELETE FROM {db_prefix}primary_membergroups]]></add>
	</operation>

	<!-- addMembersToGroup function -->
	<operation>	<!-- line 451 -->
		<search position="before"><![CDATA[function addMembersToGroup($members, $group, $type = 'auto', $permissionCheckDone = false)
{
	global $smcFunc, $user_info, $modSettings]]></search>
		<add><![CDATA[, $forumid]]></add>
	</operation>
	<operation>	<!-- line 523 -->
		<search position="replace"><![CDATA[// Do the actual updates.
	if ($type == 'only_additional')
		$smcFunc['db_query']('', '
			UPDATE {db_prefix}members
			SET additional_groups = CASE WHEN additional_groups = {string:blank_string} THEN {string:id_group_string} ELSE CONCAT(additional_groups, {string:id_group_string_extend}) END
			WHERE id_member IN ({array_int:member_list})
				AND id_group != {int:id_group}
				AND FIND_IN_SET({int:id_group}, additional_groups) = 0',
			array(]]></search>
		<add><![CDATA[// Do the actual updates
	if ($type == 'only_additional')
		$smcFunc['db_query']('', '
			UPDATE {db_prefix}members mem, {db_prefix}primary_membergroups pm
				LEFT JOIN {db_prefix}primary_membergroups pm ON (pm.id_member = mem.id_member AND pm.forumid = {int:forumid})
			SET additional_groups = CASE WHEN additional_groups = {string:blank_string} THEN {string:id_group_string} ELSE CONCAT(additional_groups, {string:id_group_string_extend}) END
			WHERE id_member IN ({array_int:member_list})
				AND COALESCE(pm.id_group, 0) != {int:id_group}
				AND FIND_IN_SET({int:id_group}, additional_groups) = 0',
			array(
				'forumid' => (int) $forumid,]]></add>
	</operation>
	<operation>	<!-- line 541 -->
		<search position="replace"><![CDATA[UPDATE {db_prefix}members
			SET id_group = {int:id_group}
			WHERE id_member IN ({array_int:member_list})' . ($type == 'force_primary' ? '' : '
				AND id_group = {int:regular_group}
				AND FIND_IN_SET({int:id_group}, additional_groups) = 0'),
			array(]]></search>
		<add><![CDATA[REPLACE INTO {db_prefix}primary_membergroups
			(id_group, forumid, id_member)
			SELECT {int:id_group}, {int:forumid}, mem.id_member FROM {db_prefix}members mem
			WHERE id_member IN ({array_int:member_list})' . ($type == 'force_primary' ? '' : '
				AND id_group = {int:regular_group}
				AND FIND_IN_SET({int:id_group}, additional_groups) = 0'),
			array(
				'forumid' => (int) $forumid,]]></add>
	</operation>
	<operation>	<!-- line 553 -->
		<search position="replace"><![CDATA[elseif ($type == 'auto')
		$smcFunc['db_query']('', '
			UPDATE {db_prefix}members
			SET
				id_group = CASE WHEN id_group = {int:regular_group} THEN {int:id_group} ELSE id_group END,
				additional_groups = CASE WHEN id_group = {int:id_group} THEN additional_groups
					WHEN additional_groups = {string:blank_string} THEN {string:id_group_string}
					ELSE CONCAT(additional_groups, {string:id_group_string_extend}) END
			WHERE id_member IN ({array_int:member_list})
				AND id_group != {int:id_group}
				AND FIND_IN_SET({int:id_group}, additional_groups) = 0',
			array(
				'member_list' => $members,
				'regular_group' => 0,
				'id_group' => $group,
				'blank_string' => '',
				'id_group_string' => (string) $group,
				'id_group_string_extend' => ',' . $group,
			)
		);]]></search>
		<add><![CDATA[elseif ($type == 'auto')
	{
		$request = $smcFunc['db_query']('', '
			SELECT id_member
			FROM {db_prefix}primary_membergroups
			WHERE id_member IN ({array_int:member_list})
					AND forumid = {int:forumid}',
			array(
				'member_list' => $members,
				'forumid' => (int) $forumid,
			)
		);
		$membersUpdated = array();
		while ($row = $smcFunc['db_fetch_assoc']($request))
		{
			$smcFunc['db_query']('', '
				UPDATE {db_prefix}members
				SET
					additional_groups = CASE WHEN additional_groups = {string:blank_string} THEN {string:id_group_string}
					ELSE CONCAT(additional_groups, {string:id_group_string_extend}) END
				WHERE id_member = {int:id_member}',
				array(
					'blank_string' => '',
					'id_group_string' => (string) $group,
					'id_group_string_extend' => ',' . $group,
					'id_member' => $row['id_member'],
				)
			);
			array_push($membersUpdated, $row['id_member']);
		}
		$smcFunc['db_free_result']($request);

		$membersToSetPrimary = array_diff($members, $membersUpdated);
		$insertData = array();
		foreach ($membersToSetPrimary as $id_member)
		{
			$insertData[] = array(
				'id_member' => $id_member,
				'id_group' => $group,
				'forumid' => (int) $forumid,
			);
			$smcFunc['db_insert']('',
				'{db_prefix}primary_membergroups',
				array(
					'id_member' => 'int', 'id_group' => 'int', 'forumid' => 'int',
				),
				$insertData,
				array('id_member', 'forumid')
			);
		}
	}]]></add>
	</operation>

	<!-- listMembergroupMembers_Href function -->
	<operation>	<!-- line 601 -->
		<search position="before"><![CDATA[function listMembergroupMembers_Href(&$members, $membergroup, $limit = null)
{
	global $scripturl, $txt, $smcFunc]]></search>
		<add><![CDATA[, $forumid]]></add>
	</operation>
	<operation>	<!-- line 605 -->
		<search position="replace"><![CDATA[$request = $smcFunc['db_query']('', '
		SELECT id_member, real_name
		FROM {db_prefix}members
		WHERE id_group = {int:id_group} OR FIND_IN_SET({int:id_group}, additional_groups) != 0' . ($limit === null ? '' : '
		LIMIT ' . ($limit + 1)),
		array(]]></search>
		<add><![CDATA[$request = $smcFunc['db_query']('', '
		SELECT mem.id_member, mem.real_name
		FROM {db_prefix}members mem
			LEFT JOIN {db_prefix}primary_membergroups pm ON (pm.id_member = mem.id_member AND pm.forumid = {int:forumid})
		WHERE pm.id_group = {int:id_group} OR FIND_IN_SET({int:id_group}, mem.additional_groups) != 0' . ($limit === null ? '' : '
		LIMIT ' . ($limit + 1)),
		array(
			'forumid' => (int) $forumid,]]></add>
	</operation>

	<!-- list_getMembergroups function -->
	<operation>	<!-- line 663 -->
		<search position="before"><![CDATA[global $txt, $scripturl, $context, $settings, $smcFunc]]></search>
		<add><![CDATA[, $forumid, $modSettings]]></add>
	</operation>
	<operation>	<!-- line 671 -->
		<search position="replace"><![CDATA[WHERE min_posts ' . ($membergroup_type === 'post_count' ? '!=' : '=') . ' -1' . (allowedTo('admin_forum') ? '' : '
			AND group_type != {int:is_protected}') . '
		ORDER BY {raw:sort}',
		array(]]></search>
		<add><![CDATA[WHERE min_posts ' . ($membergroup_type === 'post_count' ? '!=' : '=') . ' -1
			AND (forumid = {int:global_forumid} OR forumid = {int:forumid})' . (allowedTo('admin_forum') ? '' : '
			AND group_type != {int:is_protected}') . '
		ORDER BY {raw:sort}',
		array(
			'global_forumid' => -1,
			'forumid' => (int) $forumid,]]></add>
	</operation>
	<operation>	<!-- line 712 -->
		<search position="replace"><![CDATA[SELECT id_group, COUNT(*) AS num_members
				FROM {db_prefix}members
				WHERE id_group IN ({array_int:group_list})
				GROUP BY id_group',
				array(]]></search>
		<add><![CDATA[SELECT COALESCE (pm.id_group, 0) AS id_group, COUNT(*) AS num_members
				FROM {db_prefix}members mem
					LEFT JOIN {db_prefix}primary_membergroups pm ON (pm.id_member = mem.id_member AND pm.forumid = {int:forumid})
				WHERE pm.id_group IN ({array_int:group_list})
				GROUP BY pm.id_group',
				array(
					'forumid' => (int) $forumid,]]></add>
	</operation>
	<operation>	<!-- line 727 -->
		<search position="replace"><![CDATA[$query = $smcFunc['db_query']('', '
				SELECT mg.id_group, COUNT(*) AS num_members
				FROM {db_prefix}membergroups AS mg
					INNER JOIN {db_prefix}members AS mem ON (mem.additional_groups != {string:blank_string}
						AND mem.id_group != mg.id_group
						AND FIND_IN_SET(mg.id_group, mem.additional_groups) != 0)
				WHERE mg.id_group IN ({array_int:group_list})
				GROUP BY mg.id_group',
				array(
					'group_list' => array_keys($groups),
					'blank_string' => '',
				)
			);]]></search>
		<add><![CDATA[// We need to disable query checks for this next operation:
			if (isset($modSettings['disableQueryCheck']))
				$tmp = $modSettings['disableQueryCheck'];
			$modSettings['disableQueryCheck'] = true;

			$query = $smcFunc['db_query']('', '
				SELECT mg.id_group, COUNT(*) AS num_members
				FROM {db_prefix}membergroups AS mg
					INNER JOIN (SELECT mem.additional_groups, pm.id_group
						FROM smf_members AS mem
							LEFT JOIN smf_primary_membergroups pm ON (pm.id_member = mem.id_member AND pm.forumid = {int:forumid})
						) AS pmem ON (pmem.additional_groups != {string:blank_string}
						AND pmem.id_group != mg.id_group
						AND FIND_IN_SET(mg.id_group, pmem.additional_groups) != 0)
				WHERE mg.id_group IN ({array_int:group_list})
				GROUP BY mg.id_group',
				array(
					'group_list' => array_keys($groups),
					'blank_string' => '',
					'forumid' => (int) $forumid,
				)
			);]]></add>
	</operation>
	<operation>
		<search position="after"><![CDATA[		}
	}

	// Apply manual sorting if the 'number of members' column is selected.
]]></search>
		<add><![CDATA[
			// Restore query checks to previous status:
			if (isset($tmp))
				$modSettings['disableQueryCheck'] = $tmp;
]]></add>
	</operation>
</file>
<file name="$sourcedir/Subs-Members.php">
	<!-- deleteMembers function -->
	<operation>	<!-- line 85 -->
		<search position="before"><![CDATA[global $sourcedir, $modSettings, $user_info, $smcFunc]]></search>
		<add><![CDATA[, $forumid]]></add>
	</operation>
	<operation>	<!-- line 125 -->
		<search position="replace"><![CDATA[SELECT id_member, member_name, CASE WHEN id_group = {int:admin_group} OR FIND_IN_SET({int:admin_group}, additional_groups) != 0 THEN 1 ELSE 0 END AS is_admin
		FROM {db_prefix}members
		WHERE id_member IN ({array_int:user_list})
		LIMIT ' . count($users),
		array(]]></search>
		<add><![CDATA[SELECT mem.id_member, member_name, CASE WHEN COALESCE(pm.id_group, 0) = {int:admin_group} OR FIND_IN_SET({int:admin_group}, additional_groups) != 0 THEN 1 ELSE 0 END AS is_admin
		FROM {db_prefix}members mem
			LEFT JOIN {db_prefix}primary_membergroups AS pm ON (pm.id_member = mem.id_member AND pm.forumid = {int:forumid})
		WHERE mem.id_member IN ({array_int:user_list})
		LIMIT ' . count($users),
		array(
			'forumid' => (int) $forumid,]]></add>
	</operation>

	<!-- registerMember function -->
	<operation>	<!-- line 462 -->
		<search position="before"><![CDATA[global $user_info, $options, $settings, $smcFunc]]></search>
		<add><![CDATA[, $forumid]]></add>
	</operation>
	<operation>	<!-- line 654 -->
		<search position="before"><![CDATA['id_theme' => 0,]]></search>
		<add><![CDATA[
		'id_group' => !empty($modSettings['primary_membergroup']) ? $modSettings['primary_membergroup'] : '0',]]></add>
	</operation>
	<operation>	<!-- line 741 -->
		<search position="replace"><![CDATA['date_registered', 'posts', 'id_group', ]]></search>
		<add><![CDATA['date_registered', 'posts', ]]></add>
	</operation>
	<operation>	<!-- line 750 -->
		<search position="after"><![CDATA[$column_names = array();]]></search>
		<add><![CDATA[$new_id_group = -1;
	]]></add>
	</operation>
	<operation>	<!-- line 754 -->
		<search position="after"><![CDATA[$type = 'string';]]></search>
		<add><![CDATA[if ($var == 'id_group')
			$new_id_group = $val;
		]]></add>
	</operation>
	<operation>	<!-- line 775 -->
		<search position="after"><![CDATA[// Update the number of members and latest member's info - and pass the name, but remove the 's.]]></search>
		<add><![CDATA[if ($new_id_group != -1)
	{
		$smcFunc['db_insert']('',
			'{db_prefix}primary_membergroups',
			array('id_group' => 'int', 'id_member' => 'int', 'forumid' => 'int',),
			array($new_id_group, $memberID, $forumid),
			array()
		);
	}

	]]></add>
	</operation>

	<!-- membersAllowedTo function -->
	<operation>	<!-- line 1072 -->
		<search position="before"><![CDATA[function membersAllowedTo($permission, $board_id = null)
{
	global $smcFunc]]></search>
		<add><![CDATA[, $forumid]]></add>
	</operation>
	<operation>	<!-- line 1086 -->
		<search position="replace"><![CDATA[FROM {db_prefix}members AS mem' . ($include_moderators || $exclude_moderators ? '
			LEFT JOIN {db_prefix}moderators AS mods ON (mods.id_member = mem.id_member AND mods.id_board = {int:board_id})' : '') . '
		WHERE (' . ($include_moderators ? 'mods.id_member IS NOT NULL OR ' : '') . 'mem.id_group IN ({array_int:member_groups_allowed}) OR FIND_IN_SET({raw:member_group_allowed_implode}, mem.additional_groups) != 0)' . (empty($member_groups['denied']) ? '' : '
			AND NOT (' . ($exclude_moderators ? 'mods.id_member IS NOT NULL OR ' : '') . 'mem.id_group IN ({array_int:member_groups_denied}) OR FIND_IN_SET({raw:member_group_denied_implode}, mem.additional_groups) != 0)'),
		array(]]></search>
		<add><![CDATA[FROM {db_prefix}members AS mem
			LEFT JOIN {db_prefix}primary_membergroups AS pm ON (pm.id_member = mem.id_member AND pm.forumid = {int:forumid})' . ($include_moderators || $exclude_moderators ? '
			LEFT JOIN {db_prefix}moderators AS mods ON (mods.id_member = mem.id_member AND mods.id_board = {int:board_id})' : '') . '
		WHERE (' . ($include_moderators ? 'mods.id_member IS NOT NULL OR ' : '') . 'COALESCE(pm.id_group, 0) IN ({array_int:member_groups_allowed}) OR FIND_IN_SET({raw:member_group_allowed_implode}, mem.additional_groups) != 0)' . (empty($member_groups['denied']) ? '' : '
			AND NOT (' . ($exclude_moderators ? 'mods.id_member IS NOT NULL OR ' : '') . 'COALESCE(pm.id_group, 0) IN ({array_int:member_groups_denied}) OR FIND_IN_SET({raw:member_group_denied_implode}, mem.additional_groups) != 0)'),
		array(
			'forumid' => (int) $forumid,]]></add>
	</operation>

	<!-- list_getMembers function -->
	<operation>	<!-- line 1204 -->
		<search position="before"><![CDATA[function list_getMembers($start, $items_per_page, $sort, $where, $where_params = array(), $get_duplicates = false)
{
	global $smcFunc]]></search>
		<add><![CDATA[, $forumid]]></add>
	</operation>
	<operation>
		<search position="replace"><![CDATA[mem.posts, mem.is_activated, mem.date_registered, mem.id_group, mem.additional_groups, mg.group_name
		FROM {db_prefix}members AS mem
			LEFT JOIN {db_prefix}membergroups AS mg ON (mg.id_group = mem.id_group)
		WHERE ' . $where . '
		ORDER BY {raw:sort}
		LIMIT {int:start}, {int:per_page}',
		array_merge($where_params, array(]]></search>
		<add><![CDATA[mem.posts, mem.is_activated, mem.date_registered, COALESCE(pm.id_group, 0) AS id_group, mem.additional_groups, mg.group_name
		FROM {db_prefix}members AS mem
			LEFT JOIN {db_prefix}primary_membergroups AS pm ON (pm.id_member = mem.id_member AND pm.forumid = {int:forumid})
			LEFT JOIN {db_prefix}membergroups AS mg ON (mg.id_group = COALESCE(pm.id_group, 0))
		WHERE ' . $where . '
		ORDER BY {raw:sort}
		LIMIT {int:start}, {int:per_page}',
		array_merge($where_params, array(
			'forumid' => (int) $forumid,]]></add>
	</operation>
</file>
<file name="$sourcedir/Subs-MembersOnline.php">
	<!-- getMembersOnlineStats function -->
	<operation>	<!-- line 32 -->
		<search position="before"><![CDATA[global $smcFunc, $context, $scripturl, $user_info, $modSettings, $txt]]></search>
		<add><![CDATA[, $forumid]]></add>
	</operation>
	<operation>	<!-- line 78 -->
		<search position="replace"><![CDATA[LEFT JOIN {db_prefix}membergroups AS mg ON (mg.id_group = CASE WHEN mem.id_group = {int:reg_mem_group} THEN mem.id_post_group ELSE mem.id_group END)',
		array(]]></search>
		<add><![CDATA[LEFT JOIN {db_prefix}primary_membergroups AS pm ON (pm.id_member = mem.id_member AND pm.forumid = {int:forumid})
			LEFT JOIN {db_prefix}membergroups AS mg ON (mg.id_group = CASE WHEN COALESCE(pm.id_group, 0) = {int:reg_mem_group} THEN mem.id_post_group ELSE COALESCE(pm.id_group, 0) END)',
		array(
			'forumid' => (int) $forumid,]]></add>
	</operation>
</file>
<file name="$sourcedir/Subs-MessageIndex.php">
	<!-- getBoardList function -->
	<operation>	<!-- line 19 -->
		<search position="before"><![CDATA[global $smcFunc, $user_info]]></search>
		<add><![CDATA[, $forumid]]></add>
	</operation>
	<operation>	<!-- line 25 -->
		<search position="before"><![CDATA[$where_parameters = array(]]></search>
		<add><![CDATA['forumid' => (int) $forumid]]></add>
	</operation>
	<operation>	<!-- line 50 -->
		<search position="after"><![CDATA[$request = $smcFunc['db_query']('messageindex_fetch_boards', ']]></search>
		<add><![CDATA[$where[] = 'b.id_cat = c.id_cat';
	]]></add>
	</operation>
	<operation>	<!-- line 53 -->
		<search position="replace"><![CDATA[LEFT JOIN {db_prefix}categories AS c ON (c.id_cat = b.id_cat)' . (empty($where) ? '' : ']]></search>
		<add><![CDATA[LEFT JOIN {db_prefix}categories AS c ON (c.id_cat = b.id_cat AND c.forumid = {int:forumid})' . (empty($where) ? '' : ']]></add>
	</operation>
</file>
<file name="$sourcedir/Subs-OpenID.php">
	<!-- smf_openID_return function -->
	<operation>	<!-- line 220 -->
		<search position="before"><![CDATA[global $smcFunc, $user_info, $user_profile, $sourcedir, $modSettings, $context, $sc, $user_settings]]></search>
		<add><![CDATA[, $forumid]]></add>
	</operation>
	<operation>
		<search position="replace"><![CDATA[SELECT passwd, id_member, id_group, lngfile, is_activated, email_address, additional_groups, member_name, password_salt,
			openid_uri
		FROM {db_prefix}members
		WHERE openid_uri = {string:openid_uri}',
		array(]]></search>
		<add><![CDATA[SELECT passwd, mem.id_member, COALESCE(pm.id_group, 0) AS id_group, lngfile, is_activated, email_address, additional_groups, member_name, password_salt,
			openid_uri
		FROM {db_prefix}members mem
			LEFT JOIN {db_prefix}primary_membergroups AS pm ON (pm.id_member = mem.id_member AND pm.forumid = {int:forumid})
		WHERE openid_uri = {string:openid_uri}',
		array(
			'forumid' => (int) $forumid,]]></add>
	</operation>
</file>
<file name="$sourcedir/Subs-Post.php">
	<!-- sendpm function -->
	<operation>	<!-- line 879 -->
		<search position="before"><![CDATA[global $modSettings, $smcFunc]]></search>
		<add><![CDATA[, $forumid]]></add>
	</operation>
	<operation>	<!-- line 1043 -->
		<search position="replace"><![CDATA[member_name, real_name, id_member, email_address, lngfile,]]></search>
		<add><![CDATA[member_name, real_name, mem.id_member, email_address, lngfile,]]></add>
	</operation>
	<operation>	<!-- line 1049 -->
		<search position="replace"><![CDATA[additional_groups, id_group, id_post_group
		FROM {db_prefix}members
		WHERE id_member IN ({array_int:recipients})
		ORDER BY lngfile
		LIMIT {int:count_recipients}',
		array(]]></search>
		<add><![CDATA[additional_groups, COALESCE(pm.id_group, 0) AS id_group, id_post_group
		FROM {db_prefix}members mem
			LEFT JOIN {db_prefix}primary_membergroups AS pm ON (pm.id_member = mem.id_member AND pm.forumid = {int:forumid})
		WHERE mem.id_member IN ({array_int:recipients})
		ORDER BY lngfile
		LIMIT {int:count_recipients}',
		array(
			'forumid' => (int) $forumid,]]></add>
	</operation>

	<!-- sendNotifications function -->
	<operation>	<!-- line 1533 -->
		<search position="before"><![CDATA[global $modSettings, $sourcedir, $context, $smcFunc]]></search>
		<add><![CDATA[, $forumid]]></add>
	</operation>
	<operation>	<!-- line 1607 -->
		<search position="replace"><![CDATA[ln.sent, mem.id_group, mem.additional_groups, b.member_groups, mem.id_post_group, t.id_member_started,
			ln.id_topic
		FROM {db_prefix}log_notify AS ln
			INNER JOIN {db_prefix}members AS mem ON (mem.id_member = ln.id_member)]]></search>
		<add><![CDATA[ln.sent, COALESCE(pm.id_group, 0) AS id_group, mem.additional_groups, b.member_groups, mem.id_post_group, t.id_member_started,
			ln.id_topic
		FROM {db_prefix}log_notify AS ln
			INNER JOIN {db_prefix}members AS mem ON (mem.id_member = ln.id_member)
			LEFT JOIN {db_prefix}primary_membergroups AS pm ON (pm.id_member = mem.id_member AND pm.forumid = {int:forumid})]]></add>
	</operation>
	<operation>	<!-- line 1626 -->
		<search position="before"><![CDATA['members_only' => is_array($members_only) ? $members_only : array($members_only),]]></search>
		<add><![CDATA[
			'forumid' => (int) $forumid,]]></add>
	</operation>

	<!-- sendApprovalNotifications function -->
	<operation>	<!-- line 2835 -->
		<search position="before"><![CDATA[function sendApprovalNotifications(&$topicData)
{
	global $txt, $scripturl, $language, $user_info;
	global $modSettings, $sourcedir, $context, $smcFunc]]></search>
		<add><![CDATA[, $forumid]]></add>
	</operation>
	<operation>	<!-- line 2868 -->
		<search position="replace"><![CDATA[// Find everyone who needs to know about this.
	$members = $smcFunc['db_query']('', '
		SELECT
			mem.id_member, mem.email_address, mem.notify_regularity, mem.notify_types, mem.notify_send_body, mem.lngfile,
			ln.sent, mem.id_group, mem.additional_groups, b.member_groups, mem.id_post_group, t.id_member_started,
			ln.id_topic
		FROM {db_prefix}log_notify AS ln
			INNER JOIN {db_prefix}members AS mem ON (mem.id_member = ln.id_member)]]></search>
		<add><![CDATA[// Find everyone who needs to know about this.
	$members = $smcFunc['db_query']('', '
		SELECT
			mem.id_member, mem.email_address, mem.notify_regularity, mem.notify_types, mem.notify_send_body, mem.lngfile,
			ln.sent, COALESCE(pm.id_group, 0) AS id_group, mem.additional_groups, b.member_groups, mem.id_post_group, t.id_member_started,
			ln.id_topic
		FROM {db_prefix}log_notify AS ln
			INNER JOIN {db_prefix}members AS mem ON (mem.id_member = ln.id_member)
			LEFT JOIN {db_prefix}primary_membergroups AS pm ON (pm.id_member = mem.id_member AND pm.forumid = {int:forumid})]]></add>
	</operation>
	<operation>	<!-- line 2882 -->
		<search position="replace"><![CDATA[GROUP BY mem.id_member, ln.id_topic, mem.email_address, mem.notify_regularity, mem.notify_types, mem.notify_send_body, mem.lngfile, ln.sent, mem.id_group, mem.additional_groups, b.member_groups, mem.id_post_group, t.id_member_started
		ORDER BY mem.lngfile',
		array(]]></search>
		<add><![CDATA[GROUP BY mem.id_member, ln.id_topic, mem.email_address, mem.notify_regularity, mem.notify_types, mem.notify_send_body, mem.lngfile, ln.sent, COALESCE(pm.id_group, 0), mem.additional_groups, b.member_groups, mem.id_post_group, t.id_member_started
		ORDER BY mem.lngfile',
		array(
			'forumid' => (int) $forumid,]]></add>
	</operation>

	<!-- adminNotify function -->
	<operation>	<!-- line 3091 -->
		<search position="before"><![CDATA[global $txt, $modSettings, $language, $scripturl, $user_info, $context, $smcFunc]]></search>
		<add><![CDATA[, $forumid]]></add>
	</operation>
	<operation>	<!-- line 3139 -->
		<search position="replace"><![CDATA[SELECT id_member, lngfile, email_address
		FROM {db_prefix}members
		WHERE (id_group IN ({array_int:group_list}) OR FIND_IN_SET({raw:group_array_implode}, additional_groups) != 0)
			AND notify_types != {int:notify_types}
		ORDER BY lngfile',
		array(]]></search>
		<add><![CDATA[SELECT mem.id_member, mem.lngfile, mem.email_address
		FROM {db_prefix}members mem
			LEFT JOIN {db_prefix}primary_membergroups AS pm ON (pm.id_member = mem.id_member AND pm.forumid = {int:forumid})
		WHERE (COALESCE(pm.id_group, 0) IN ({array_int:group_list}) OR FIND_IN_SET({raw:group_array_implode}, additional_groups) != 0)
			AND notify_types != {int:notify_types}
		ORDER BY lngfile',
		array(
			'forumid' => (int) $forumid,]]></add>
	</operation>
</file>
<file name="$sourcedir/Subs.php">
	<!-- updateMemberData function -->
	<operation>	<!-- line 435 -->
		<search position="before"><![CDATA[function updateMemberData($members, $data)
{
	global $modSettings, $user_info, $smcFunc]]></search>
		<add><![CDATA[, $forumid]]></add>
	</operation>
	<operation>	<!-- line 500 -->
		<search position="replace"><![CDATA['date_registered', 'posts', 'id_group',]]></search>
		<add><![CDATA['date_registered', 'posts',]]></add>
	</operation>
	<operation>	<!-- line 509 -->
		<search position="replace"><![CDATA[$setString = '';
	foreach ($data as $var => $val)
	{
		$type = 'string';]]></search>
		<add><![CDATA[$new_id_group = -1;

	$setString = '';
	foreach ($data as $var => $val)
	{
		if ($var == 'id_group')
		{
			$new_id_group = $val;
			continue;
		}

		$type = 'string';]]></add>
	</operation>
	<operation>	<!-- line 549 -->
		<search position="after"><![CDATA[updateStats('postgroups', $members, array_keys($data));]]></search>
		<add><![CDATA[if ($new_id_group != -1)
	{
		if (is_array($members))
		{
			if ($new_id_group == 0)
			{
				$smcFunc['db_query']('', '
						DELETE FROM {db_prefix}primary_membergroups
						WHERE id_member IN ({array_int:members}) AND forumid = {int:forumid}',
					array(
						'members' => $members,
						'forumid' => (int) $forumid,
					)
				);
			}
			else
			{
				foreach ($members as $id_member)
				{
					$smcFunc['db_insert']('replace',
						'{db_prefix}primary_membergroups',
						array('id_group' => 'int', 'id_member' => 'int', 'forumid' => 'int',),
						array($new_id_group, $id_member, $forumid),
						array());
				}
			}
		}
		elseif ($members === null)
		{
			if ($new_id_group == 0)
			{
				// This seems like a bad idea... but okay!
				$smcFunc['db_query']('', '
						DELETE FROM {db_prefix}primary_membergroups
						WHERE forumid = {int:forumid}',
					array(
						'forumid' => (int) $forumid,
					)
				);
			}
			else
			{
				$smcFunc['db_query']('', '
						INSERT INTO {db_prefix}primary_membergroups
						(id_group, forumid, id_member)
						SELECT {int:id_group}, {int:forumid}, mem.id_member FROM {db_prefix}members mem
						ON DUPLICATE KEY UPDATE id_group = {int:id_group}',
					array(
						'id_group' => $new_id_group,
						'forumid' => (int) $forumid,
					)
				);
			}
		}
		else
		{
			$smcFunc['db_insert']('replace',
				'{db_prefix}primary_membergroups',
				array('id_group' => 'int', 'id_member' => 'int', 'forumid' => 'int',),
				array($new_id_group, $members, $forumid),
				array());
		}
	}

	]]></add>
	</operation>

	<!-- writeLog function -->
	<operation>	<!-- line 2577 -->
		<search position="before"><![CDATA[global $user_info, $user_settings, $context, $modSettings, $settings, $topic, $board, $smcFunc, $sourcedir]]></search>
		<add><![CDATA[, $forumid]]></add>
	</operation>
	<operation>	<!-- line 2606 -->
		<search position="replace"><![CDATA[$serialized = $_GET + array('USER_AGENT' => $_SERVER['HTTP_USER_AGENT']);]]></search>
		<add><![CDATA[$serialized = $_GET + array('USER_AGENT' => $_SERVER['HTTP_USER_AGENT'], 'forumid' => $forumid);]]></add>
	</operation>

	<!-- setupThemeContext function -->
	<operation>	<!-- line 3190 -->
		<search position="after"><![CDATA[;
	static $loaded = false;]]></search>
		<add><![CDATA[, $forumid]]></add>
	</operation>
	<operation>	<!-- line 3205 -->
		<search position="replace"><![CDATA[$context['news_lines'] = explode("\n", str_replace("\r", '', trim(addslashes($modSettings['news']))));]]></search>
		<add><![CDATA[$tmp = (empty($forumid) ? '' : $forumid);
	$context['news_lines'] = explode("\n", str_replace("\r", '', trim(addslashes($modSettings['news' . $tmp]))));]]></add>
	</operation>

	<!-- setupMenuContext function -->
	<operation>	<!-- line 3905 -->
		<search position="before"><![CDATA[global $context, $modSettings, $user_info, $txt, $scripturl]]></search>
		<add><![CDATA[, $forumid]]></add>
	</operation>
	<operation>	<!-- line 3954 -->
		<search position="replace"><![CDATA['href' => $scripturl . '?action=admin;area=packages',
						'show' => allowedTo('admin_forum'),]]></search>
		<add><![CDATA['href' => $scripturl . '?action=admin;area=packages',
						'show' => allowedTo('admin_forum') && empty($formid),]]></add>
	</operation>
</file>
<file name="$sourcedir/Who.php">
	<!-- Who function -->
	<operation>	<!-- line 55 -->
		<search position="before"><![CDATA[global $context, $scripturl, $user_info, $txt, $modSettings, $memberContext, $smcFunc]]></search>
		<add><![CDATA[, $forumid]]></add>
	</operation>
	<operation>	<!-- line 125 -->
		<search position="after"><![CDATA[if (!allowedTo('moderate_forum'))]]></search>
		<add><![CDATA[if (!empty($modSettings['subforum_settings_show_who_in_subforum']))
		$conditions[] = 'INSTR(lo.url, {string:in_url_string}) > 0';
	]]></add>
	</operation>
	<operation>	<!-- line 148 -->
		<search position="before"><![CDATA[SELECT COUNT(*)
		FROM {db_prefix}log_online AS lo
			LEFT JOIN {db_prefix}members AS mem ON (lo.id_member = mem.id_member)' . (!empty($conditions) ? '
		WHERE ' . implode(' AND ', $conditions) : ''),
		array(]]></search>
		<add><![CDATA[
			'in_url_string' => 's:7:"forumid";i:' . ((int) $forumid) . ';',]]></add>
	</operation>
	<operation>	<!-- line 170 -->
		<search position="replace"><![CDATA[LEFT JOIN {db_prefix}membergroups AS mg ON (mg.id_group = CASE WHEN mem.id_group = {int:regular_member} THEN mem.id_post_group ELSE mem.id_group END)' . (!empty($conditions) ? '
		WHERE ' . implode(' AND ', $conditions) : '') . '
		ORDER BY {raw:sort_method} {raw:sort_direction}
		LIMIT {int:offset}, {int:limit}',
		array(]]></search>
		<add><![CDATA[LEFT JOIN {db_prefix}primary_membergroups AS pm ON (pm.id_member = mem.id_member AND pm.forumid = {int:forumid})
			LEFT JOIN {db_prefix}membergroups AS mg ON (mg.id_group = CASE WHEN COALESCE(pm.id_group, 0) = {int:regular_member} THEN mem.id_post_group ELSE COALESCE(pm.id_group, 0) END)' . (!empty($conditions) ? '
		WHERE ' . implode(' AND ', $conditions) : '') . '
		ORDER BY {raw:sort_method} {raw:sort_direction}
		LIMIT {int:offset}, {int:limit}',
		array(
			'forumid' => (int) $forumid,
			'in_url_string' => 's:7:"forumid";i:' . ((int) $forumid) . ';',]]></add>
	</operation>
</file>

<!---------------------------------------------------------------------------->
<!-- SSI.php support function edits 										-->
<!---------------------------------------------------------------------------->
<file name="$boarddir/SSI.php">
	<!-- ssi_queryPosts function -->
	<operation>	<!-- line 321 -->
		<search position="before"><![CDATA[function ssi_queryPosts($query_where = '', $query_where_params = array(), $query_limit = 10, $query_order = 'm.id_msg DESC', $output_method = 'echo', $limit_body = false, $override_permissions = false)
{
	global $context, $settings, $scripturl, $txt, $db_prefix, $user_info]]></search>
		<add><![CDATA[, $forumid]]></add>
	</operation>
	<operation>	<!-- line 333 -->
		<search position="replace"><![CDATA[LEFT JOIN {db_prefix}members AS mem ON (mem.id_member = m.id_member)' . (!$user_info['is_guest'] ? '
			LEFT JOIN {db_prefix}log_topics AS lt ON (lt.id_topic = m.id_topic AND lt.id_member = {int:current_member})
			LEFT JOIN {db_prefix}log_mark_read AS lmr ON (lmr.id_board = m.id_board AND lmr.id_member = {int:current_member})' : '') . '
		WHERE 1=1 ' . ($override_permissions ? '' : '
			AND {query_wanna_see_board}') . ($modSettings['postmod_active'] ? '
			AND m.approved = {int:is_approved}' : '') . '
			' . (empty($query_where) ? '' : 'AND ' . $query_where) . '
		ORDER BY ' . $query_order . '
		' . ($query_limit == '' ? '' : 'LIMIT ' . $query_limit),
		array_merge($query_where_params, array(]]></search>
		<add><![CDATA[INNER JOIN {db_prefix}categories AS c ON (c.id_cat = b.id_cat)
			LEFT JOIN {db_prefix}members AS mem ON (mem.id_member = m.id_member)' . (!$user_info['is_guest'] ? '
			LEFT JOIN {db_prefix}log_topics AS lt ON (lt.id_topic = m.id_topic AND lt.id_member = {int:current_member})
			LEFT JOIN {db_prefix}log_mark_read AS lmr ON (lmr.id_board = m.id_board AND lmr.id_member = {int:current_member})' : '') . '
		WHERE c.forumid = {int:forumid} ' . ($override_permissions ? '' : '
			AND {query_wanna_see_board}') . ($modSettings['postmod_active'] ? '
			AND m.approved = {int:is_approved}' : '') . '
			' . (empty($query_where) ? '' : 'AND ' . $query_where) . '
		ORDER BY ' . $query_order . '
		' . ($query_limit == '' ? '' : 'LIMIT ' . $query_limit),
		array_merge($query_where_params, array(
			'forumid' => (int) $forumid,]]></add>
	</operation>

	<!-- ssi_recentTopics function -->
	<operation>	<!-- line 415 -->
		<search position="before"><![CDATA[function ssi_recentTopics($num_recent = 8, $exclude_boards = null, $include_boards = null, $output_method = 'echo')
{
	global $context, $settings, $scripturl, $txt, $db_prefix, $user_info]]></search>
		<add><![CDATA[, $forumid]]></add>
	</operation>
	<operation>	<!-- line 451 -->
		<search position="replace"><![CDATA[INNER JOIN {db_prefix}messages AS ms ON (ms.id_msg = t.id_first_msg)
			LEFT JOIN {db_prefix}members AS mem ON (mem.id_member = m.id_member)' . (!$user_info['is_guest'] ? '
			LEFT JOIN {db_prefix}log_topics AS lt ON (lt.id_topic = t.id_topic AND lt.id_member = {int:current_member})
			LEFT JOIN {db_prefix}log_mark_read AS lmr ON (lmr.id_board = b.id_board AND lmr.id_member = {int:current_member})' : '') . '
		WHERE t.id_last_msg >= {int:min_message_id}
			' . (empty($exclude_boards) ? '' : '
			AND b.id_board NOT IN ({array_int:exclude_boards})') . '
			' . (empty($include_boards) ? '' : '
			AND b.id_board IN ({array_int:include_boards})') . '
			AND {query_wanna_see_board}' . ($modSettings['postmod_active'] ? '
			AND t.approved = {int:is_approved}
			AND m.approved = {int:is_approved}' : '') . '
		ORDER BY t.id_last_msg DESC
		LIMIT ' . $num_recent,
		array(]]></search>
		<add><![CDATA[INNER JOIN {db_prefix}categories AS c ON (c.id_cat = b.id_cat)
			INNER JOIN {db_prefix}messages AS ms ON (ms.id_msg = t.id_first_msg)
			LEFT JOIN {db_prefix}members AS mem ON (mem.id_member = m.id_member)' . (!$user_info['is_guest'] ? '
			LEFT JOIN {db_prefix}log_topics AS lt ON (lt.id_topic = t.id_topic AND lt.id_member = {int:current_member})
			LEFT JOIN {db_prefix}log_mark_read AS lmr ON (lmr.id_board = b.id_board AND lmr.id_member = {int:current_member})' : '') . '
		WHERE t.id_last_msg >= {int:min_message_id}
			AND c.forumid = {int:forumid}
			' . (empty($exclude_boards) ? '' : '
			AND b.id_board NOT IN ({array_int:exclude_boards})') . '
			' . (empty($include_boards) ? '' : '
			AND b.id_board IN ({array_int:include_boards})') . '
			AND {query_wanna_see_board}' . ($modSettings['postmod_active'] ? '
			AND t.approved = {int:is_approved}
			AND m.approved = {int:is_approved}' : '') . '
		ORDER BY t.id_last_msg DESC
		LIMIT ' . $num_recent,
		array(
			'forumid' => (int) $forumid,]]></add>
	</operation>

	<!-- ssi_topBoards function -->
	<operation>	<!-- line 585 -->
		<search position="before"><![CDATA[function ssi_topBoards($num_top = 10, $output_method = 'echo')
{
	global $context, $settings, $db_prefix, $txt, $scripturl, $user_info, $modSettings, $smcFunc]]></search>
		<add><![CDATA[, $forumid]]></add>
	</operation>
	<operation>	<!-- line 593 -->
		<search position="replace"><![CDATA[LEFT JOIN {db_prefix}log_boards AS lb ON (lb.id_board = b.id_board AND lb.id_member = {int:current_member})
		WHERE {query_wanna_see_board}' . (!empty($modSettings['recycle_enable']) && $modSettings['recycle_board'] > 0 ? '
			AND b.id_board != {int:recycle_board}' : '') . '
		ORDER BY b.num_posts DESC
		LIMIT ' . $num_top,
		array(]]></search>
		<add><![CDATA[INNER JOIN {db_prefix}categories AS c ON (c.id_cat = b.id_cat)
			LEFT JOIN {db_prefix}log_boards AS lb ON (lb.id_board = b.id_board AND lb.id_member = {int:current_member})
		WHERE {query_wanna_see_board}' . (!empty($modSettings['recycle_enable']) && $modSettings['recycle_board'] > 0 ? '
			AND b.id_board != {int:recycle_board}' : '') . '
			AND c.forumid = {int:forumid}
		ORDER BY b.num_posts DESC
		LIMIT ' . $num_top,
		array(
			'forumid' => (int) $forumid,]]></add>
	</operation>

	<!-- ssi_topTopics function -->
	<operation>	<!-- line 639 -->
		<search position="before"><![CDATA[function ssi_topTopics($type = 'replies', $num_topics = 10, $output_method = 'echo')
{
	global $db_prefix, $txt, $scripturl, $user_info, $modSettings, $smcFunc, $context]]></search>
		<add><![CDATA[, $forumid]]></add>
	</operation>
	<operation>	<!-- line 647 -->
		<search position="replace"><![CDATA[SELECT id_topic
			FROM {db_prefix}topics
			WHERE num_' . ($type != 'replies' ? 'views' : 'replies') . ' != 0' . ($modSettings['postmod_active'] ? '
				AND approved = {int:is_approved}' : '') . '
			ORDER BY num_' . ($type != 'replies' ? 'views' : 'replies') . ' DESC
			LIMIT {int:limit}',
			array(]]></search>
		<add><![CDATA[SELECT t.id_topic
			FROM {db_prefix}topics AS t
				INNER JOIN {db_prefix}boards AS b ON (b.id_board = t.id_board)
				INNER JOIN {db_prefix}categories AS c ON (c.id_cat = b.id_cat)
			WHERE t.num_' . ($type != 'replies' ? 'views' : 'replies') . ' != 0' . ($modSettings['postmod_active'] ? '
				AND t.approved = {int:is_approved}' : '') . '
				AND c.forumid = {int:forumid}
			ORDER BY num_' . ($type != 'replies' ? 'views' : 'replies') . ' DESC
			LIMIT {int:limit}',
			array(
				'forumid' => (int) $forumid,]]></add>
	</operation>
	<operation>	<!-- line 671 -->
		<search position="replace"><![CDATA[
		WHERE {query_wanna_see_board}' . ($modSettings['postmod_active'] ? '
			AND t.approved = {int:is_approved}' : '') . (!empty($topic_ids) ? '
			AND t.id_topic IN ({array_int:topic_list})' : '') . (!empty($modSettings['recycle_enable']) && $modSettings['recycle_board'] > 0 ? '
			AND b.id_board != {int:recycle_enable}' : '') . '
		ORDER BY t.num_' . ($type != 'replies' ? 'views' : 'replies') . ' DESC
		LIMIT {int:limit}',
		array(]]></search>
		<add><![CDATA[
			INNER JOIN {db_prefix}categories AS c ON (c.id_cat = b.id_cat)
		WHERE {query_wanna_see_board}' . ($modSettings['postmod_active'] ? '
			AND t.approved = {int:is_approved}' : '') . (!empty($topic_ids) ? '
			AND t.id_topic IN ({array_int:topic_list})' : '') . (!empty($modSettings['recycle_enable']) && $modSettings['recycle_board'] > 0 ? '
			AND b.id_board != {int:recycle_enable}' : '') . '
			AND c.forumid = {int:forumid}
		ORDER BY t.num_' . ($type != 'replies' ? 'views' : 'replies') . ' DESC
		LIMIT {int:limit}',
		array(
			'forumid' => (int) $forumid,]]></add>
	</operation>

	<!-- ssi_fetchGroupMembers function -->
	<operation>	<!-- line 822 -->
		<search position="replace"><![CDATA[$query_where = '
		id_group = {int:id_group}]]></search>
		<add><![CDATA[$query_where = '
		COALESCE(pm.id_group, 0) = {int:id_group}]]></add>
	</operation>

	<!-- ssi_queryMembers function -->
	<operation>	<!-- line 835 -->
		<search position="before"><![CDATA[function ssi_queryMembers($query_where = null, $query_where_params = array(), $query_limit = '', $query_order = 'id_member DESC', $output_method = 'echo')
{
	global $context, $settings, $scripturl, $txt, $db_prefix, $user_info]]></search>
		<add><![CDATA[, $forumid]]></add>
	</operation>
	<operation>	<!-- line 845 -->
		<search position="replace"><![CDATA[SELECT id_member
		FROM {db_prefix}members
		WHERE ' . $query_where . '
		ORDER BY ' . $query_order . '
		' . ($query_limit == '' ? '' : 'LIMIT ' . $query_limit),
		array_merge($query_where_params, array(]]></search>
		<add><![CDATA[SELECT mem.id_member
		FROM {db_prefix}members AS mem
			LEFT JOIN {db_prefix}primary_membergroups AS pm ON (pm.id_member = mem.id_member AND pm.forumid = {int:forumid})
		WHERE ' . $query_where . '
		ORDER BY ' . $query_order . '
		' . ($query_limit == '' ? '' : 'LIMIT ' . $query_limit),
		array_merge($query_where_params, array(
			'forumid' => (int) $forumid,]]></add>
	</operation>

	<!-- ssi_boardStats function -->
	<operation>	<!-- line 901 -->
		<search position="before"><![CDATA[function ssi_boardStats($output_method = 'echo')
{
	global $db_prefix, $txt, $scripturl, $modSettings, $smcFunc]]></search>
		<add><![CDATA[, $forumid]]></add>
	</operation>
	<operation>	<!-- line 912 -->
		<search position="replace"><![CDATA[$totals = array(
		'members' => $modSettings['totalMembers'],
		'posts' => $modSettings['totalMessages'],
		'topics' => $modSettings['totalTopics']
	);

	$result = $smcFunc['db_query']('', '
		SELECT COUNT(*)
		FROM {db_prefix}boards',
		array(]]></search>
		<add><![CDATA[$result = $smcFunc['db_query']('', '
		SELECT COUNT(b.id_board) AS boards, SUM(b.num_topics) AS topics, SUM(b.num_posts) AS posts
		FROM {db_prefix}boards AS b
			INNER JOIN {db_prefix}categories AS c ON (c.id_cat = b.id_cat)
		WHERE c.forumid = {int:forumid}',
		array(
			'forumid' => (int) $forumid,]]></add>
	</operation>
	<operation>	<!-- line 917 -->
		<search position="replace"><![CDATA[list ($totals['boards']) = $smcFunc['db_fetch_row']($result);]]></search>
		<add><![CDATA[$row = $smcFunc['db_fetch_assoc']($result);
	$totals = array(
		'members' => $modSettings['totalMembers'],
		'boards' => $row['boards'],
		'topics' => $row['topics'],
		'posts' => $row['posts'],
	);]]></add>
	</operation>
	<operation>	<!-- line 921 -->
		<search position="replace"><![CDATA[SELECT COUNT(*)
		FROM {db_prefix}categories',
		array(]]></search>
		<add><![CDATA[SELECT COUNT(*)
		FROM {db_prefix}categories AS c
		WHERE c.forumid = {int:forumid}',
		array(
			'forumid' => (int) $forumid,]]></add>
	</operation>

	<!-- ssi_recentPoll function -->
	<operation>	<!-- line 1048 -->
		<search position="before"><![CDATA[function ssi_recentPoll($topPollInstead = false, $output_method = 'echo')
{
	global $db_prefix, $txt, $settings, $boardurl, $user_info, $context, $smcFunc, $modSettings]]></search>
		<add><![CDATA[, $forumid]]></add>
	</operation>
	<operation>	<!-- line 1059 -->
		<search position="replace"><![CDATA[INNER JOIN {db_prefix}boards AS b ON (b.id_board = t.id_board)' . ($topPollInstead ? ']]></search>
		<add><![CDATA[INNER JOIN {db_prefix}boards AS b ON (b.id_board = t.id_board)
			INNER JOIN {db_prefix}categories AS c ON (c.id_cat = b.id_cat)' . ($topPollInstead ? ']]></add>
	</operation>
	<operation>	<!-- line 1066 -->
		<search position="replace"><![CDATA[AND b.id_board IN ({array_int:boards_allowed_list})' : '') . (!empty($modSettings['recycle_enable']) && $modSettings['recycle_board'] > 0 ? '
			AND b.id_board != {int:recycle_enable}' : '') . '
		ORDER BY ' . ($topPollInstead ? 'pc.votes' : 'p.id_poll') . ' DESC
		LIMIT 1',
		array(]]></search>
		<add><![CDATA[AND b.id_board IN ({array_int:boards_allowed_list})' : '') . (!empty($modSettings['recycle_enable']) && $modSettings['recycle_board'] > 0 ? '
			AND b.id_board != {int:recycle_enable}' : '') . '
			AND c.forumid = {int:forumid}
		ORDER BY ' . ($topPollInstead ? 'pc.votes' : 'p.id_poll') . ' DESC
		LIMIT 1',
		array(
			'forumid' => (int) $forumid,]]></add>
	</operation>

	<!-- ssi_showPoll function -->
	<operation>	<!-- line 1178 -->
		<search position="before"><![CDATA[function ssi_showPoll($topic = null, $output_method = 'echo')
{
	global $db_prefix, $txt, $settings, $boardurl, $user_info, $context, $smcFunc, $modSettings]]></search>
		<add><![CDATA[, $forumid]]></add>
	</operation>
	<operation>	<!-- line 1197 -->
		<search position="replace"><![CDATA[INNER JOIN {db_prefix}boards AS b ON (b.id_board = t.id_board)
		WHERE t.id_topic = {int:current_topic}
			AND {query_see_board}' . (!in_array(0, $boardsAllowed) ? '
			AND b.id_board IN ({array_int:boards_allowed_see})' : '') . ($modSettings['postmod_active'] ? '
			AND t.approved = {int:is_approved}' : '') . '
		LIMIT 1',
		array(]]></search>
		<add><![CDATA[INNER JOIN {db_prefix}boards AS b ON (b.id_board = t.id_board)
			INNER JOIN {db_prefix}categories AS c ON (c.id_cat = b.id_cat)
		WHERE t.id_topic = {int:current_topic}
			AND c.forumid = {int:forumid}
			AND {query_see_board}' . (!in_array(0, $boardsAllowed) ? '
			AND b.id_board IN ({array_int:boards_allowed_see})' : '') . ($modSettings['postmod_active'] ? '
			AND t.approved = {int:is_approved}' : '') . '
		LIMIT 1',
		array(
			'forumid' => (int) $forumid,]]></add>
	</operation>

	<!-- ssi_pollVote function -->
	<operation>	<!-- line 1372 -->
		<search position="before"><![CDATA[function ssi_pollVote()
{
	global $context, $db_prefix, $user_info, $sc, $smcFunc, $sourcedir, $modSettings]]></search>
		<add><![CDATA[, $forumid]]></add>
	</operation>
	<operation>	<!-- line 1401 -->
		<search position="replace"><![CDATA[INNER JOIN {db_prefix}boards AS b ON (b.id_board = t.id_board)
			LEFT JOIN {db_prefix}log_polls AS lp ON (lp.id_poll = p.id_poll AND lp.id_member = {int:current_member})
		WHERE p.id_poll = {int:current_poll}
			AND {query_see_board}' . ($modSettings['postmod_active'] ? '
			AND t.approved = {int:is_approved}' : '') . '
		LIMIT 1',
		array(]]></search>
		<add><![CDATA[INNER JOIN {db_prefix}boards AS b ON (b.id_board = t.id_board)
			INNER JOIN {db_prefix}categories AS c ON (c.id_cat = b.id_cat)
			LEFT JOIN {db_prefix}log_polls AS lp ON (lp.id_poll = p.id_poll AND lp.id_member = {int:current_member})
		WHERE p.id_poll = {int:current_poll}
			AND c.forumid = {int:forumid}
			AND {query_see_board}' . ($modSettings['postmod_active'] ? '
			AND t.approved = {int:is_approved}' : '') . '
		LIMIT 1',
		array(
			'forumid' => (int) $forumid,]]></add>
	</operation>

	<!-- ssi_boardNews function -->
	<operation>	<!-- line 1617 -->
		<search position="before"><![CDATA[function ssi_boardNews($board = null, $limit = null, $start = null, $length = null, $output_method = 'echo')
{
	global $scripturl, $db_prefix, $txt, $settings, $modSettings, $context]]></search>
		<add><![CDATA[, $forumid]]></add>
	</operation>
	<operation>	<!-- line 1650 -->
		<search position="replace"><![CDATA[SELECT id_board
		FROM {db_prefix}boards
		WHERE ' . ($board === null ? '' : 'id_board = {int:current_board}
			AND ') . 'FIND_IN_SET(-1, member_groups) != 0
		LIMIT 1',
		array(]]></search>
		<add><![CDATA[SELECT b.id_board
		FROM {db_prefix}boards AS b
			INNER JOIN {db_prefix}categories AS c ON (c.id_cat = b.id_cat)
		WHERE ' . ($board === null ? '' : 'id_board = {int:current_board}
			AND ') . 'FIND_IN_SET(-1, member_groups) != 0
		LIMIT 1',
		array(]]></add>
	</operation>
	<operation>	<!-- line 1679 -->
		<search position="replace"><![CDATA[LEFT JOIN {db_prefix}boards as b ON (b.id_board = t.id_board)
		WHERE t.id_board = {int:current_board}' . ($modSettings['postmod_active'] ? '
			AND t.approved = {int:is_approved}' : '') . '
			AND {query_see_board}
		ORDER BY t.id_first_msg DESC
		LIMIT ' . $start . ', ' . $limit,
		array(]]></search>
		<add><![CDATA[	LEFT JOIN {db_prefix}boards as b ON (b.id_board = t.id_board)
			INNER JOIN {db_prefix}categories AS c ON (c.id_cat = b.id_cat)
		WHERE t.id_board = {int:current_board}' . ($modSettings['postmod_active'] ? '
			AND t.approved = {int:is_approved}' : '') . '
			AND {query_see_board}
		ORDER BY t.id_first_msg DESC
		LIMIT ' . $start . ', ' . $limit,
		array(
			'forumid' => (int) $forumid,]]></add>
	</operation>

	<!-- ssi_recentAttachments function -->
	<operation>	<!-- line 1900 -->
		<search position="before"><![CDATA[function ssi_recentAttachments($num_attachments = 10, $attachment_ext = array(), $output_method = 'echo')
{
	global $smcFunc, $context, $modSettings, $scripturl, $txt, $settings]]></search>
		<add><![CDATA[, $forumid]]></add>
	</operation>
	<operation>	<!-- line 1923 -->
		<search position="replace"><![CDATA[INNER JOIN {db_prefix}topics AS t ON (t.id_topic = m.id_topic)
			LEFT JOIN {db_prefix}members AS mem ON (mem.id_member = m.id_member)' . (empty($modSettings['attachmentShowImages']) || empty($modSettings['attachmentThumbnails']) ? '' : '
			LEFT JOIN {db_prefix}attachments AS thumb ON (thumb.id_attach = att.id_thumb)') . '
		WHERE att.attachment_type = 0' . ($attachments_boards === array(0) ? '' : '
			AND m.id_board IN ({array_int:boards_can_see})') . (!empty($attachment_ext) ? '
			AND att.fileext IN ({array_string:attachment_ext})' : '') .
			(!$modSettings['postmod_active'] || allowedTo('approve_posts') ? '' : '
			AND t.approved = {int:is_approved}
			AND m.approved = {int:is_approved}
			AND att.approved = {int:is_approved}') . '
		ORDER BY att.id_attach DESC
		LIMIT {int:num_attachments}',
		array(]]></search>
		<add><![CDATA[INNER JOIN {db_prefix}topics AS t ON (t.id_topic = m.id_topic)
			INNER JOIN {db_prefix}boards AS b ON (b.id_board = t.id_board)
			INNER JOIN {db_prefix}categories AS c ON (c.id_cat = b.id_cat)
			LEFT JOIN {db_prefix}members AS mem ON (mem.id_member = m.id_member)' . (empty($modSettings['attachmentShowImages']) || empty($modSettings['attachmentThumbnails']) ? '' : '
			LEFT JOIN {db_prefix}attachments AS thumb ON (thumb.id_attach = att.id_thumb)') . '
		WHERE att.attachment_type = 0' . ($attachments_boards === array(0) ? '' : '
			AND m.id_board IN ({array_int:boards_can_see})') . (!empty($attachment_ext) ? '
			AND att.fileext IN ({array_string:attachment_ext})' : '') .
			(!$modSettings['postmod_active'] || allowedTo('approve_posts') ? '' : '
			AND t.approved = {int:is_approved}
			AND m.approved = {int:is_approved}
			AND att.approved = {int:is_approved}') . '
			AND c.forumid = {int:forumid}
		ORDER BY att.id_attach DESC
		LIMIT {int:num_attachments}',
		array(
			'forumid' => (int) $forumid,]]></add>
	</operation>
</file>

<!---------------------------------------------------------------------------->
<!-- Theme file edits														-->
<!---------------------------------------------------------------------------->
<file name="$themedir/index.template.php">
	<!-- template_html_above function -->
	<operation>	<!-- line 80 -->
		<search position="before"><![CDATA[function template_html_above()
{
	global $context, $settings, $options, $scripturl, $txt, $modSettings]]></search>
		<add><![CDATA[, $favicon]]></add>
	</operation>
	<operation>	<!-- line 165 -->
		<search position="after"><![CDATA[	echo '
</head>]]></search>
		<add><![CDATA[
	// Output link to the favicon file, if available:
	if (!empty($favicon))
		echo '<link rel="shortcut icon" href="'.$favicon.'" type="image/x-icon" />
<link rel="icon" href="'.$favicon.'" type="image/x-icon" />';

]]></add>
	</operation>
</file>
<file name="$themedir/ManageBoards.template.php">
	<!-- template_main function -->
	<operation>	<!-- line 17 -->
		<search position="replace"><![CDATA[
	// Table header.
	echo ']]></search>
		<add><![CDATA[	global $subforum_tree, $cat_tree, $forumid;

	// Table header.
	echo '
	<script type="text/javascript">
		function expandTabs(forum)
		{
			';
	foreach ($subforum_tree as $subforum => $info)
		echo 'document.getElementById("subforum' . $subforum . '").style.display = (forum == ' . $subforum . ' ? "" : "none");
			document.getElementById("tab' . $subforum . '").className = (forum == ' . $subforum . ' ? "tabActiveHeader" : "");
			';
	echo '
		}
	</script>]]></add>
	</operation>
	<operation>	<!-- line 31 -->
		<search position="replace"><![CDATA[// No categories so show a label.
	if (empty($context['categories']))
		echo '
		<div class="windowbg">
			<span class="topslice"><span></span></span>
			<div class="content centertext">
				', $txt['mboards_no_cats'], '
			</div>
			<span class="botslice"><span></span></span>
		</div>';]]></search>
		<add><![CDATA[// Display the subforums as a tab at the top of the screen:
	$flagged = array( 0 => false );
	if (count($subforum_tree) > 1)
	{
		echo '
		<div id="tabContainer">
			<div class="tabs">
				<ul>';
		foreach ($subforum_tree as $id => $section)
		{
			echo '
					<li', ($id == $context['req_forumid'] ? ' class="tabActiveHeader"' : ''), ' id="tab' . $id . '"><a href="javascript:void(0);" onclick="expandTabs(' . $id . '); return false;">', (isset($section['boardname']) ? $section['boardname'] : '# '.$section['forumid']), '</a></li>';
			$flagged[$id] = false;
		}
		echo '
				</ul>
			</div>
		</div>';
	}]]></add>
	</operation>
	<operation>	<!-- line 42 -->
		<search position="replace"><![CDATA[// Loop through every category, listing the boards in each as we go.
	foreach ($context['categories'] as $category)
	{]]></search>
		<add><![CDATA[// Loop through every category, listing the boards in each as we go.
	$last_forumid = -1;
	foreach ($context['categories'] as $category)
	{
		// If this is a different subforum, place it in a div:
		if ($last_forumid <> $category['forumid'])
		{
			if ($last_forumid > -1)
				echo '</div>';
			echo '<div id="subforum' . $category['forumid'] . '"' . ($context['req_forumid'] <> (int)$category['forumid'] ? ' style="display: none;"' : '') . '>';
			$last_forumid = $category['forumid'];
			$flagged[$category['forumid']] = true;
		}

]]></add>
	</operation>
	<operation>	<!-- line 49 -->
		<search position="replace"><![CDATA[<a href="' . $scripturl . '?action=admin;area=manageboards;sa=cat;cat=' . $category['id'] . '">', $category['name'], '</a> <a href="' . $scripturl . '?action=admin;area=manageboards;sa=cat;cat=' . $category['id'] . '">', $txt['catModify'], '</a>]]></search>
		<add><![CDATA[<a href="' . $scripturl . '?action=admin;area=manageboards;sa=cat;cat=' . $category['id'] . ($forumid == 0 ? ';sub=' . $category['forumid'] : '') . '">', $category['name'], '</a> <a href="' . $scripturl . '?action=admin;area=manageboards;sa=cat;cat=' . $category['id'] . ';sub=' . $category['forumid'] . '">', $txt['catModify'], '</a>]]></add>
	</operation>
	<operation>	<!-- line 55 -->
		<search position="replace"><![CDATA[<form action="', $scripturl, '?action=admin;area=manageboards;sa=newboard;cat=', $category['id'], '" method="post" accept-charset="', $context['character_set'], '">]]></search>
		<add><![CDATA[<form action="', $scripturl, '?action=admin;area=manageboards;sa=newboard;cat=', $category['id'], ($forumid == 0 ? ';sub=' . $category['forumid'] : ''), '" method="post" accept-charset="', $context['character_set'], '">]]></add>
	</operation>
	<operation>	<!-- line 74 -->
		<search position="replace"><![CDATA[<span class="floatright">', $context['can_manage_permissions'] ? '<span class="modify_boards"><a href="' . $scripturl . '?action=admin;area=permissions;sa=index;pid=' . $board['permission_profile'] . ';' . $context['session_var'] . '=' . $context['session_id'] . '">' . $txt['mboards_permissions'] . '</a></span>' : '', '
							<span class="modify_boards"><a href="', $scripturl, '?action=admin;area=manageboards;move=', $board['id'], '">', $txt['mboards_move'], '</a></span>
							<span class="modify_boards"><a href="', $scripturl, '?action=admin;area=manageboards;sa=board;boardid=', $board['id'], '">', $txt['mboards_modify'], '</a></span></span><br style="clear: right;" />
						</li>';]]></search>
		<add><![CDATA[<span class="floatright">', $context['can_manage_permissions'] ? '<span class="modify_boards"><a href="' . $scripturl . '?action=admin;area=permissions;sa=index;pid=' . $board['permission_profile'] . ';' . $context['session_var'] . '=' . $context['session_id'] . '">' . $txt['mboards_permissions'] . '</a></span>' : '', '
							<span class="modify_boards"><a href="', $scripturl, '?action=admin;area=manageboards;move=', $board['id'], ($forumid == 0 ? ';sub=' . $category['forumid'] : ''), '">', $txt['mboards_move'], '</a></span>
							<span class="modify_boards"><a href="', $scripturl, '?action=admin;area=manageboards;sa=board;boardid=', $board['id'], ($forumid == 0 ? ';sub=' . $category['forumid'] : ''), '">', $txt['mboards_modify'], '</a></span></span><br style="clear: right;" />
						</li>';]]></add>
	</operation>
	<operation>	<!-- line 105 -->
		<search position="before"><![CDATA[</form>';
	}
	echo '
	</div>]]></search>
		<add><![CDATA[</div>';
	foreach ($flagged as $id => $flag)
	{
		if (!$flag)
			echo '
	<div id="subforum' . $id . '"' . ($context['req_forumid'] <> $id ? ' style="display: none;"' : '') . '>
		<div class="windowbg">
			<span class="topslice"><span></span></span>
			<div class="content centertext">
				', $txt['mboards_no_cats'], '
			</div>
			<span class="botslice"><span></span></span>
		</div>
	</div>';
	}
	echo ']]></add>
	</operation>

	<!-- template_modify_category function -->
	<operation>	<!-- line 113 -->
		<search position="before"><![CDATA[function template_modify_category()
{
	global $context, $settings, $options, $scripturl, $txt]]></search>
		<add><![CDATA[, $subforum_tree, $forumid]]></add>
	</operation>
	<operation>	<!-- line 117 -->
		<search position="replace"><![CDATA[// Print table header.
	echo '
	<div id="manage_boards">
		<form action="', $scripturl, '?action=admin;area=manageboards;sa=cat2" method="post" accept-charset="', $context['character_set'], '">
			<input type="hidden" name="cat" value="', $context['category']['id'], '" />]]></search>
		<add><![CDATA[// Print table header.
	echo '
	<script type="text/javascript">
		function SubForumsCategories(forum)
		{
			';
	foreach ($subforum_tree as $subforum => $info)
		echo 'document.getElementById("cat_txt' . $subforum . '").style.display = (forum == ' . $subforum . ' ? "" : "none");
			document.getElementById("cat_ord' . $subforum . '").style.display = (forum == ' . $subforum . ' ? "" : "none");
			';
	echo '
		}
	</script>
	<div id="manage_boards">
		<form action="', $scripturl, '?action=admin;area=manageboards;sa=cat2' . (!empty($_REQUEST['sub']) ? ';sub=' . $_REQUEST['sub'] : '') .'" method="post" accept-charset="', $context['character_set'], '">
			<input type="hidden" name="cat" value="', $context['category']['id'], '" />
			<input type="hidden" name="forumid" value="', $context['category']['forumid'], '" />]]></add>
	</operation>
	<operation>	<!-- line 131 -->
		<search position="replace"><![CDATA[// If this isn't the only category, let the user choose where this category should be positioned down the board index.
	if (count($context['category_order']) > 1)
	{
		echo '
						<dt><strong>', $txt['order'], ':</strong></dt>
						<dd>
							<select name="cat_order">';
		// Print every existing category into a select box.
		foreach ($context['category_order'] as $order)
			echo '
								<option', $order['selected'] ? ' selected="selected"' : '', ' value="', $order['id'], '">', $order['name'], '</option>';]]></search>
		<add><![CDATA[// If this isn't the only subforum, let the user choose which subforum it should be placed in:
	if (count($subforum_tree) > 1)
	{
		echo '
						<dt>
							<strong>' . $txt['forumid_title']. '</strong><br />
							<span class="smalltext">' . $txt['forumid_desc'] . '</span>
						</dt>
						<dd>
							<select name="forum_id" onchange="SubForumsCategories(this.options[this.selectedIndex].value); return false;">';
		// Print every existing category into a select box.
		foreach ($subforum_tree as $row)
			echo '
								<option', $context['category']['forumid'] == $row['forumid'] ? ' selected="selected"' : '', ' value="', $row['forumid'], '">', $row['boardname'], '</option>';
		echo '
							</select>
						</dd>';
	} else {
		echo '
						<input type="hidden" name="forum_id" value="', $forumid, '" size="4" tabindex="', $context['tabindex']++, '" />';
	}

	// If this isn't the only category, let the user choose where this category should be positioned down the board index.
	foreach ($subforum_tree as $id => $subforum)
	{
		echo '
						<dt id="cat_txt' . $id . '"' . ($id <> $_REQUEST['sub'] ? ' style="display: none;"' : '') . '>
							<strong>', $txt['order'], ':</strong>
						</dt>
						<dd id="cat_ord' . $id . '"' . ($id <> $_REQUEST['sub'] ? ' style="display: none;"' : '') . '>
							<select name="cat_order' . $id . '"">';

		// Print every existing category into a select box.
		foreach ($context['category_order'][$id] as $order)
			echo '
								<option', $order['selected'] ? ' selected="selected"' : '', ' value="', $order['id'], '">', $order['name'], '</option>';]]></add>
	</operation>

	<!-- template_confirm_category_delete function -->
	<operation>	<!-- line 199 -->
		<search position="replace"><![CDATA[echo '
	<div id="manage_boards">
		<form action="', $scripturl, '?action=admin;area=manageboards;sa=cat2" method="post" accept-charset="', $context['character_set'], '">]]></search>
		<add><![CDATA[echo '
	<div id="manage_boards">
		<form action="', $scripturl, '?action=admin;area=manageboards;sa=cat2' . (!empty($_REQUEST['sub']) ? ';sub=' . $_REQUEST['sub'] : '') .'" method="post" accept-charset="', $context['character_set'], '">]]></add>
	</operation>
	<operation>	<!-- line 229 -->
		<search position="replace"><![CDATA[<label for="delete_action1"><input type="radio" id="delete_action1" name="delete_action" value="1" class="input_radio"', count($context['category_order']) == 1 ? ' disabled="disabled"' : '', ' />', $txt['mboards_delete_option2'], '</label>:
						<select name="cat_to" ', count($context['category_order']) == 1 ? 'disabled="disabled"' : '', '>';

	foreach ($context['category_order'] as $cat)]]></search>
		<add><![CDATA[<label for="delete_action1"><input type="radio" id="delete_action1" name="delete_action" value="1" class="input_radio"', count($context['category_order'][$_POST['forumid']]) == 1 ? ' disabled="disabled"' : '', ' />', $txt['mboards_delete_option2'], '</label>:
						<select name="cat_to" ', count($context['category_order']) == 1 ? 'disabled="disabled"' : '', '>';

	foreach ($context['category_order'][$_POST['forumid']] as $cat)]]></add>
	</operation>

	<!-- template_modify_board function -->
	<operation>	<!-- line 253 -->
		<search position="before"><![CDATA[function template_modify_board()
{
	global $context, $settings, $options, $scripturl, $txt, $modSettings]]></search>
		<add><![CDATA[, $forumid, $subforum_tree, $boards, $cat_tree]]></add>
	</operation>
	<operation>	<!-- line 257 -->
		<search position="before"><![CDATA[// The main table header.
	echo '
	<div id="manage_boards">
		<form action="', $scripturl, '?action=admin;area=manageboards;sa=board2" method="post" accept-charset="', $context['character_set'], '">]]></search>
		<add><![CDATA[
	<script type="text/javascript">
		function hideCategories(forum)
		{';
	foreach ($subforum_tree as $subforum)
		echo '
			document.getElementById("new_cat' . $subforum['forumid'] . '").style.display = (forum == ' . $subforum['forumid'] . ' ? "" : "none");';
	echo '
			hideBoards(document.getElementById("new_cat" + forum).options[document.getElementById("new_cat" + forum).selectedIndex].value);
		}
		function hideBoards(cat)
		{
			cat = (cat == 0 ? ' . $context['board']['id'] . ' : cat);';
	foreach ($context['board_order'] as $cat => $boards2)
		echo '
			document.getElementById("cat_txt', $cat, '").style.display = (cat == ' . $cat . ' ? "" : "none");
			document.getElementById("cat_opt', $cat, '").style.display = (cat == ' . $cat . ' ? "" : "none");';
	echo '
		}
		function expandTabs(forum)
		{
			';
	foreach ($subforum_tree as $subforum => $info)
		echo 'document.getElementById("subforum' . $subforum . '").style.display = (forum == ' . $subforum . ' ? "" : "none");
			document.getElementById("tab' . $subforum . '").className = (forum == ' . $subforum . ' ? "tabActiveHeader" : "");
			';
	echo '
		}
	</script>
	<div id="manage_boards">
		<form action="', $scripturl, '?action=admin;area=manageboards;sa=board2', (!empty($_REQUEST['sub']) ? ';sub=' . $_REQUEST['sub'] : ''), '" method="post" accept-charset="', $context['character_set'], '">]]></add>
	</operation>
	<operation>	<!-- line 272 -->
		<search position="after"><![CDATA[// Option for choosing the category the board lives in.]]></search>
		<add><![CDATA[// Option for choosing the subforum the board lives in.
	$_REQUEST['sub'] = (isset($_REQUEST['sub']) ? $_REQUEST['sub'] : 0);
	if (count($subforum_tree) > 1)
	{
		echo '
						<dt>
							<strong>', $txt['forumid_title'], ':</strong>

						</dt>
						<dd>
							<select name="new_forum" onchange="hideCategories(this.options[this.selectedIndex].value);">';
		foreach ($subforum_tree as $subforum)
			echo '
								<option value="', $subforum['forumid'], '" ', $subforum['forumid'] == $_REQUEST['sub'] ? ' selected="selected"' : '', '>', $subforum['boardname'], '</option>';
		echo '
							</select>
						</dd>';
	}
	else
		echo '
						<input type="hidden" name="new_forum" value="', $_REQUEST['sub'], '" />';

	]]></add>
	</operation>
	<operation>	<!-- line 279 -->
		<search position="replace"><![CDATA[<dd>
							<select name="new_cat" onchange="if (this.form.order) {this.form.order.disabled = this.options[this.selectedIndex].value != 0; this.form.board_order.disabled = this.options[this.selectedIndex].value != 0 || this.form.order.options[this.form.order.selectedIndex].value == \'\';}">';
		foreach ($context['categories'] as $category)
			echo '
								<option', $category['selected'] ? ' selected="selected"' : '', ' value="', $category['id'], '">', $category['name'], '</option>';
		echo '
							</select>
						</dd>';]]></search>
		<add><![CDATA[<dd>';
	foreach ($subforum_tree as $subforum)
	{
		echo '
							<select name="new_cat', $subforum['forumid'], '" id="new_cat', $subforum['forumid'], '" onchange="hideBoards(this.options[this.selectedIndex].value);"', ($subforum['forumid'] <> $_REQUEST['sub'] ? ' style="display: none;"' : ''), ((isset($context['board']['is_new']) && count($context['categories'][$subforum['forumid']]) > 0) || count($context['categories'][$subforum['forumid']]) > 1 ? '' : ' disabled="disabled"'), '>';
		foreach ($context['categories'][$subforum['forumid']] as $category)
			echo '
								<option', $category['selected'] ? ' selected="selected"' : '', ' value="', $category['id'], '">', $category['name'], '</option>';
		echo '
							</select>';
		if (!((isset($context['board']['is_new']) && count($context['categories'][$subforum['forumid']]) > 0) || count($context['categories'][$subforum['forumid']]) > 1))
			echo '
							<input type="hidden" name="new_cat', $subforum['forumid'], '" value="', $context['categories'][$subforum['forumid']][0]['id'], '" />';
	}
	echo '
							<input type="hidden" name="current_cat" value="', $context['board']['category'], '" />
						</dd>';]]></add>
	</operation>
	<operation>	<!-- line 288 -->
		<search position="replace"><![CDATA[// If this isn't the only board in this category let the user choose where the board is to live.
	if ((isset($context['board']['is_new']) && count($context['board_order']) > 0) || count($context['board_order']) > 1)
	{
		echo '
						<dt>
							<strong>', $txt['order'], ':</strong>
						</dt>
						<dd>';

	// The first select box gives the user the option to position it before, after or as a child of another board.
	echo '
							<select id="order" name="placement" onchange="this.form.board_order.disabled = this.options[this.selectedIndex].value == \'\';">
								', !isset($context['board']['is_new']) ? '<option value="">(' . $txt['mboards_unchanged'] . ')</option>' : '', '
								<option value="after">' . $txt['mboards_order_after'] . '...</option>
								<option value="child">' . $txt['mboards_order_child_of'] . '...</option>
								<option value="before">' . $txt['mboards_order_before'] . '...</option>
							</select>';

	// The second select box lists all the boards in the category.
	echo '
							<select id="board_order" name="board_order" ', isset($context['board']['is_new']) ? '' : 'disabled="disabled"', '>
								', !isset($context['board']['is_new']) ? '<option value="">(' . $txt['mboards_unchanged'] . ')</option>' : '';
	foreach ($context['board_order'] as $order)
		echo '
								<option', $order['selected'] ? ' selected="selected"' : '', ' value="', $order['id'], '">', $order['name'], '</option>';
	echo '
							</select>
						</dd>';
	}]]></search>
		<add><![CDATA[// If this isn't the only board in this category let the user choose where the board is to live.
	if ((isset($context['board']['is_new']) && count($context['board_order']) > 0) || count($context['board_order']) > 1)
	{
		echo '
						<dt>
							<strong>', $txt['order'], ':</strong>
						</dt>
						<dd>';

		// The first select box gives the user the option to position it before, after or as a child of another board.
		echo '
								<select id="order" name="placement" onchange="this.form.board_order.disabled = this.options[this.selectedIndex].value == \'\';">
									', !isset($context['board']['is_new']) ? '<option value="">(' . $txt['mboards_unchanged'] . ')</option>' : '', '
									<option value="after">' . $txt['mboards_order_after'] . '...</option>
									<option value="child">' . $txt['mboards_order_child_of'] . '...</option>
									<option value="before">' . $txt['mboards_order_before'] . '...</option>
								</select>';

		// The second select box lists all the boards in the category.
		echo '
								<select id="board_order" name="board_order" ', isset($context['board']['is_new']) ? '' : 'disabled="disabled"', '>
									', !isset($context['board']['is_new']) ? '<option value="">(' . $txt['mboards_unchanged'] . ')</option>' : '';
		// If this isn't the only board in this category let the user choose where the board is to live.
		foreach ($context['board_order'] as $cat => $board_order)
		{
			if ((isset($context['board']['is_new']) && count($board_order) > 0) || count($board_order) > 1)
			{
				echo '
							<dt id="cat_txt', $cat, '"', ($cat != $context['board']['category'] ? ' style="display: none;"' : '') . '>
								<strong>', $txt['order'], ':</strong>
							</dt>
							<dd id="cat_opt', $cat, '"', ($cat != $context['board']['category'] ? ' style="display: none;"' : '') . '>';

				// The first select box gives the user the option to position it before, after or as a child of another board.
				echo '
								<select id="order', $cat, '" name="placement', $cat, '" onchange="this.form.board_order', $cat, '.disabled = this.options[this.selectedIndex].value == \'\';">
									', !isset($context['board']['is_new']) ? '<option value="">(' . $txt['mboards_unchanged'] . ')</option>' : '', '
									<option value="after">' . $txt['mboards_order_after'] . '...</option>
									<option value="child">' . $txt['mboards_order_child_of'] . '...</option>
									<option value="before">' . $txt['mboards_order_before'] . '...</option>
								</select>';

				// The second select box lists all the boards in the category.
				echo '
								<select id="board_order', $cat, '" name="board_order', $cat, '" ', isset($context['board']['is_new']) ? '' : 'disabled="disabled"', '>
									', !isset($context['board']['is_new']) ? '<option value="">(' . $txt['mboards_unchanged'] . ')</option>' : '';
				foreach ($board_order as $order)
					echo '
									<option', $order['selected'] ? ' selected="selected"' : '', ' value="', $order['id'], '">', $order['name'], '</option>';
				echo '
								</select>
							</dd>';
			}
		}]]></add>
	}]]></add>
	</operation>
	<operation>	<!-- line 318 -->
		<search position="before"><![CDATA[// Options for board name and description.
	echo ']]></search>
		<add><![CDATA[
				<div id="normal_board"', (!empty($context['board']['alias_board']) ? ' style="display: none;"' : ''), '>
					<dl class="settings">]]></add>
	</operation>
	<operation error="ignore">	<!-- line 508 with Alias Boards installed -->
		<search position="replace"><![CDATA[<div id="alias_board"', ($context['board']['alias_board'] == 0 ? ' style="display: none;"' : ''), '>
					<fieldset>
						<legend>', $txt['mboards_alias_legend'], '</legend>]]></search>
		<add><![CDATA[<div id="alias_board"', ($context['board']['alias_board'] == 0 ? ' style="display: none;"' : ''), '>';

	// Display the subforums as a tab at the top of the screen:
	$flagged = array( 0 => false );
	if (count($subforum_tree) > 1)
	{
		echo '
					<div id="tabContainer">
						<div class="tabs">
							<ul>';
		foreach ($subforum_tree as $id => $section)
		{
			echo '
								<li', ($id == $context['req_forumid'] ? ' class="tabActiveHeader"' : ''), ' id="tab' . $id . '"><a href="javascript:void(0);" onclick="expandTabs(' . $id . '); return false;">', (isset($section['boardname']) ? $section['boardname'] : '# '.$section['forumid']), '</a></li>';
			$flagged[$id] = false;
		}
		echo '
							</ul>
						</div>
					</div>';
	}

	echo '
					<fieldset>', (count($subforum_tree) == 1 ? '
						<legend>' . $txt['mboards_alias_legend'] . '</legend>' : ''), ']]></add>
	</operation>
	<operation error="ignore">	<!-- line 516 with Alias Boards installed -->
		<search position="replace"><![CDATA[$last_cat = 0;
	foreach ($boards as $id => $board)
	{
		]]></search>
		<add><![CDATA[$last_cat = 0;
	$last_forumid = -1;
	foreach ($boards as $board)
	{
		if (isset($board['forumid']) && $last_forumid <> $board['forumid'])
		{
			if ($last_forumid > -1)
				echo '</div>';
			echo '<div id="subforum' . $board['forumid'] . '"' . ($context['req_forumid'] <> (int)$board['forumid'] ? ' style="display: none;"' : '') . '>';
			$last_forumid = $board['forumid'];
			$flagged[$board['forumid']] = true;
			$last_cat = 0;
		}
		]]></add>
	</operation>
	<operation error="ignore">	<!-- line 526 with Alias Boards installed -->
		<search position="replace"><![CDATA[<input type="radio" name="alias_board" value="', $board['id'], '"', ($context['board']['alias_board'] == $board['id'] ? ' checked="checked"' : ''), '>', $board['name'], '<br />';
	}
	echo '
							</dd>]]></search>
		<add><![CDATA[<input type="radio" name="alias_board" value="', $board['id'], '"', ($context['board']['alias_board'] == $board['id'] ? ' checked="checked"' : ''), '>', $board['name'], '<br />';
	}
	echo '
							</div></dd>]]></add>
	</operation>
	<operation>	<!-- line 546 -->
		<search position="after"><![CDATA[function refreshOptions()]]></search>
		<add><![CDATA[function hideAlias()
		{
			var alias = document.getElementById("alias_enable").checked;
			document.getElementById("normal_board").style.display = (alias ? "none" : "");
			document.getElementById("alias_board").style.display = (alias ? "" : "none");
		}
		]]></add>
	</operation>
	<operation>	<!-- line 569 -->
		<search position="before"><![CDATA[refreshOptions();]]></search>
		<add><![CDATA[
		hideAlias();]]></add>
	</operation>

	<!-- template_confirm_board_delete function -->
	<operation>	<!-- line 574 -->
		<search position="replace"><![CDATA[function template_confirm_board_delete()
{
	global $context, $settings, $options, $scripturl, $txt;

	// Print table header.
	echo '
	<div id="manage_boards">
		<form action="', $scripturl, '?action=admin;area=manageboards;sa=board2" method="post" accept-charset="', $context['character_set'], '">]]></search>
		<add><![CDATA[function template_confirm_board_delete()
{
	global $context, $settings, $options, $scripturl, $txt;

	// Print table header.
	echo '
	<div id="manage_boards">
		<form action="', $scripturl, '?action=admin;area=manageboards;sa=board2' . (!empty($_REQUEST['sub']) ? ';sub=' . $_REQUEST['sub'] : '') .'" method="post" accept-charset="', $context['character_set'], '">]]></add>
	</operation>
</file>
<file name="$themedir/ManageMembergroups.template.php">
	<!-- template_new_group function -->
	<operation>	<!-- line 23 -->
		<search position="before"><![CDATA[function template_new_group()
{
	global $context, $settings, $options, $scripturl, $txt, $modSettings]]></search>
		<add><![CDATA[, $subforum_tree]]></add>
	</operation>
	<operation>	<!-- line 112 -->
		<search position="before"><![CDATA[<option value="maintenance">', $txt['permitgroups_maintenance'], '</option>
								</select>
							</fieldset>
						</dd>';
	}]]></search>
		<add><![CDATA[
	// Display the subforums as a tab at the top of the screen:
	if (!empty($context['boards']))
	{
		if (count($subforum_tree) > 1)
		{
			echo '
						<script type="text/javascript">
							function modSubforum(forum, state)
							{
								var elem = document.getElementsByClassName("subforum_" + forum);
								for (i = 0; i < elem.length; i++)
									elem[i].style.display = (state ? "" : "none");
							}
							function expandTabs(forum)
							{
								';
			foreach ($subforum_tree as $subforum => $info)
				echo 'modSubforum(', $subforum, ', forum == ', $subforum, ');
								document.getElementById("tab' . $subforum . '").className = (forum == ' . $subforum . ' ? "tabActiveHeader" : "");
								';
			echo '
							}
						</script>
					</dl>
					<div id="tabContainer">
						<div class="tabs">
							<ul>';
			foreach ($subforum_tree as $id => $section)
			{
				echo '
								<li', ($id == $context['req_forumid'] ? ' class="tabActiveHeader"' : ''), ' id="tab' . $id . '"><a href="javascript:void(0);" onclick="expandTabs(' . $id . '); return false;">', (isset($section['boardname']) ? $section['boardname'] : '# '.$section['forumid']), '</a></li>';
				$flagged[$id] = false;
			}
			echo '
							</ul>
						</div>
					</div>
					<hr class="hrcolor" />
					<dl class="settings">';
		}
	]]></add>
	</operation>
	<operation>	<!-- line 120 -->
		<search position="replace"><![CDATA[<span class="smalltext" style="font-weight: normal">' . $txt['membergroups_new_board_post_groups'] . '</span>' : '', '
						</dt>
						<dd>
							<fieldset id="visible_boards">
								<legend>', $txt['membergroups_new_board_desc'], '</legend>';
	foreach ($context['boards'] as $board)
		echo '
								<div style="margin-left: ', $board['child_level'], 'em;"><input type="checkbox" name="boardaccess[]" id="boardaccess_', $board['id'], '" value="', $board['id'], '" ', $board['selected'] ? ' checked="checked" disabled="disabled"' : '', ' class="input_check" /> <label for="boardaccess_', $board['id'], '">', $board['name'], '</label></div>';

	echo '
								<br />
								<input type="checkbox" id="checkall_check" class="input_check" onclick="invertAll(this, this.form, \'boardaccess\');" /> <label for="checkall_check"><em>', $txt['check_all'], '</em></label>
							</fieldset>
						</dd>
					</dl>]]></search>
		<add><![CDATA[<span class="smalltext">' . $txt['membergroups_new_board_post_groups'] . '</span>' : '', '
						</dt>
						<dd>
							<fieldset id="visible_boards" style="width: 95%;">
								<legend>', $txt['membergroups_new_board_desc'], '</legend>';
		foreach ($context['boards'] as $board)
			if (isset($subforum_tree[$board['forumid']]))
				echo '
								<div style="margin-left: ', $board['child_level'], 'em;" class="subforum_' . $board['forumid'] . '"><input type="checkbox" name="boardaccess[]" id="boardaccess_', $board['id'], '" value="', $board['id'], '" ', $board['selected'] ? ' checked="checked"' : '', ' class="input_check" /> <label for="boardaccess_', $board['id'], '">', $board['name'], '</label></div>';
			elseif ($board['selected'])
				echo '
								<input type="hidden" name="boardaccess[]" value="' . $board['id'] . '" />';

		echo '
							<br />
							<input type="checkbox" id="checkall_check" class="input_check" onclick="invertAll(this, this.form, \'boardaccess\');" /> <label for="checkall_check"><em>', $txt['check_all'], '</em></label>
							</fieldset>
						</dd>
					</dl>';
	}
	echo ']]></add>
	</operation>
	<operation>	<!-- line 141 -->
		<search position="after"><![CDATA[if ($context['undefined_group'])
	{
		echo '
			<script type="text/javascript">]]></search>
		<add><![CDATA[if (count($subforum_tree) > 1)
	{
		$keys = array_keys($subforum_tree);
		echo '
			<script type="text/javascript">
				expandTabs(', $keys[0], ');
			</script>';
	}
	]]></add>
	</operation>

	<!-- template_edit_group function -->
	<operation>	<!-- line 161 -->
		<search position="before"><![CDATA[function template_edit_group()
{
	global $context, $settings, $options, $scripturl, $txt]]></search>
		<add><![CDATA[, $subforum_tree]]></add>
	</operation>
	<operation>	<!-- line 298 -->
		<search position="before"><![CDATA[<input type="text" name="max_messages" id="max_messages_input" value="', $context['group']['id'] == 1 ? 0 : $context['group']['max_messages'], '" size="6"', $context['group']['id'] == 1 ? ' disabled="disabled"' : '', ' class="input_text" />
						</dd>';
	if (!empty($context['boards']))
	{]]></search>
		<add><![CDATA[
		if (count($subforum_tree) > 1)
		{
			echo '
					</dl>
					<script type="text/javascript"><!-- // -->
						function modSubforum(forum, state)
						{
							var elem = document.getElementsByClassName("subforum_" + forum);
							for (i = 0; i < elem.length; i++)
								elem[i].style.display = (state ? "" : "none");
						}
						function expandTabs(forum)
						{
							';
			foreach ($subforum_tree as $subforum => $info)
				echo 'modSubforum(', $subforum, ', forum == ', $subforum, ');
							document.getElementById("tab' . $subforum . '").className = (forum == ' . $subforum . ' ? "tabActiveHeader" : "");
							';
			echo '
						}
					</script>
					<div id="tabContainer">
						<div class="tabs">
							<ul>';
			foreach ($subforum_tree as $id => $section)
			{
				echo '
								<li', ($id == $context['req_forumid'] ? ' class="tabActiveHeader"' : ''), ' id="tab' . $id . '"><a href="javascript:void(0);" onclick="expandTabs(' . $id . '); return false;">', (isset($section['boardname']) ? $section['boardname'] : '# '.$section['forumid']), '</a></li>';
				$flagged[$id] = false;
			}
			echo '
							</ul>
						</div>
						<hr class="hrcolor" />
					</div>
					<dl class="settings">';
		}
]]></add>
	</operation>
	<operation>	<!-- line 309 -->
		<search position="replace"><![CDATA[<legend><a href="javascript:void(0);" onclick="document.getElementById(\'visible_boards\').style.display = \'none\';document.getElementById(\'visible_boards_link\').style.display = \'block\'; return false;">', $txt['membergroups_new_board_desc'], '</a></legend>';
		foreach ($context['boards'] as $board)
			echo '
								<div style="margin-left: ', $board['child_level'], 'em;"><input type="checkbox" name="boardaccess[]" id="boardaccess_', $board['id'], '" value="', $board['id'], '" ', $board['selected'] ? ' checked="checked"' : '', ' class="input_check" /> <label for="boardaccess_', $board['id'], '">', $board['name'], '</label></div>';

		echo '
								<br />
								<input type="checkbox" id="checkall_check" class="input_check" onclick="invertAll(this, this.form, \'boardaccess\');" /> <label for="checkall_check"><em>', $txt['check_all'], '</em></label>
							</fieldset>
							<a href="javascript:void(0);" onclick="document.getElementById(\'visible_boards\').style.display = \'block\'; document.getElementById(\'visible_boards_link\').style.display = \'none\'; return false;" id="visible_boards_link" style="display: none;">[ ', $txt['membergroups_select_visible_boards'], ' ]</a>
							<script type="text/javascript">]]></search>
		<add><![CDATA[<legend><a href="javascript:void(0);" onclick="document.getElementById(\'visible_boards\').style.display = \'none\';document.getElementById(\'visible_boards_link\').style.display = \'block\';' . (count($subforum_tree) > 1 ? ' document.getElementById(\'tabContainer\').style.display = \'none\';' : '') . ' return false;">', $txt['membergroups_new_board_desc'], '</a></legend>';
		foreach ($context['boards'] as $board)
			if (isset($subforum_tree[$board['forumid']]))
				echo '
								<div style="margin-left: ', $board['child_level'], 'em;" class="subforum_' . $board['forumid'] . '"><input type="checkbox" name="boardaccess[]" id="boardaccess_', $board['id'], '" value="', $board['id'], '" ', $board['selected'] ? ' checked="checked"' : '', ' class="input_check" /> <label for="boardaccess_', $board['id'], '">', $board['name'], '</label></div>';
			elseif ($board['selected'])
				echo '
								<input type="hidden" name="boardaccess[]" value="' . $board['id'] . '" />';

		echo '
								<br />
								<input type="checkbox" id="checkall_check" class="input_check" onclick="invertAll(this, this.form, \'boardaccess\');" /> <label for="checkall_check"><em>', $txt['check_all'], '</em></label>
							</fieldset>
							<a href="javascript:void(0);" onclick="document.getElementById(\'visible_boards\').style.display = \'block\'; document.getElementById(\'visible_boards_link\').style.display = \'none\'; ' . (count($subforum_tree) > 1 ? ' document.getElementById(\'tabContainer\').style.display = \'block\';' : '') . ' return false;" id="visible_boards_link" style="display: none;">[ ', $txt['membergroups_select_visible_boards'], ' ]</a>
							<script type="text/javascript">]]></add>
	</operation>
	<operation>	<!-- line 321 -->
		<search position="replace"><![CDATA[document.getElementById("visible_boards").style.display = "none";]]></search>
		<add><![CDATA[document.getElementById("visible_boards").style.display = "none";';
		if (count($subforum_tree) > 1)
		{
			$keys = array_keys($subforum_tree);
			echo '
								document.getElementById("tabContainer").style.display = "none";
								expandTabs(' . $keys[0] . ');';
		}
		echo ']]></add>
	</operation>
</file>
<file name="$themedir/ManagePermissions.template.php">
	<!-- template_by_board function -->
	<operation>	<!-- line 260 -->
		<search position="before"><![CDATA[function template_by_board()
{
	global $context, $settings, $options, $scripturl, $txt, $modSettings]]></search>
		<add><![CDATA[, $forumid, $subforum_tree]]></add>
	</operation>
	<operation>	<!-- line 285 -->
		<search position="replace"><![CDATA[foreach ($context['categories'] as $category)
	{
		echo '
		<div class="cat_bar">
			<h3 class="catbg"><strong>', $category['name'], '</strong></h3>
		</div>';

		if (!empty($category['boards']))
			echo '
		<div class="windowbg">
			<span class="topslice"><span></span></span>
			<div class="content">
				<ul class="perm_boards flow_hidden">';

		$alternate = false;

		foreach ($category['boards'] as $board)
		{
			$alternate = !$alternate;

			echo '

					<li class="flow_hidden' ,' windowbg', $alternate ? '' : '2','">
						<span class="perm_board floatleft">
							<a href="', $scripturl, '?action=admin;area=manageboards;sa=board;boardid=', $board['id'], ';rid=permissions;', $context['session_var'], '=', $context['session_id'], '">', str_repeat('-', $board['child_level']), ' ', $board['name'], '</a>
						</span>
						<span class="perm_boardprofile floatleft">';
			if ($context['edit_all'])
			{
				echo '
							<select name="boardprofile[', $board['id'], ']">';

				foreach ($context['profiles'] as $id => $profile)
					echo '
								<option value="', $id, '" ', $id == $board['profile'] ? 'selected="selected"' : '', '>', $profile['name'], '</option>';

				echo '
							</select>';
			}
			else
				echo '
							<a href="', $scripturl, '?action=admin;area=permissions;sa=index;pid=', $board['profile'], ';', $context['session_var'], '=', $context['session_id'], '"> [', $board['profile_name'], ']</a>';

			echo '
						</span>
					</li>';
		}

		if (!empty($category['boards']))
			echo '
				</ul>
			</div>
			<span class="botslice"><span></span></span>
		</div>';
	}]]></search>
	<add><![CDATA[// Display the subforums as a tab at the top of the screen:
	$flagged = array( 0 => false );
	if (count($subforum_tree) > 1)
	{
		echo '
		<script type="text/javascript">
			function expandTabs(forum)
			{
			';
	foreach ($subforum_tree as $subforum => $info)
		echo 'document.getElementById("subforum' . $subforum . '").style.display = (forum == ' . $subforum . ' ? "" : "none");
				document.getElementById("tab' . $subforum . '").className = (forum == ' . $subforum . ' ? "tabActiveHeader" : "");
				';
	echo '
			}
		</script>
		<div id="tabContainer">
			<div class="tabs">
				<ul>';
		foreach ($subforum_tree as $id => $section)
		{
			echo '
					<li', ($id == $context['req_forumid'] ? ' class="tabActiveHeader"' : ''), ' id="tab' . $id . '"><a href="javascript:void(0);" onclick="expandTabs(' . $id . '); return false;">', (isset($section['boardname']) ? $section['boardname'] : '# '.$section['forumid']), '</a></li>';
			$flagged[$id] = false;
		}
		echo '
				</ul>
			</div>
		</div>
		<hr class="clear" />';
	}
	foreach ($context['categories'] as $id => $subforum)
	{
		echo '
		<div id="subforum' . $id . '"' . (!empty($id) ? ' style="display: none;"' : '') . '>';

		foreach ($subforum as $category)
		{
			echo '
			<div class="cat_bar">
				<h3 class="catbg"><strong>', $category['name'], '</strong></h3>
			</div>';

			if (!empty($category['boards']))
				echo '
			<div class="windowbg">
				<span class="topslice"><span></span></span>
				<div class="content">
					<ul class="perm_boards flow_hidden">';

			$alternate = false;

			foreach ($category['boards'] as $board)
			{
				$alternate = !$alternate;

				echo '

						<li class="flow_hidden' ,' windowbg', $alternate ? '' : '2','">
							<span class="perm_board floatleft">
								<a href="', $scripturl, '?action=admin;area=manageboards;sa=board;boardid=', $board['id'], ';rid=permissions;', $context['session_var'], '=', $context['session_id'], '">', str_repeat('-', $board['child_level']), ' ', $board['name'], '</a>
							</span>
							<span class="perm_boardprofile floatleft">';
				if ($context['edit_all'])
				{
					echo '
								<select name="boardprofile[', $board['id'], ']">';

					foreach ($context['profiles'] as $id => $profile)
						echo '
									<option value="', $id, '" ', $id == $board['profile'] ? 'selected="selected"' : '', '>', $profile['name'], '</option>';

					echo '
								</select>';
				}
				else
					echo '
								<a href="', $scripturl, '?action=admin;area=permissions;sa=index;pid=', $board['profile'], ';', $context['session_var'], '=', $context['session_id'], '"> [', $board['profile_name'], ']</a>';

				echo '
							</span>
						</li>';
			}

			if (!empty($category['boards']))
				echo '
					</ul>
				</div>
				<span class="botslice"><span></span></span>
			</div>';
		}
		$flagged[$id] = true;
		echo '
		</div>';
	}
	foreach ($flagged as $id => $flag)
	{
		if (!$flag)
			echo '
	<div id="subforum' . $id . '"' . ($context['req_forumid'] <> $id ? ' style="display: none;"' : '') . '>
	</div>';
	}]]></add>
	</operation>
</file>
</modification>